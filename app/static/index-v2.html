<!DOCTYPE html>
<!--
  Inteligentný FTE Manažment v5.1
  Dr.Max Pharmacy Staffing Tool
-->
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inteligentný FTE Manažment | Dr.Max</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,500;6..12,600;6..12,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* ============================================
   DR.MAX FTE CALCULATOR - CORPORATE STYLING
   ============================================ */

:root {
  --brand-green: #78be20;
  --brand-green-dark: #6aab1a;
  --btn-green: #8ed12e;
  --btn-green-dark: #78be20;
  --brand-green-light: rgba(120, 190, 32, 0.1);
  --brand-green-glow: rgba(120, 190, 32, 0.25);
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --text-muted: #6b7280;
  --bg-page: #f8faf6;
  --bg-card: #ffffff;
  --bg-subtle: #f4f7f2;
  --border-light: #e5e7eb;
  --border-medium: #d1d5db;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
  --shadow-brand: 0 4px 14px rgba(120, 190, 32, 0.3);
  --transition-fast: 0.15s ease;
  --transition-smooth: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --accent-warm: #f59e0b;
  --accent-warm-light: rgba(245, 158, 11, 0.1);
}

/* Page load animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes resultPop {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  70% {
    transform: scale(1.05);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-in {
  animation: fadeInUp 0.5s ease-out forwards;
  opacity: 0;
}

.animate-in:nth-child(1) { animation-delay: 0ms; }
.animate-in:nth-child(2) { animation-delay: 80ms; }
.animate-in:nth-child(3) { animation-delay: 160ms; }
.animate-in:nth-child(4) { animation-delay: 240ms; }
.animate-in:nth-child(5) { animation-delay: 320ms; }

* {
  box-sizing: border-box;
}

body {
  font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-page);
  margin: 0;
  padding: 20px 16px 120px; /* Increased bottom padding for mobile safe area */
  color: var(--text-primary);
  line-height: 1.5;
}

.container {
  max-width: 680px;
  margin: 0 auto;
  padding: 0 24px;
}

/* ============================================
   INTRO/WELCOME PAGE - Two Phase Drama
   ============================================ */
.intro-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #f8faf6 0%, #e8f5e0 50%, #f0f7eb 100%);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.intro-overlay.hidden {
  opacity: 0;
  transform: scale(1.02);
  pointer-events: none;
}

.intro-content {
  max-width: 480px;
  text-align: center;
  position: relative;
}

/* PHASE 1: The Dramatic Question */
.intro-question {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: questionPhase 4.5s ease-out forwards;
}

.intro-question-text {
  font-size: 1.6rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.4;
  letter-spacing: -0.01em;
  margin: 0;
  animation: fadeInUp 0.8s ease-out backwards;
}

@keyframes questionPhase {
  0%, 75% { opacity: 1; transform: scale(1); }
  90% { opacity: 0; transform: scale(0.98); }
  100% { opacity: 0; transform: scale(0.98); pointer-events: none; }
}

/* PHASE 2: The Solution */
.intro-solution {
  opacity: 0;
  animation: solutionReveal 0.8s ease-out 3.8s forwards;
}

@keyframes solutionReveal {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

.intro-headline {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.25;
  margin: 0 0 32px;
  letter-spacing: -0.02em;
  opacity: 0;
  animation: fadeInUp 0.5s ease-out 3.9s forwards;
}

.intro-headline strong {
  color: var(--brand-green-dark);
}

.intro-features {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 36px;
  text-align: left;
}

.intro-feature {
  display: flex;
  align-items: center;
  gap: 14px;
  font-size: 0.95rem;
  color: var(--text-secondary);
  opacity: 0;
}

.intro-feature:nth-child(1) { animation: fadeInUp 0.4s ease-out 4.1s forwards; }
.intro-feature:nth-child(2) { animation: fadeInUp 0.4s ease-out 4.25s forwards; }
.intro-feature:nth-child(3) { animation: fadeInUp 0.4s ease-out 4.4s forwards; }

.intro-feature-icon {
  width: 40px;
  height: 40px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.intro-feature-icon svg {
  width: 20px;
  height: 20px;
  color: var(--brand-green);
}

.intro-cta {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  padding: 14px 32px;
  border-radius: 28px;
  font-size: 1rem;
  font-weight: 700;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(120, 190, 32, 0.35);
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  opacity: 0;
  animation: fadeInUp 0.5s ease-out 4.6s forwards;
}

.intro-cta:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 6px 28px rgba(120, 190, 32, 0.45);
}

.intro-cta svg {
  width: 18px;
  height: 18px;
  transition: transform 0.2s ease;
}

.intro-cta:hover svg {
  transform: translateX(3px);
}

.intro-footer {
  margin-top: 32px;
  font-size: 0.75rem;
  color: var(--text-muted);
  opacity: 0;
  animation: fadeInUp 0.4s ease-out 4.8s forwards;
}

.intro-skip {
  position: absolute;
  top: 20px;
  right: 20px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: transparent;
  border: 1px solid var(--border-medium);
  border-radius: 6px;
  font-size: 0.8rem;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
  opacity: 0;
  animation: fadeInUp 0.4s ease 1s forwards;
}

.intro-skip:hover {
  background: var(--bg-subtle);
  color: var(--text-secondary);
  border-color: var(--border-light);
}

/* ============================================
   HEADER
   ============================================ */
.header {
  text-align: center;
  margin-bottom: 28px;
  padding-top: 8px;
  position: relative;
}

.header::before {
  content: '';
  display: block;
  width: 60px;
  height: 4px;
  background: linear-gradient(90deg, var(--brand-green), var(--brand-green-dark));
  border-radius: 2px;
  margin: 0 auto 20px;
}

h1 {
  font-size: 1.6rem;
  font-weight: 700;
  margin: 0 0 8px;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.header-logo {
  height: 32px;
  width: auto;
  vertical-align: middle;
}

.subtitle {
  color: var(--text-muted);
  font-size: 0.95rem;
  margin: 0;
  font-weight: 400;
}

.data-period-note {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin: 6px 0 0 0;
  font-weight: 400;
}

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--bg-card);
  border-radius: 14px;
  padding: 24px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
  margin-bottom: 16px;
  transition: box-shadow var(--transition-smooth), transform var(--transition-smooth);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-title {
  text-transform: uppercase;
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  font-weight: 700;
  letter-spacing: 0.08em;
  display: flex;
  align-items: center;
  gap: 8px;
}


/* ============================================
   FORM ELEMENTS
   ============================================ */
label {
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 6px;
  display: block;
  color: var(--text-secondary);
}

input, select {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid var(--border-medium);
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-primary);
  background: var(--bg-card);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

input:hover, select:hover {
  border-color: #9ca3af;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px var(--brand-green-light), inset 0 1px 2px rgba(0,0,0,0.04);
}

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}

.form-row {
  display: flex;
  gap: 16px;
  margin-top: 20px;
}

.form-row > div {
  flex: 1;
}

.form-row-3 {
  gap: 12px;
}

.calculated-row {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px dashed var(--border-light);
}

.basket-readonly {
  background: var(--bg-subtle);
  color: var(--brand-green);
  cursor: default;
}

/* Tooltip styles */
.tooltip-wrapper {
  position: relative;
}

.tooltip-wrapper .tooltip-text {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
  z-index: 100;
  transition: opacity 0.2s, visibility 0.2s;
  box-shadow: var(--shadow-md);
}

.tooltip-wrapper .tooltip-text::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--text-primary);
}

.tooltip-wrapper:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

.form-group {
  margin-top: 20px;
}

/* ============================================
   SLIDER (Range Input)
   ============================================ */
.slider-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  flex: 1;
  height: 8px;
  background: linear-gradient(to right, var(--brand-green) 0%, var(--brand-green) var(--slider-progress, 50%), var(--border-light) var(--slider-progress, 50%), var(--border-light) 100%);
  border-radius: 4px;
  border: none;
  padding: 0;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background var(--transition-fast);
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 22px;
  height: 22px;
  background: var(--bg-card);
  border: 3px solid var(--brand-green);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 3px 10px rgba(120, 190, 32, 0.3);
}

input[type="range"]::-moz-range-thumb {
  width: 22px;
  height: 22px;
  background: var(--bg-card);
  border: 3px solid var(--brand-green);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.slider-value {
  width: 65px;
  text-align: center;
  font-weight: 700;
  color: var(--brand-green);
  padding: 8px 10px;
  font-size: 0.95rem;
}

.slider-unit {
  color: var(--brand-green);
  font-weight: 600;
  font-size: 0.95rem;
}

/* ============================================
   PRODUCTIVITY TOGGLE
   ============================================ */
.productivity-group {
  margin-top: 16px;
}

.productivity-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toggle-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  transition: color var(--transition-fast);
}

.toggle-label-high {
  color: var(--text-muted);
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border-light);
  transition: var(--transition-fast);
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: var(--transition-fast);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input:checked + .toggle-slider {
  background-color: var(--brand-green);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

/* Compact productivity toggle for inline use */
.productivity-toggle-compact {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 8px;
}

.toggle-switch-sm {
  position: relative;
  width: 36px;
  height: 20px;
  flex-shrink: 0;
}

.toggle-switch-sm input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider-sm {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border-light);
  transition: var(--transition-fast);
  border-radius: 20px;
}

.toggle-slider-sm:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: var(--transition-fast);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch-sm input:checked + .toggle-slider-sm {
  background-color: var(--brand-green);
}

.toggle-switch-sm input:checked + .toggle-slider-sm:before {
  transform: translateX(16px);
}

.toggle-label-sm {
  font-size: 0.85rem;
  color: var(--text-muted);
  transition: color var(--transition-fast);
}


.prod-info-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--border-light);
  color: var(--text-muted);
  font-size: 10px;
  cursor: help;
  margin-left: 4px;
  vertical-align: middle;
}

/* ============================================
   SEGMENTED CONTROL (Produktivita)
   ============================================ */
.segmented-control {
  display: flex;
  background: var(--bg-subtle);
  border-radius: 10px;
  padding: 4px;
  gap: 4px;
}

.segment-option {
  flex: 1;
  position: relative;
}

.segment-option input {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.segment-option label {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0;
  text-align: center;
}

.segment-option input:checked + label {
  background: var(--bg-card);
  color: var(--text-primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.segment-option.high-productivity input:checked + label {
  background: var(--brand-green);
  color: white;
}

/* ============================================
   INPUT WITH SUFFIX (Rx %)
   ============================================ */
.input-with-suffix {
  position: relative;
  display: flex;
  align-items: center;
}

.input-with-suffix input {
  padding-right: 36px;
}

.input-suffix {
  position: absolute;
  right: 14px;
  color: var(--text-muted);
  font-weight: 600;
  font-size: 0.9rem;
  pointer-events: none;
}

/* ============================================
   TOOLTIP ON HOVER ONLY
   ============================================ */
.tooltip-wrapper {
  position: relative;
}

.tooltip-wrapper .tooltip-text {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.7rem;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  z-index: 100;
  pointer-events: none;
}

.tooltip-wrapper .tooltip-text::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--text-primary);
}

.tooltip-wrapper:hover .tooltip-text {
  opacity: 1;
  visibility: visible;
}

/* ============================================
   CALCULATE BUTTON
   ============================================ */
.btn {
  width: 100%;
  background: white;
  color: var(--brand-green);
  padding: 18px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 1.1rem;
  border: 2px solid var(--brand-green);
  cursor: pointer;
  margin: 0 0 16px 0;
  font-family: inherit;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.btn:hover {
  background: var(--brand-green);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 14px rgba(120, 190, 32, 0.35);
}

.btn:hover::before {
  opacity: 1;
}

.btn:active {
  transform: translateY(0) scale(0.98);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn.loading {
  pointer-events: none;
  color: transparent;
}

.btn.loading::after {
  content: '';
  position: absolute;
  width: 24px;
  height: 24px;
  top: 50%;
  left: 50%;
  margin: -12px 0 0 -12px;
  border: 3px solid rgba(120, 190, 32, 0.3);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ============================================
   RESULTS SECTION
   ============================================ */
#result {
  margin-top: 0;
  transition: opacity 0.2s ease;
}

.result-divider {
  display: none;
}

/* Main Result Card */
.result-main {
  text-align: center;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  padding: 36px 24px;
  border-radius: 16px;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px var(--brand-green-glow);
  animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  position: relative;
  overflow: hidden;
}

.result-main::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.val-row {
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 12px;
}

.result-main .val {
  font-size: 4.5rem;
  font-weight: 700;
  line-height: 1;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.result-main .val .decimal {
  font-size: 55%;
  opacity: 0.9;
}

.val-vs {
  display: flex;
  align-items: baseline;
  gap: 12px;
}

.val-vs .val {
  color: rgba(0,0,0,0.5);
  text-shadow: none;
}

.val-vs-text {
  font-size: 1.5rem;
  font-weight: 400;
  opacity: 0.7;
}

.result-main .label {
  font-size: 1rem;
  margin-top: 8px;
  opacity: 0.95;
  font-weight: 500;
}

.result-main .range {
  margin-top: 14px;
  font-size: 0.9rem;
  opacity: 0.85;
  background: rgba(255,255,255,0.15);
  display: inline-block;
  padding: 6px 16px;
  border-radius: 20px;
}

/* Distribution Comparison */
.distribution-box {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 1px solid var(--border-light);
  animation: fadeUp 0.5s ease-out 0.15s backwards;
}

.dist-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.dist-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  font-weight: 600;
}


.dist-bar-container {
  position: relative;
  height: 8px;
  margin-bottom: 8px;
}

.dist-bar-bg {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
}

.dist-bar-range {
  position: absolute;
  top: 0;
  height: 8px;
  background: linear-gradient(90deg, var(--brand-green-light), var(--brand-green));
  border-radius: 4px;
  opacity: 0.6;
}

.dist-marker {
  position: absolute;
  top: -4px;
  width: 16px;
  height: 16px;
  background: var(--brand-green);
  border: 3px solid white;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transform: translateX(-50%);
  z-index: 2;
  cursor: pointer;
}

.dist-marker::after {
  content: attr(data-fte);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
  margin-bottom: 6px;
}

.dist-marker:hover::after {
  opacity: 1;
}

.dist-marker-actual {
  position: absolute;
  top: -2px;
  width: 12px;
  height: 12px;
  background: white;
  border: 2px solid var(--brand-green);
  border-radius: 50%;
  transform: translateX(-50%);
  z-index: 1;
  opacity: 0.5;
}

.dist-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
}

/* Breakdown Cards */
.breakdown {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  text-align: center;
  margin-bottom: 20px;
}
.breakdown.has-zastup {
  grid-template-columns: repeat(4, 1fr);
}

.breakdown-item {
  background: var(--bg-card);
  padding: 18px 12px;
  border-radius: 12px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  animation: fadeUp 0.5s ease-out backwards;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.breakdown-item:nth-child(1) { animation-delay: 0.1s; }
.breakdown-item:nth-child(2) { animation-delay: 0.2s; }
.breakdown-item:nth-child(3) { animation-delay: 0.3s; }
.breakdown-item:nth-child(4) { animation-delay: 0.4s; }

/* Zastup item - dark blue theme */
.breakdown-zastup {
  border-color: rgba(30, 64, 175, 0.3);
  background: linear-gradient(135deg, rgba(30, 64, 175, 0.05) 0%, var(--bg-card) 100%);
}
.breakdown-zastup .breakdown-val {
  color: #1e40af;
}
.breakdown-zastup .breakdown-lbl {
  color: #1e3a8a;
}

.breakdown-item:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}

.breakdown-item:hover .breakdown-pct {
  opacity: 1;
  transform: translateY(0);
}

.breakdown-val {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--brand-green);
}

.breakdown-lbl {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

.breakdown-pct {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 4px;
  opacity: 0;
  transform: translateY(4px);
  transition: opacity 0.2s, transform 0.2s;
}

/* Trust Box */
.trust-box {
  background: var(--bg-subtle);
  border-left: 4px solid var(--brand-green);
  padding: 18px;
  border-radius: 8px;
  margin-bottom: 16px;
  animation: fadeUp 0.5s ease-out 0.4s backwards;
}

.trust-title {
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text-primary);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.trust-title::before {
  content: '✓';
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  color: white;
  border-radius: 50%;
  font-size: 0.65rem;
  font-weight: 700;
}

.trust-content {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 6px;
}

.trust-link {
  color: var(--brand-green);
  cursor: pointer;
  font-weight: 600;
  transition: color var(--transition-fast);
}

.trust-link:hover {
  color: var(--brand-green-dark);
  text-decoration: underline;
}

/* Next Action - Gentle ending prompt */
.next-action {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px dashed var(--border-light);
  text-align: center;
  font-size: 0.85rem;
  color: var(--text-muted);
  animation: fadeUp 0.5s ease-out 0.6s backwards;
}

.next-action a {
  color: var(--brand-green);
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  margin-left: 4px;
  transition: color 0.2s ease;
}

.next-action a:hover {
  color: var(--brand-green-dark);
  text-decoration: underline;
}

/* Staggered result reveals */
.result-stagger-1 { animation: fadeUp 0.4s ease-out backwards; }
.result-stagger-2 { animation: fadeUp 0.4s ease-out 0.15s backwards; }
.result-stagger-3 { animation: fadeUp 0.4s ease-out 0.3s backwards; }
.result-stagger-4 { animation: fadeUp 0.4s ease-out 0.45s backwards; }
.result-stagger-5 { animation: fadeUp 0.4s ease-out 0.6s backwards; }

/* AI Tab pulse animation */
.tab-btn.agent-tab.pulse-hint {
  animation: tabPulse 2s ease-in-out 3;
}

@keyframes tabPulse {
  0%, 100% { box-shadow: 0 0 0 0 var(--brand-green-light); }
  50% { box-shadow: 0 0 0 8px rgba(120, 190, 32, 0.15); }
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 400px) {
  .result-main .val {
    font-size: 3.5rem;
  }
  
  .breakdown {
    gap: 10px;
  }
  
  .breakdown-item {
    padding: 14px 8px;
  }

  .breakdown-val {
    font-size: 1.3rem;
  }
}

/* ============================================
   TAB NAVIGATION - Icon Based
   ============================================ */
.tab-nav {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  background: var(--bg-card);
  padding: 10px 16px;
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
  justify-content: center;
}

.tab-btn {
  width: 52px;
  height: 52px;
  padding: 0;
  border: none;
  background: transparent;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-icon {
  width: 22px;
  height: 22px;
  color: var(--text-secondary);
  opacity: 0.6;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  stroke-linecap: round;
  stroke-linejoin: round;
}

.tab-btn:hover {
  background: var(--bg-subtle);
}

.tab-btn:hover .tab-icon {
  opacity: 1;
  color: var(--text-primary);
  transform: scale(1.08);
}

.tab-btn.active {
  background: var(--brand-green);
  box-shadow:
    var(--shadow-brand),
    0 0 0 3px rgba(120, 190, 32, 0.15),
    inset 0 1px 0 rgba(255,255,255,0.2);
}

.tab-btn.active .tab-icon {
  color: white;
  opacity: 1;
  transform: scale(1.18);
  animation: iconPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
}

@keyframes iconPop {
  0% { transform: scale(0.6); opacity: 0.3; }
  40% { transform: scale(1.3); }
  70% { transform: scale(1.1); }
  100% { transform: scale(1.18); opacity: 1; }
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeUp 0.3s ease-out;
}

/* Ensure animated elements stay visible after tab switch */
.tab-content.active .animate-in {
  opacity: 1;
}

/* Agent tab button styling - subtle highlight */
.tab-btn.agent-tab {
  background: var(--brand-green-light);
}

.tab-btn.agent-tab .tab-icon {
  color: var(--brand-green-dark);
  opacity: 0.9;
}

.tab-btn.agent-tab:hover {
  background: rgba(120, 190, 32, 0.2);
}

.tab-btn.agent-tab.active {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
}

.tab-btn.agent-tab.active .tab-icon {
  color: white;
}

/* ============================================
   ROZVRH TAB - Schedule Teaser (Kahneman)
   ============================================ */

/* Hero Opportunity Section - THE ANCHOR */
.schedule-hero-loss {
  background: linear-gradient(135deg, rgba(120, 190, 32, 0.08) 0%, rgba(106, 171, 26, 0.15) 100%);
  border: 2px solid rgba(120, 190, 32, 0.3);
  border-radius: 20px;
  padding: 32px 24px 28px;
  text-align: center;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  animation: scheduleHeroReveal 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes scheduleHeroReveal {
  from { opacity: 0; transform: translateY(30px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.schedule-hero-pulse {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 120%;
  height: 120%;
  transform: translate(-50%, -50%);
  background: radial-gradient(circle, rgba(120, 190, 32, 0.1) 0%, transparent 70%);
  animation: heroPulseGlow 3s ease-in-out infinite;
  pointer-events: none;
}

@keyframes heroPulseGlow {
  0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
}

.schedule-hero-label {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--brand-green-dark);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  animation: scheduleLabelFade 0.5s ease-out 0.3s backwards;
}

@keyframes scheduleLabelFade {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.schedule-hero-dot {
  width: 10px;
  height: 10px;
  background: var(--brand-green);
  border-radius: 50%;
  animation: alertDotPulse 1.5s ease-in-out infinite;
}

@keyframes alertDotPulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(120, 190, 32, 0.6); }
  50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(120, 190, 32, 0); }
}

.schedule-hero-value {
  font-size: 3.5rem;
  font-weight: 800;
  color: var(--brand-green-dark);
  line-height: 1;
  letter-spacing: -0.02em;
  text-shadow: 0 4px 20px rgba(120, 190, 32, 0.25);
  font-variant-numeric: tabular-nums;
  animation: scheduleValueDrop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s backwards;
}

@keyframes scheduleValueDrop {
  0% { opacity: 0; transform: translateY(-20px) scale(0.85); }
  60% { transform: translateY(5px) scale(1.03); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.schedule-hero-subtext {
  font-size: 0.9rem;
  color: var(--brand-green-dark);
  margin-top: 8px;
  font-weight: 500;
  opacity: 0.85;
  animation: scheduleFadeUp 0.4s ease-out 0.8s backwards;
}

@keyframes scheduleFadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 0.85; transform: translateY(0); }
}

.schedule-hero-detail {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid rgba(120, 190, 32, 0.2);
  animation: scheduleFadeUp 0.4s ease-out 1s backwards;
}

.schedule-detail-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.schedule-detail-num {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--brand-green-dark);
}

.schedule-detail-label {
  font-size: 0.7rem;
  color: var(--brand-green-dark);
  opacity: 0.7;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.schedule-detail-divider {
  width: 1px;
  height: 36px;
  background: rgba(120, 190, 32, 0.3);
}

/* Heatmap Card */
.schedule-heatmap-card {
  animation: fadeUp 0.5s ease-out 0.2s backwards;
}

.schedule-heatmap-card .card-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.title-icon {
  font-size: 1rem;
}

.title-unit {
  font-size: 0.65rem;
  color: var(--text-muted);
  font-weight: 400;
  margin-left: auto;
}

.title-badge {
  font-size: 0.65rem;
  background: var(--bg-subtle);
  color: var(--text-secondary);
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 500;
  margin-left: auto;
}

/* Heatmap Grid */
.schedule-heatmap-container {
  overflow-x: auto;
  margin: 16px 0;
}

.schedule-heatmap {
  display: grid;
  grid-template-columns: 40px repeat(12, 1fr);
  gap: 3px;
  font-size: 0.75rem;
  min-width: 500px;
}

.schedule-heatmap-corner {
  /* Empty corner cell */
}

.schedule-heatmap-hour {
  font-weight: 600;
  color: var(--text-secondary);
  text-align: center;
  padding: 6px 2px;
  font-size: 0.7rem;
}

.schedule-heatmap-day {
  font-weight: 600;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  padding-right: 6px;
  font-size: 0.75rem;
}

.schedule-heatmap-cell {
  border-radius: 5px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 42px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  padding: 3px;
  position: relative;
}

.schedule-heatmap-cell:hover {
  transform: scale(1.12);
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  z-index: 10;
}

.schedule-heatmap-cell .cell-value {
  font-size: 0.85rem;
  font-weight: 700;
  line-height: 1;
}

.schedule-heatmap-cell .cell-staff {
  font-size: 0.55rem;
  opacity: 0.75;
  margin-top: 1px;
}

/* Heatmap color scale - opportunity green palette */
.schedule-heatmap-cell.loss-0 {
  background: var(--surface-elevated);
}
.schedule-heatmap-cell.loss-active {
  background: rgba(120, 190, 32, 0.18);
}

/* Hide values by default, show on hover */
.schedule-heatmap-cell .cell-value {
  opacity: 0;
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--brand-green-dark);
  transition: opacity 0.15s ease;
}
.schedule-heatmap-cell:hover .cell-value {
  opacity: 1;
}

/* TEASER SECTION - Blurred Chart Style */
.schedule-teaser-card {
  margin-top: 20px;
  padding: 0;
  overflow: hidden;
}

.schedule-teaser-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-light);
}

.schedule-teaser-title {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--text-primary);
}

.schedule-teaser-badge {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
  padding: 5px 10px;
  border-radius: 6px;
}

/* Chart wrapper with blur */
.schedule-teaser-chart-wrap {
  position: relative;
  min-height: 240px;
}

.schedule-teaser-chart {
  padding: 16px;
  filter: blur(4px);
  opacity: 0.6;
  pointer-events: none;
  user-select: none;
}

/* Chart grid */
.teaser-chart-row {
  display: grid;
  grid-template-columns: 32px repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 6px;
}

.teaser-chart-row.teaser-chart-header {
  margin-bottom: 10px;
}

.teaser-chart-label {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
}

.teaser-chart-header .teaser-chart-cell {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-align: center;
  padding: 4px 0;
}

.teaser-chart-cell {
  background: var(--bg-subtle);
  border-radius: 4px;
  height: 24px;
  display: flex;
  align-items: center;
  padding: 3px;
}

.teaser-chart-header .teaser-chart-cell {
  background: transparent;
  height: auto;
}

/* Bars */
.teaser-bar {
  height: 100%;
  border-radius: 3px;
  background: var(--brand-green);
  transition: width 0.3s ease;
}

.teaser-bar.warn {
  background: #dc2626;
}

.teaser-bar.critical {
  background: #dc2626;
}

/* Overlay */
.schedule-teaser-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(1px);
}

.schedule-teaser-cta {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(120, 190, 32, 0.3);
}

.schedule-teaser-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(120, 190, 32, 0.4);
}

.schedule-teaser-cta svg {
  flex-shrink: 0;
}

.schedule-teaser-hint {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.teaser-lock-icon {
  font-size: 2rem;
  opacity: 0.9;
  margin-bottom: 4px;
}

/* Mobile Responsive */
@media (max-width: 600px) {
  .schedule-hero-value {
    font-size: 2.5rem;
  }

  .schedule-hero-detail {
    flex-direction: column;
    gap: 12px;
  }

  .schedule-detail-divider {
    width: 60px;
    height: 1px;
  }
}

/* Touch devices - show heatmap values by default (no hover) */
@media (hover: none) {
  .schedule-heatmap-cell .cell-value {
    opacity: 1;
  }
}

/* ============================================
   AI AGENT TAB - Clean & Simple Design
   ============================================ */
.agent-container {
  padding: 16px 0;
}

/* Search bar style input */
.agent-search-bar {
  display: flex;
  align-items: center;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 16px;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
}

.agent-search-bar:focus-within {
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px var(--brand-green-light), 0 4px 12px rgba(120, 190, 32, 0.15);
  transform: translateY(-1px);
}

.agent-search-bar input {
  flex: 1;
  padding: 12px 14px;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 0.95rem;
  color: var(--text-primary);
}

.agent-search-bar input:focus {
  outline: none;
}

.agent-search-bar input::placeholder {
  color: var(--text-muted);
  transition: color 0.2s ease;
}

.agent-search-bar:focus-within input::placeholder {
  color: var(--text-secondary);
}

.agent-search-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  background: var(--brand-green);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.agent-search-btn:hover {
  background: var(--brand-green-dark);
  transform: scale(1.05);
}

.agent-search-btn:active {
  transform: scale(0.95);
}

.agent-search-btn svg {
  transition: transform 0.2s ease;
}

.agent-search-btn:hover svg {
  transform: translateX(2px);
}

.agent-search-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.agent-results {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 24px;
  min-height: 300px;
}

/* Tools Showcase - Welcome State */
.agent-welcome {
  padding: 20px 0;
}

.agent-welcome-header {
  text-align: center;
  margin-bottom: 24px;
}

.agent-welcome-header h3 {
  color: var(--text-primary);
  margin: 0 0 8px 0;
  font-size: 1.2rem;
}

.agent-welcome-header p {
  color: var(--text-secondary);
  margin: 0;
  font-size: 0.9rem;
}

/* Tools Grid */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

/* ML & AI Intro Panel - Unified with Question Sections */
.intro-panel {
  margin-bottom: 20px;
  overflow: hidden;
  opacity: 0;
  animation: panelReveal 0.6s ease-out forwards;
}

@keyframes panelReveal {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.intro-panel-toggle {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 0 8px 0;
  margin-bottom: 12px;
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer;
  text-align: left;
}

.intro-panel-toggle:hover .intro-panel-title {
  color: var(--brand-green);
}

.intro-panel-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.intro-panel-icon {
  font-size: 1.1rem;
  color: var(--brand-green);
  display: flex;
  align-items: center;
}

.intro-panel-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.95rem;
  margin: 0;
  transition: color 0.2s ease;
}

.intro-panel-chevron {
  width: 18px;
  height: 18px;
  color: var(--text-muted);
  transition: transform 0.3s ease, color 0.2s ease;
}

.intro-panel-toggle:hover .intro-panel-chevron {
  color: var(--brand-green);
}

.intro-panel.expanded .intro-panel-chevron {
  transform: rotate(180deg);
}

.intro-panel-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.intro-panel.expanded .intro-panel-content {
  max-height: 400px;
}

.intro-panel-story {
  padding: 0 0 16px 0;
  color: var(--text-secondary);
  font-size: 0.875rem;
  line-height: 1.6;
}

.intro-panel-story p {
  margin: 0 0 12px 0;
}

.intro-panel-story p:last-child {
  margin-bottom: 0;
}

.intro-panel-highlight {
  background: var(--brand-green-light);
  border-radius: 8px;
  padding: 12px 16px;
  margin: 12px 0;
  border-left: 3px solid var(--brand-green);
}

.intro-panel-highlight strong {
  color: var(--brand-green-dark);
}

.intro-panel-cta {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
  border: 1px solid var(--brand-green);
  border-radius: 20px;
  padding: 10px 20px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  margin-top: 12px;
  box-shadow: 0 2px 8px rgba(120, 190, 32, 0.15);
  animation: ctaGlow 3s ease-in-out infinite;
}

@keyframes ctaGlow {
  0%, 100% { box-shadow: 0 2px 8px rgba(120, 190, 32, 0.15); }
  50% { box-shadow: 0 4px 16px rgba(120, 190, 32, 0.3); }
}

.intro-panel-cta:hover {
  background: #d4edbc;
  color: var(--brand-green-dark);
  border-color: var(--brand-green);
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 6px 20px rgba(120, 190, 32, 0.25);
  animation: none;
}

.intro-panel-cta:active {
  transform: translateY(0) scale(0.98);
}

.intro-panel-cta svg {
  width: 16px;
  height: 16px;
  transition: transform 0.2s ease;
}

.intro-panel-cta:hover svg {
  transform: translateX(3px);
}

/* Drill-Down Question Sections */
.question-section {
  margin-bottom: 20px;
  opacity: 0;
  animation: sectionReveal 0.5s ease-out forwards;
}

.question-section:nth-child(2) { animation-delay: 0.1s; }
.question-section:nth-child(3) { animation-delay: 0.2s; }
.question-section:nth-child(4) { animation-delay: 0.3s; }
.question-section:nth-child(5) { animation-delay: 0.4s; }

@keyframes sectionReveal {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-light);
}

.section-icon {
  font-size: 1.1rem;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  color: var(--brand-green);
  display: flex;
  align-items: center;
}

.section-header:hover .section-icon {
  transform: scale(1.2);
}

.section-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.95rem;
}

.question-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.question-buttons .sample-question {
  background: var(--bg-white);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 0.85rem;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  overflow: hidden;
}

.question-buttons .sample-question::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--brand-green-light) 0%, transparent 50%);
  opacity: 0;
  transition: opacity 0.25s ease;
}

.question-buttons .sample-question:hover {
  border-color: var(--brand-green);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.2);
}

.question-buttons .sample-question:hover::before {
  opacity: 1;
}

.question-buttons .sample-question:active {
  transform: translateY(0) scale(0.98);
}

.question-buttons .sample-question .sample-text {
  position: relative;
  z-index: 1;
}

.question-buttons .sample-question .sample-arrow {
  color: var(--text-secondary);
  opacity: 0;
  transform: translateX(-4px);
  transition: all 0.25s ease;
  position: relative;
  z-index: 1;
}

.question-buttons .sample-question:hover .sample-arrow {
  opacity: 1;
  color: var(--brand-green);
  transform: translateX(0);
}

.extra-questions {
  padding-top: 12px;
}

/* Tool Card */
.tool-card {
  background: var(--bg-white);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 16px;
  transition: all 0.2s ease;
}

.tool-card:hover {
  border-color: var(--brand-green);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.15);
}

.tool-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.tool-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

/* Icon color variants */
.tool-icon.search { background: #e0f2fe; color: #0284c7; }
.tool-icon.details { background: #fef3c7; color: #d97706; }
.tool-icon.compare { background: #f3e8ff; color: #9333ea; }
.tool-icon.understaffed { background: #fee2e2; color: #dc2626; }
.tool-icon.region { background: #d1fae5; color: #059669; }
.tool-icon.segment { background: #fce7f3; color: #db2777; }
.tool-icon.network { background: #e0e7ff; color: #4f46e5; }
.tool-icon.trend { background: #ccfbf1; color: #0d9488; }
.tool-icon.priority { background: #ffedd5; color: #ea580c; }
.tool-icon.report { background: #f1f5f9; color: #475569; }
.tool-icon.city { background: #fef9c3; color: #ca8a04; }
.tool-icon.overview { background: var(--brand-green-light); color: var(--brand-green-dark); }

.tool-card-title {
  flex: 1;
}

.tool-card-title h4 {
  margin: 0;
  font-size: 0.95rem;
  color: var(--text-primary);
  font-weight: 600;
}

.tool-card-title p {
  margin: 2px 0 0;
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Sample Questions */
.tool-samples {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.sample-question {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-subtle);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-align: left;
  width: 100%;
}

.sample-question:hover {
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
}

.sample-question:hover .sample-arrow {
  transform: translateX(3px);
  opacity: 1;
}

.sample-icon {
  font-size: 0.9rem;
  opacity: 0.7;
}

.sample-text {
  flex: 1;
  line-height: 1.3;
}

.sample-arrow {
  font-size: 0.8rem;
  opacity: 0;
  transition: all 0.15s ease;
}

/* Collapsible tools section */
.tools-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  margin-top: 16px;
  background: transparent;
  border: 1px dashed var(--border-light);
  border-radius: 8px;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 0.8rem;
  width: 100%;
  transition: all 0.2s;
  font-family: inherit;
}

.tools-toggle:hover {
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
  background: var(--brand-green-light);
}

.tools-toggle svg {
  transition: transform 0.2s;
}

.tools-toggle.expanded svg {
  transform: rotate(180deg);
}

.tools-extra {
  display: none;
  margin-top: 16px;
}

.tools-extra.visible {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

/* Back to tools button */
.back-to-tools {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.back-to-tools:hover {
  border-color: var(--brand-green);
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
}

.back-to-tools svg {
  width: 14px;
  height: 14px;
}

.agent-response-actions {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  margin-bottom: 16px;
}

.agent-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  padding: 40px;
  color: var(--text-secondary);
}

.agent-loading .spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-light);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Streaming progress UI */
.agent-streaming {
  padding: 24px;
}

.streaming-steps {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.streaming-step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  opacity: 0.5;
  transition: all 0.3s ease;
}

.streaming-step.active {
  opacity: 1;
  background: rgba(120, 190, 32, 0.1);
  border-left: 3px solid var(--brand-green);
}

.streaming-step.done {
  opacity: 0.8;
}

.streaming-step .step-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: var(--text-secondary);
}

.streaming-step.done .step-icon {
  color: var(--brand-green);
  font-weight: bold;
}

.streaming-step .step-text {
  font-size: 14px;
  color: var(--text-primary);
}

.streaming-step .step-timer {
  font-size: 12px;
  color: var(--text-muted);
  font-family: monospace;
  min-width: 40px;
  margin-left: auto;
}

.streaming-step.active .step-timer {
  color: var(--brand-green);
}

.streaming-step .step-tools {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.tool-badge {
  font-size: 11px;
  padding: 2px 8px;
  background: var(--brand-green);
  color: white;
  border-radius: 12px;
  animation: toolFadeIn 0.3s ease;
}

@keyframes toolFadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.spinner-small {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-light);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.agent-response {
  line-height: 1.7;
}

.agent-response p {
  margin: 0 0 12px 0;
}

.agent-response p:last-child {
  margin-bottom: 0;
}

.agent-response h1, .agent-response h2, .agent-response h3 {
  margin-top: 20px;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.agent-response h1:first-child,
.agent-response h2:first-child,
.agent-response h3:first-child {
  margin-top: 0;
}

.agent-response ul, .agent-response ol {
  margin: 12px 0;
  padding-left: 24px;
}

.agent-response li {
  margin-bottom: 6px;
}

.agent-response hr {
  border: none;
  border-top: 1px solid var(--border-light);
  margin: 20px 0;
}

.agent-response blockquote {
  border-left: 3px solid var(--brand-green);
  margin: 12px 0;
  padding: 8px 16px;
  background: var(--brand-green-light);
  color: var(--text-secondary);
}

.agent-response code {
  background: var(--bg-subtle);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.9em;
}

.agent-response table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.85rem;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.agent-response th, .agent-response td {
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border-light);
}

.agent-response th {
  background: var(--brand-green);
  color: white;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.agent-response tbody tr {
  transition: background 0.15s ease;
}

.agent-response tbody tr:nth-child(even) {
  background: var(--bg-subtle);
}

.agent-response tbody tr:hover {
  background: var(--brand-green-light);
}

.agent-response td:first-child {
  font-weight: 600;
  color: var(--brand-green-dark);
}

/* Productivity indicators in tables */
.prod-up {
  color: var(--brand-green);
  font-weight: 600;
}

.prod-down {
  color: #dc2626;
  font-weight: 600;
}

.gap-positive {
  color: #dc2626;
}

.gap-negative {
  color: var(--brand-green);
}

.agent-response pre {
  background: var(--bg-subtle);
  padding: 16px;
  border-radius: 8px;
  overflow-x: auto;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.85rem;
}

.agent-tools-used {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.agent-tools-used span {
  display: inline-block;
  padding: 4px 8px;
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
  border-radius: 4px;
  margin-right: 8px;
  margin-top: 8px;
}

/* ============================================
   NETWORK DASHBOARD
   ============================================ */

/* Hero Stat - Revenue at Risk (Peak Moment) */
.hero-stat {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.08) 0%, rgba(185, 28, 28, 0.15) 100%);
  border: 2px solid rgba(220, 38, 38, 0.3);
  border-radius: 20px;
  padding: 28px 24px;
  text-align: center;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
  opacity: 0;
  transform: translateY(20px) scale(0.95);
  box-shadow:
    0 0 0 1px rgba(220, 38, 38, 0.1),
    0 8px 32px rgba(220, 38, 38, 0.12),
    inset 0 1px 0 rgba(255,255,255,0.1);
}

.hero-stat.animate {
  animation: heroStatEntrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes heroStatEntrance {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.hero-stat::before {
  content: '';
  position: absolute;
  top: -100%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 30% 30%, rgba(220, 38, 38, 0.06) 0%, transparent 50%);
  animation: heroGlow 4s ease-in-out infinite;
  pointer-events: none;
}

@keyframes heroGlow {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.1); }
}

.hero-stat::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(220, 38, 38, 0.3) 50%, transparent 100%);
}

.hero-stat-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: #b91c1c;
  font-weight: 700;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  opacity: 0;
}

.hero-stat.animate .hero-stat-label {
  animation: heroLabelReveal 0.4s ease-out 0.2s forwards;
}

@keyframes heroLabelReveal {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

.hero-stat-label::before {
  content: '';
  width: 8px;
  height: 8px;
  background: #dc2626;
  border-radius: 50%;
  animation: alertPulse 1.5s ease-in-out infinite;
}

@keyframes alertPulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); }
  50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
}

.hero-stat-value {
  font-size: 3rem;
  font-weight: 800;
  color: #dc2626;
  line-height: 1;
  letter-spacing: -0.02em;
  opacity: 0;
  text-shadow: 0 2px 12px rgba(220, 38, 38, 0.2);
}

.hero-stat.animate .hero-stat-value {
  animation: heroValueDrop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;
}

@keyframes heroValueDrop {
  0% { opacity: 0; transform: translateY(-15px) scale(0.9); }
  60% { transform: translateY(3px) scale(1.02); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.hero-stat-value.pulse {
  animation: heroPulseIntense 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes heroReveal {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes heroPulseIntense {
  0% { transform: scale(1); }
  30% { transform: scale(1.08); color: #b91c1c; }
  100% { transform: scale(1); }
}

.hero-stat-detail {
  font-size: 0.8rem;
  color: #b91c1c;
  margin-top: 10px;
  opacity: 0;
  font-weight: 500;
}

.hero-stat.animate .hero-stat-detail {
  animation: heroDetailFade 0.4s ease-out 0.7s forwards;
}

@keyframes heroDetailFade {
  from { opacity: 0; }
  to { opacity: 0.85; }
}

/* Quick Stats Row */
.quick-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.quick-stat {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 14px 12px;
  text-align: center;
  border: 1px solid var(--border-light);
  animation: fadeUp 0.4s ease-out backwards;
}

.quick-stat:nth-child(1) { animation-delay: 0.1s; }
.quick-stat:nth-child(2) { animation-delay: 0.15s; }
.quick-stat:nth-child(3) { animation-delay: 0.2s; }

.quick-stat-value {
  font-size: 1.4rem;
  font-weight: 700;
}

.quick-stat-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 2px;
}

.quick-stat.urgent .quick-stat-value { color: #dc2626; }
.quick-stat.monitor .quick-stat-value { color: #22c55e; }
.quick-stat.optimize .quick-stat-value { color: #eab308; }

/* Legacy summary-bar (keep for compatibility) */
.summary-bar {
  display: none;
}

.summary-stat {
  flex: 1;
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
}

.summary-stat .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--brand-green);
}

.summary-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-stat.balanced .value {
  color: var(--brand-green);
}

.segment-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.segment-table th {
  text-align: left;
  padding: 10px 8px;
  border-bottom: 2px solid var(--border-light);
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.segment-table th:not(:first-child) {
  text-align: right;
}

.segment-table td {
  padding: 12px 8px;
  border-bottom: 1px solid var(--border-light);
}

.segment-table td:not(:first-child) {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.segment-table tr:last-child td {
  border-bottom: none;
}

.segment-table .segment-name {
  font-weight: 600;
  color: var(--text-primary);
}

.segment-table .total-row {
  background: var(--bg-subtle);
  font-weight: 700;
}

.segment-table .total-row td {
  border-bottom: none;
}

/* Zastup column styling - dark blue */
.segment-table .zastup-header {
  color: #1e40af;
}
.segment-table .zastup-cell {
  color: #1e40af;
  font-weight: 600;
}

.status-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-badge.ok {
  background: rgba(120, 190, 32, 0.15);
  color: var(--brand-green-dark);
}

.status-badge.warning {
  background: rgba(245, 158, 11, 0.15);
  color: #b45309;
}

.outlier-section {
  margin-top: 8px;
}

.outlier-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  cursor: pointer;
  border-bottom: 1px solid var(--border-light);
}

.outlier-header h4 {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.outlier-count {
  background: var(--bg-subtle);
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.outlier-arrow {
  transition: transform 0.2s;
}

.outlier-header.expanded .outlier-arrow {
  transform: rotate(180deg);
}

.outlier-list {
  display: none;
  padding: 8px 0;
}

.outlier-list.expanded {
  display: block;
}

/* Priority Dashboard Styles */
.priority-card {
  padding: 0;
  overflow: hidden;
}

.priority-card > .card-title {
  padding: 16px 20px 12px;
  margin: 0;
  border-bottom: 1px solid var(--border-light);
}

.priority-section {
  border-bottom: 1px solid var(--border-light);
  animation: fadeUp 0.4s ease-out backwards;
}

.priority-section:nth-child(2) { animation-delay: 0.1s; }
.priority-section:nth-child(3) { animation-delay: 0.15s; }
.priority-section:nth-child(4) { animation-delay: 0.2s; }

.priority-section:last-child {
  border-bottom: none;
}

.priority-header {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  cursor: pointer;
  gap: 12px;
  transition: background 0.15s;
}

.priority-header:hover {
  background: var(--bg-subtle);
}

.priority-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 700;
  flex-shrink: 0;
  color: white;
}

.priority-icon.urgent {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.priority-icon.monitor {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.priority-icon.optimize {
  background: linear-gradient(135deg, #eab308, #ca8a04);
}

.priority-header-content {
  flex: 1;
  min-width: 0;
}

.priority-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
}

.priority-count {
  background: var(--bg-subtle);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.priority-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
  display: block;
}

.priority-total {
  font-size: 0.9rem;
  font-weight: 700;
  text-align: right;
}

.priority-total.urgent { color: #dc2626; }
.priority-total.monitor { color: #22c55e; }
.priority-total.optimize { color: #eab308; }

.priority-arrow {
  color: var(--text-muted);
  font-size: 0.75rem;
  transition: transform 0.2s;
  margin-left: 8px;
}

.priority-section.expanded .priority-arrow {
  transform: rotate(180deg);
}

.priority-list {
  display: none;
  padding: 0 12px 12px;
}

.priority-section.expanded .priority-list {
  display: block;
}

.priority-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  background: var(--bg-subtle);
  border-radius: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.15s;
  gap: 12px;
  animation: listItemSlide 0.3s ease-out backwards;
}

/* Category background colors - subtle, uniform */
.priority-item.urgent { background: rgba(220, 38, 38, 0.08); }
.priority-item.monitor { background: rgba(34, 197, 94, 0.08); }
.priority-item.optimize { background: rgba(234, 179, 8, 0.08); }

.priority-item:nth-child(1) { animation-delay: 0.05s; }
.priority-item:nth-child(2) { animation-delay: 0.1s; }
.priority-item:nth-child(3) { animation-delay: 0.15s; }
.priority-item:nth-child(4) { animation-delay: 0.2s; }
.priority-item:nth-child(5) { animation-delay: 0.25s; }

@keyframes listItemSlide {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.priority-item:last-child {
  margin-bottom: 0;
}

.priority-item:hover {
  transform: translateX(4px);
}

.priority-item.urgent:hover { background: rgba(220, 38, 38, 0.12); }
.priority-item.monitor:hover { background: rgba(34, 197, 94, 0.12); }
.priority-item.optimize:hover { background: rgba(234, 179, 8, 0.12); }

.priority-item:hover .priority-item-action {
  opacity: 1;
}

.priority-item-rank {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--bg-card);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  flex-shrink: 0;
  z-index: 1;
}

.priority-item-info {
  flex: 1;
  min-width: 0;
  z-index: 1;
}

.priority-item-name {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.priority-item-id {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 400;
}

.priority-item-detail {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Severity mini-bar */
.severity-bar {
  width: 40px;
  height: 4px;
  background: var(--border-light);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
  display: inline-block;
}

.severity-bar-fill {
  height: 100%;
  border-radius: 2px;
}

.severity-bar-fill.urgent { background: #dc2626; }
.severity-bar-fill.monitor { background: #22c55e; }
.severity-bar-fill.optimize { background: #eab308; }

.priority-item-value {
  font-weight: 700;
  font-size: 0.9rem;
  text-align: right;
  z-index: 1;
}

.priority-item-value.loss,
.priority-item-value.urgent {
  color: #dc2626;
}

.priority-item-value.save,
.priority-item-value.optimize {
  color: #eab308;
}

.priority-item-value.growth,
.priority-item-value.monitor {
  color: #22c55e;
}

.priority-item-action {
  opacity: 0;
  background: var(--brand-green);
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s, background 0.15s;
  z-index: 1;
  font-family: inherit;
}

.priority-item-action:hover {
  background: var(--brand-green-dark);
}

.priority-item-type {
  font-size: 0.7rem;
  color: var(--text-muted);
  background: var(--bg-card);
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  margin-top: 2px;
}

.priority-item-subtitle {
  font-size: 0.7rem;
  color: var(--text-muted);
  display: block;
  margin-top: 2px;
}

/* Hospital supply badge for E pharmacies */
.hospital-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  background: #0ea5e9;
  color: white;
  font-size: 0.6rem;
  font-weight: 700;
  border-radius: 3px;
  margin-left: 4px;
}

/* Small pharmacy badge - potential false positive for revenue at risk */
.small-pharmacy-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  background: #f59e0b;
  color: white;
  font-size: 0.6rem;
  font-weight: 700;
  border-radius: 3px;
  margin-left: 4px;
}

/* Legacy styles for compatibility */
.summary-stat.priority-urgent {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(220, 38, 38, 0.05));
  border: 1px solid rgba(220, 38, 38, 0.3);
}

.summary-stat.priority-urgent .value {
  color: #dc2626;
}

/* Remove old section backgrounds */
.priority-urgent-section,
.priority-optimize-section,
.priority-monitor-section {
  background: none;
  border-left: none;
}

.outlier-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: var(--bg-subtle);
  border-radius: 8px;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.outlier-item:last-child {
  margin-bottom: 0;
}

.outlier-info {
  flex: 1;
}

.outlier-name {
  font-weight: 600;
  color: var(--text-primary);
}

.outlier-type {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.outlier-diff {
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
}

.outlier-diff.positive {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.outlier-diff.negative {
  background: rgba(59, 130, 246, 0.1);
  color: #2563eb;
}

.outlier-item {
  cursor: pointer;
  transition: background 0.2s;
}

.outlier-item:hover {
  background: var(--brand-green-light);
}

.outlier-chat-icon {
  width: 28px;
  height: 28px;
  background: var(--brand-green);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  margin-right: 8px;
  flex-shrink: 0;
}

.loading-spinner {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.loading-spinner::before {
  content: '';
  width: 32px;
  height: 32px;
  border: 3px solid var(--border-light);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 12px;
}

/* ============================================
   AI CHAT ASSISTANT
   ============================================ */
.chat-trigger {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(120, 190, 32, 0.4);
  font-size: 1.5rem;
  display: none;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}

.chat-trigger:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(120, 190, 32, 0.5);
}

.chat-trigger.visible {
  display: flex;
}

.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 24px;
  width: 480px;
  max-width: calc(100vw - 48px);
  max-height: calc(100vh - 120px);
  background: var(--bg-card);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  border: 1px solid var(--border-light);
  display: none;
  flex-direction: column;
  z-index: 1001;
  overflow: hidden;
  animation: chatSlideUp 0.3s ease-out;
}

.chat-panel.open {
  display: flex;
}

@keyframes chatSlideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-header {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header h3 {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
}

.chat-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.chat-close:hover {
  background: rgba(255,255,255,0.3);
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  max-height: 400px;
  min-height: 150px;
}

.chat-message {
  margin-bottom: 12px;
  animation: fadeUp 0.3s ease-out;
}

.chat-message.user {
  text-align: right;
}

.chat-message .bubble {
  display: inline-block;
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 0.85rem;
  line-height: 1.5;
  text-align: left;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.chat-message.user .bubble {
  background: var(--brand-green);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-message.assistant .bubble {
  background: var(--bg-subtle);
  color: var(--text-primary);
  border-bottom-left-radius: 4px;
}

.chat-message.assistant .bubble strong {
  color: var(--brand-green-dark);
}

/* Micro chart styling in AI responses */
.chat-message .risk-text {
  color: #dc2626;
  font-weight: 600;
}

.chat-message .bar-filled {
  color: var(--brand-green);
}

.chat-message .bar-empty {
  color: var(--border-medium);
  opacity: 0.6;
}

/* Table styles for chat messages */
.chat-message table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  font-size: 0.85rem;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.chat-message th, .chat-message td {
  padding: 8px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border-light);
}

.chat-message th {
  background: var(--brand-green);
  color: white;
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
}

.chat-message tbody tr:nth-child(even) {
  background: rgba(0,0,0,0.02);
}

.chat-message tbody tr:hover {
  background: var(--brand-green-light);
}

.chat-message td:first-child {
  font-weight: 600;
  color: var(--brand-green-dark);
}

.chat-message .prod-up {
  color: var(--brand-green);
  font-weight: 600;
}

.chat-message .prod-down {
  color: #dc2626;
  font-weight: 600;
}

.chat-message .gap-positive {
  color: #dc2626;
}

.chat-message .gap-negative {
  color: var(--brand-green);
}

/* Legend text after tables - smaller font */
.chat-message p:has(+ table),
.chat-message table + p,
.chat-message small,
.chat-message .legend {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Also style bars in agent responses */
.agent-response .bar-filled {
  color: var(--brand-green);
}

.agent-response .bar-empty {
  color: var(--border-medium);
  opacity: 0.6;
}

.chat-input-area {
  padding: 12px 16px;
  border-top: 1px solid var(--border-light);
  display: flex;
  gap: 8px;
}

.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1.5px solid var(--border-medium);
  border-radius: 24px;
  font-size: 0.85rem;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}

.chat-input:focus {
  border-color: var(--brand-green);
}

.chat-send {
  width: 40px;
  height: 40px;
  background: var(--brand-green);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.chat-send:hover {
  background: var(--brand-green-dark);
}

.chat-send:disabled {
  background: var(--border-medium);
  cursor: not-allowed;
}

.chat-typing {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 10px 14px;
}

.chat-typing span {
  width: 8px;
  height: 8px;
  background: var(--brand-green);
  border-radius: 50%;
  animation: typingBounce 1.4s infinite ease-in-out;
}

.chat-typing span:nth-child(1) { animation-delay: 0s; }
.chat-typing span:nth-child(2) { animation-delay: 0.15s; }
.chat-typing span:nth-child(3) { animation-delay: 0.3s; }

@keyframes typingBounce {
  0%, 60%, 100% {
    transform: translateY(0) scale(0.8);
    opacity: 0.4;
    background: var(--border-medium);
  }
  30% {
    transform: translateY(-6px) scale(1);
    opacity: 1;
    background: var(--brand-green);
  }
}

.chat-suggestions {
  padding: 0 16px 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.chat-suggestion {
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 6px 12px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.chat-suggestion:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
}

/* Agent mode styling - unified with brand */
.chat-suggestion.agent {
  background: linear-gradient(135deg, rgba(120, 190, 32, 0.15) 0%, rgba(120, 190, 32, 0.08) 100%);
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
}

.chat-suggestion.agent:hover {
  background: linear-gradient(135deg, rgba(120, 190, 32, 0.25) 0%, rgba(120, 190, 32, 0.15) 100%);
  border-color: var(--brand-green-dark);
}

/* ============================================
   SIMULATION - Simplified (2 questions)
   ============================================ */
/* Simulation section - unified with position charts */
.sim-section {
  padding: 0;
  margin-bottom: 18px;
}

.sim-section:last-of-type {
  margin-bottom: 0;
}

.sim-row {
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  gap: 12px;
}

.sim-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.sim-input-value {
  font-weight: 700;
  color: var(--brand-green);
  margin-left: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sim-input-value.visible {
  opacity: 1;
}

.sim-input-value.negative {
  color: #dc2626;
}

.sim-slider-wrap {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sim-slider {
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
  height: 8px;
  background: linear-gradient(90deg, var(--border-light) 0%, var(--brand-green-light) 50%, var(--border-light) 100%);
  border-radius: 4px;
  cursor: pointer;
  transition: box-shadow 0.2s;
}

.sim-slider:focus {
  outline: none;
}

.sim-slider:active {
  box-shadow: 0 0 0 4px rgba(120, 190, 32, 0.2);
}

.sim-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  border: 2px solid white;
  border-radius: 50%;
  cursor: grab;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: transform 0.15s;
}

.sim-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.sim-slider:active::-webkit-slider-thumb {
  cursor: grabbing;
}

.sim-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  border: 2px solid white;
  border-radius: 50%;
  cursor: grab;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.sim-range-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.65rem;
  color: var(--text-muted);
}

/* Result - matches position-result style */
.sim-result {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.sim-result-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--brand-green);
  transition: color 0.2s;
}

.sim-result.negative .sim-result-value {
  color: #dc2626;
}

.sim-result.zero .sim-result-value {
  color: var(--text-muted);
}

.sim-result-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--brand-green);
}

.sim-result.negative .sim-result-indicator {
  background: #dc2626;
}

.sim-result.zero .sim-result-indicator {
  background: var(--text-muted);
}

/* Summary section - cleaner style */
.sim-summary {
  margin-top: 18px;
  padding: 16px;
  background: var(--bg-subtle);
  border-radius: 8px;
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  gap: 12px;
}

.sim-summary-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.sim-summary-breakdown {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.sim-summary-arrow {
  color: var(--text-muted);
}

.sim-summary-new {
  font-weight: 600;
  color: var(--text-primary);
}

.sim-summary-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--brand-green);
  text-align: center;
}

.sim-summary-value.negative {
  color: #dc2626;
}

.sim-summary-value.pulse {
  animation: simPulse 0.3s ease-out;
}

@keyframes simPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.sim-reset-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 4px 10px;
  font-size: 0.75rem;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}
.sim-reset-btn:hover {
  background: var(--card-bg);
  color: var(--text);
}

.btn-new-pharmacy {
  padding: 12px 16px;
  background: var(--bg-subtle);
  border: 1.5px dashed var(--border-medium);
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn-new-pharmacy:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  border-style: solid;
  color: var(--brand-green);
}
.btn-new-pharmacy svg {
  width: 16px;
  height: 16px;
}

.sim-charts {
  display: flex;
  flex-direction: column;
  gap: 18px;
  max-width: 100%;
  margin: 0 auto;
}

/* ============================================
   FTE IMPACT SIMULATION
   ============================================ */
.impact-card {
  background: var(--bg-subtle);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 12px;
}

.impact-title {
  font-weight: 600;
  font-size: 0.85rem;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.impact-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  margin-bottom: 4px;
}

.impact-row.highlight {
  font-weight: 700;
  font-size: 1rem;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--border-light);
}

.impact-row .positive { color: var(--brand-green); }
.impact-row .negative { color: #dc2626; }
.impact-row .warning { color: #f59e0b; }

.info-note {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 12px;
  padding: 8px 12px;
  background: #fef3c7;
  border-radius: 6px;
}

/* ============================================
   SEGMENT POSITION CHARTS (Enhanced)
   ============================================ */
.position-charts {
  display: flex;
  flex-direction: column;
  gap: 18px;
  max-width: 100%;
  margin: 0 auto;
}

.position-row {
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: start;
  gap: 12px;
}

.position-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  line-height: 1;
  padding-top: 2px;
}

.position-track-wrapper {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.position-track {
  position: relative;
  height: 8px;
  background: var(--bg-subtle);
  border-radius: 4px;
  transition: height 0.2s ease;
}

.position-range {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(90deg, var(--border-light) 0%, var(--brand-green-light) 50%, var(--border-light) 100%);
  border-radius: 4px;
  transition: opacity 0.2s ease;
}

.track-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.65rem;
  color: var(--text-muted);
}

/* Histogram overlay - visible on hover */
.position-histogram {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: flex-end;
  gap: 1px;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.position-row:hover .position-histogram {
  opacity: 1;
}

.position-row:hover .position-track:not(.zone-track) {
  height: 28px;
}

.position-row:hover .position-range {
  opacity: 0.3;
}

.histogram-bar {
  flex: 1;
  background: var(--brand-green);
  opacity: 0.6;
  border-radius: 1px 1px 0 0;
  min-height: 1px;
}

.position-marker {
  position: absolute;
  top: 50%;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: transform 0.2s;
  z-index: 2;
}

.position-marker.avg {
  background: white;
  border: 2px solid var(--text-muted);
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.position-marker.you {
  background: var(--brand-green);
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(120, 190, 32, 0.5);
  z-index: 3;
}

/* Result column with value + indicator + tooltip */
.position-result {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  position: relative;
  padding-top: 0;
  line-height: 1;
  cursor: help;
}

.position-value {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-primary);
}

.position-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  font-size: 0.7rem;
  font-weight: 700;
}

.position-indicator.positive {
  background: rgba(22, 163, 74, 0.12);
  color: var(--positive);
}

.position-indicator.negative {
  background: rgba(220, 38, 38, 0.12);
  color: var(--negative);
}

.position-indicator.neutral {
  background: rgba(107, 114, 128, 0.1);
  color: var(--neutral);
}

/* Tooltip on hover */
.position-tooltip {
  display: none;
  position: absolute;
  right: 0;
  top: calc(100% + 8px);
  background: var(--text-primary);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.75rem;
  white-space: nowrap;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.position-tooltip::before {
  content: '';
  position: absolute;
  bottom: 100%;
  right: 16px;
  border: 6px solid transparent;
  border-bottom-color: var(--text-primary);
}

.position-result:hover .position-tooltip {
  display: block;
}

/* Zone-based tracks (Produktivita, Trend) */
.zone-track {
  display: flex;
  overflow: hidden;
  height: 10px !important;
}

.zone-track:hover {
  height: 10px !important;
}

.zone {
  flex: 1;
  height: 100%;
}

.zone-low, .zone-declining {
  background: rgba(220, 38, 38, 0.15);
  border-radius: 4px 0 0 4px;
}

.zone-avg, .zone-stable {
  background: rgba(107, 114, 128, 0.12);
}

.zone-high, .zone-growing {
  background: rgba(22, 163, 74, 0.15);
  border-radius: 0 4px 4px 0;
}

/* Zone labels in result */
.zone-label {
  font-size: 0.85rem !important;
  font-weight: 600 !important;
}

.zone-label.high, .zone-label.growing {
  color: var(--positive);
}

.zone-label.avg, .zone-label.stable {
  color: var(--neutral);
}

.zone-label.low, .zone-label.declining {
  color: var(--negative);
}

/* Three-label track for zones */
.position-track-wrapper:has(.zone-track) .track-labels {
  justify-content: space-around;
}

/* Separator */
.position-separator {
  height: 1px;
  background: var(--border-light);
  margin: 4px 0;
}

/* Legend */
.position-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.legend-dot.avg {
  background: white;
  border: 2px solid var(--text-muted);
}

.legend-dot.you {
  background: var(--brand-green);
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(120, 190, 32, 0.4);
}

@media (max-width: 480px) {
  .position-row {
    grid-template-columns: 70px 1fr 90px;
    gap: 8px;
  }
  .position-value {
    font-size: 0.85rem;
  }
  .track-labels {
    font-size: 0.6rem;
  }
}

/* ============================================
   PHARMACY SELECTOR
   ============================================ */
.pharmacy-selector label {
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 6px;
  display: block;
  color: var(--text-secondary);
}

.pharmacy-id-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
}

.pharmacy-id-row input {
  width: 120px;
  transition: all 0.3s ease;
}

/* Ready state animation for pharmacy ID input */
.pharmacy-id-row input.ready {
  animation: inputReady 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px var(--brand-green-light), var(--shadow-sm);
}

@keyframes inputReady {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 var(--brand-green-light);
  }
  40% {
    transform: scale(1.02);
    box-shadow: 0 0 0 6px var(--brand-green-light);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 3px var(--brand-green-light);
  }
}

.btn-load {
  padding: 12px 16px;
  background: var(--bg-subtle);
  border: 1.5px solid var(--border-medium);
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.btn-load:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  color: var(--brand-green);
}

.pharmacy-hint {
  font-size: 0.95rem;
  color: var(--text-muted);
  margin-left: 12px;
}

.pharmacy-hint.loaded {
  color: var(--brand-green);
  font-weight: 600;
}

.pharmacy-hint.error {
  color: #dc2626;
}

/* Revenue Loss Display - THE PEAK MOMENT */
.revenue-loss {
  margin: 20px 0 24px 0;
  padding: 24px 20px 20px;
  background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 50%, #fecaca 100%);
  border: 2px solid rgba(220, 38, 38, 0.35);
  border-radius: 16px;
  color: #991b1b;
  text-align: center;
  animation: peakReveal 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
  animation-delay: 0.4s;
  box-shadow: 0 4px 20px rgba(220, 38, 38, 0.15), 0 0 0 4px rgba(220, 38, 38, 0.05);
  position: relative;
  overflow: hidden;
}

.revenue-loss::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: peakShine 1.2s ease-out 1s forwards;
}

@keyframes peakShine {
  0% { left: -100%; }
  100% { left: 100%; }
}

@keyframes peakReveal {
  0% {
    opacity: 0;
    transform: scale(0.8) translateY(20px);
  }
  60% {
    transform: scale(1.03) translateY(-2px);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

/* Heartbeat animation - single dramatic pulse */
@keyframes heartbeat {
  0% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
  15% {
    transform: scale(1.04);
    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.25);
  }
  30% {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
  45% {
    transform: scale(1.02);
    box-shadow: 0 3px 14px rgba(220, 38, 38, 0.18);
  }
  60%, 100% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
}

.revenue-loss-header {
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  opacity: 0.7;
  margin-bottom: 8px;
}

.revenue-loss-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: rgba(220, 38, 38, 0.15);
  border-radius: 50%;
  margin-bottom: 10px;
  font-size: 1rem;
}

.revenue-loss-value {
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  line-height: 1.1;
  margin-bottom: 4px;
  font-variant-numeric: tabular-nums;
}

.revenue-loss-value .currency {
  font-size: 1.4rem;
  font-weight: 700;
  opacity: 0.8;
}

.revenue-loss-percent {
  font-size: 1rem;
  font-weight: 600;
  opacity: 0.85;
  margin-bottom: 8px;
}

.revenue-loss-note {
  font-size: 0.75rem;
  opacity: 0.6;
  font-weight: 500;
}

/* Counting animation for revenue */
@keyframes countPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

/* Revenue Teaser - show problem, hide solution */
.revenue-teaser {
  margin: 16px 0;
  padding: 20px;
  background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
  border-radius: 14px;
  color: #f9fafb;
  text-align: center;
}

.teaser-header {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: #f87171;
  margin-bottom: 8px;
  text-transform: uppercase;
}

.teaser-value {
  font-size: 1.6rem;
  font-weight: 700;
  color: #fca5a5;
  margin-bottom: 16px;
}

.teaser-bars {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.teaser-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.teaser-bar-label {
  font-size: 0.75rem;
  color: #9ca3af;
  width: 90px;
  text-align: right;
}

.teaser-bar-track {
  flex: 1;
  height: 8px;
  background: #374151;
  border-radius: 4px;
  overflow: hidden;
}

.teaser-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #f87171, #dc2626);
  border-radius: 4px;
  position: relative;
}

.teaser-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent,
    transparent 4px,
    rgba(0,0,0,0.3) 4px,
    rgba(0,0,0,0.3) 8px
  );
}

.teaser-question {
  font-size: 0.9rem;
  color: #d1d5db;
  margin: 16px 0 12px;
  font-style: italic;
}

.teaser-cta {
  display: inline-block;
  background: var(--brand-green);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.85rem;
  text-decoration: none;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  border: none;
}

.teaser-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.4);
}

.teaser-hint {
  font-size: 0.7rem;
  color: #6b7280;
  margin-top: 12px;
}

/* Blurred preview sections */
.teaser-blurred-section {
  margin: 16px 0;
}

.teaser-section-label {
  font-size: 0.7rem;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}

.teaser-heatmap-blur,
.teaser-schedule-blur {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
}

.blur-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  background: rgba(31, 41, 55, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Mini heatmap */
.teaser-heatmap {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 8px;
  background: #374151;
  border-radius: 8px;
}

.th-row {
  display: flex;
  gap: 2px;
}

.th-row span {
  width: 22px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  color: #9ca3af;
  border-radius: 2px;
}

.th-row span.g {
  background: #065f46;
}

.th-row span.y {
  background: #92400e;
}

.th-row span.r {
  background: #dc2626;
}

/* Mini schedule table */
.teaser-schedule {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  background: #374151;
  border-radius: 8px;
  overflow: hidden;
}

.teaser-schedule th,
.teaser-schedule td {
  padding: 8px 12px;
  text-align: center;
  color: #d1d5db;
}

.teaser-schedule th {
  background: #4b5563;
  font-weight: 600;
  color: #9ca3af;
}

.teaser-schedule td {
  border-top: 1px solid #4b5563;
}

.teaser-schedule td.warn {
  background: rgba(220, 38, 38, 0.3);
  color: #fca5a5;
  font-weight: 600;
}

/* Capacity visual bars */
.capacity-visual {
  padding: 12px;
  background: #374151;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.capacity-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.capacity-label {
  font-size: 0.7rem;
  color: #9ca3af;
  width: 70px;
  text-align: right;
  flex-shrink: 0;
}

.capacity-bar {
  flex: 1;
  height: 28px;
  background: rgba(220, 38, 38, 0.2);
  border-radius: 6px;
  display: flex;
  overflow: hidden;
  border: 1px dashed rgba(220, 38, 38, 0.4);
}

.capacity-fill {
  background: linear-gradient(135deg, #065f46 0%, #047857 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 5px 0 0 5px;
  position: relative;
}

.capacity-fill.critical {
  background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
}

.capacity-icons {
  font-size: 0.75rem;
  letter-spacing: 2px;
}

.capacity-gap {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 4px,
    rgba(220, 38, 38, 0.15) 4px,
    rgba(220, 38, 38, 0.15) 8px
  );
}

.capacity-gap.critical {
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 4px,
    rgba(220, 38, 38, 0.3) 4px,
    rgba(220, 38, 38, 0.3) 8px
  );
}

.gap-icon {
  font-size: 0.85rem;
}

.capacity-pct {
  font-size: 0.75rem;
  font-weight: 700;
  width: 36px;
  text-align: right;
  flex-shrink: 0;
}

.capacity-pct.warn {
  color: #fbbf24;
}

.capacity-pct.critical {
  color: #f87171;
}

/* CSV export button styling */
.btn-export-csv {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border-medium);
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
  margin-left: 8px;
}
.btn-export-csv:hover {
  background: var(--bg-subtle);
  color: var(--text-secondary);
}

/* Toast notifications */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  background: #dc2626;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-size: 0.9rem;
  animation: toastSlideIn 0.3s ease-out;
  max-width: 350px;
}
.toast.success { background: #16a34a; }
.toast.warning { background: #f59e0b; }
@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes toastFadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

/* ============================================
   REVENUE TREND CHART
   ============================================ */
.trend-chart-container {
  position: relative;
  width: 100%;
  height: 240px;
}

.trend-chart-svg {
  width: 100%;
  height: 100%;
  overflow: visible;
}

/* Chart Lines */
.trend-line {
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: trendLineReveal 1.2s ease-out forwards;
}

.trend-line-2019 {
  stroke: rgba(120, 190, 32, 0.25);
  stroke-width: 1.5;
  animation-delay: 0.1s;
}

.trend-line-2020 {
  stroke: rgba(120, 190, 32, 0.55);
  stroke-width: 1.75;
  animation-delay: 0.25s;
}

.trend-line-2021 {
  stroke: rgba(120, 190, 32, 1);
  stroke-width: 2.25;
  animation-delay: 0.4s;
}

/* Forecast Line */
.trend-line-forecast {
  fill: none;
  stroke: rgba(120, 190, 32, 1);
  stroke-width: 2;
  stroke-dasharray: 6, 4;
  opacity: 0;
  animation: trendForecastReveal 0.6s ease-out forwards;
  animation-delay: 0.8s;
}

@keyframes trendForecastReveal {
  to { opacity: 0.7; }
}

.trend-forecast-label {
  font-size: 9px;
  fill: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0;
  animation: trendForecastReveal 0.6s ease-out forwards;
  animation-delay: 0.8s;
}

@keyframes trendLineReveal {
  to { stroke-dashoffset: 0; }
}

/* Chart Areas */
.trend-area {
  opacity: 0;
  animation: trendAreaFadeIn 0.8s ease-out forwards;
}

.trend-area-2019 { fill: rgba(120, 190, 32, 0.03); animation-delay: 0.1s; }
.trend-area-2020 { fill: rgba(120, 190, 32, 0.06); animation-delay: 0.2s; }
.trend-area-2021 { fill: rgba(120, 190, 32, 0.12); animation-delay: 0.3s; }

@keyframes trendAreaFadeIn {
  to { opacity: 1; }
}

/* Current Month Marker */
.trend-current-marker {
  opacity: 0;
  animation: trendMarkerPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  animation-delay: 1s;
}

@keyframes trendMarkerPop {
  0% { opacity: 0; transform: scale(0); }
  100% { opacity: 1; transform: scale(1); }
}

/* Axis Labels */
.trend-axis-label {
  font-size: 10px;
  fill: var(--text-muted);
  font-weight: 500;
}

.trend-axis-label-month {
  text-anchor: middle;
}

.trend-axis-label-value {
  text-anchor: end;
}

/* Grid Lines */
.trend-grid-line {
  stroke: var(--border-light);
  stroke-width: 1;
  stroke-dasharray: 2, 4;
}

/* YoY Stats */
.trend-yoy-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
  margin-left: 50px;
  margin-right: 20px;
}

.trend-yoy-item {
  background: var(--bg-subtle);
  border-radius: 8px;
  padding: 10px 16px;
  text-align: center;
  border: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.trend-yoy-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 500;
}

.trend-yoy-value {
  font-size: 1.125rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.trend-yoy-value.positive {
  color: var(--brand-green-dark);
}

.trend-yoy-value.negative {
  color: #dc2626;
}

/* Tooltip - hidden, using crosshair tooltip instead */
.trend-tooltip {
  display: none;
}

/* Bloomberg-style crosshair */
.trend-crosshair {
  stroke: var(--text-muted);
  stroke-width: 1;
  stroke-dasharray: 3, 3;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.1s ease;
}

.trend-crosshair.active {
  opacity: 1;
}

.trend-crosshair-tooltip {
  position: absolute;
  top: 10px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid var(--border-light);
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 0.65rem;
  box-shadow: var(--shadow-sm);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease;
  z-index: 20;
  white-space: nowrap;
}

.trend-crosshair-tooltip.active {
  opacity: 1;
}

/* No data state */
.trend-no-data {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-muted);
  font-size: 0.875rem;
}

/* ============================================
   FTE MANAGEMENT AUTOMATION TAB
   ============================================ */

/* Autopilot Panel */
.autopilot-card {
  background: var(--bg-card);
  border-radius: 16px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  padding: 20px;
  margin-bottom: 16px;
}

.autopilot-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.autopilot-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.3);
}

.autopilot-icon svg {
  width: 20px;
  height: 20px;
  color: white;
}

.autopilot-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.autopilot-frequency {
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--text-muted);
  background: var(--bg-subtle);
  padding: 3px 8px;
  border-radius: 4px;
  margin-left: 10px;
}

.autopilot-status {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--brand-green-dark);
  background: var(--brand-green-light);
  padding: 4px 10px;
  border-radius: 20px;
}

.autopilot-status-dot {
  width: 6px;
  height: 6px;
  background: var(--brand-green);
  border-radius: 50%;
  animation: statusPulse 1.5s ease-in-out infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Schedule Items */
.schedule-group {
  margin-bottom: 16px;
}

.schedule-group:last-child {
  margin-bottom: 0;
}

.schedule-group-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.schedule-group-header svg {
  width: 14px;
  height: 14px;
  opacity: 0.6;
}

.schedule-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.schedule-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  background: var(--bg-subtle);
  border-radius: 10px;
  transition: all 0.2s ease;
}

.schedule-item:hover {
  background: var(--brand-green-light);
}

.schedule-item-status {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.schedule-item-status.completed {
  background: var(--brand-green);
  color: white;
}

.schedule-item-status.pending {
  background: var(--border-medium);
  color: var(--text-muted);
}

.schedule-item-status.running {
  background: var(--accent-warm);
  color: white;
  animation: runningPulse 1s ease-in-out infinite;
}

@keyframes runningPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
  50% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
}

.schedule-item-status svg {
  width: 12px;
  height: 12px;
}

.schedule-item-text {
  flex: 1;
  font-size: 0.85rem;
  color: var(--text-primary);
}

.schedule-item-time {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}

/* Agent Workflow */
.workflow-card {
  background: var(--bg-card);
  border-radius: 16px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  padding: 20px;
  margin-bottom: 16px;
}

.workflow-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
}

.workflow-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.25);
}

.workflow-icon svg {
  width: 20px;
  height: 20px;
  color: white;
}

.workflow-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.workflow-pipeline {
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  padding: 0 10px;
}

.workflow-pipeline::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 60px;
  right: 60px;
  height: 2px;
  background: var(--border-medium);
  transform: translateY(-50%);
  z-index: 0;
}

.workflow-stage {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  z-index: 1;
}

.workflow-stage-circle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 2px solid var(--border-medium);
  transition: all 0.3s ease;
}

.workflow-stage-circle svg {
  width: 20px;
  height: 20px;
  color: var(--text-muted);
  transition: all 0.3s ease;
}

.workflow-stage.completed .workflow-stage-circle {
  background: var(--brand-green);
  border-color: var(--brand-green);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.3);
}

.workflow-stage.completed .workflow-stage-circle svg {
  color: white;
}

.workflow-stage.active .workflow-stage-circle {
  background: var(--accent-warm);
  border-color: var(--accent-warm);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  animation: stageActive 1.5s ease-in-out infinite;
}

@keyframes stageActive {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}

.workflow-stage.active .workflow-stage-circle svg {
  color: white;
}

.workflow-stage-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.workflow-stage.completed .workflow-stage-label,
.workflow-stage.active .workflow-stage-label {
  color: var(--text-primary);
}

/* Workflow Arrow Connectors */
.workflow-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: var(--border-medium);
  z-index: 1;
}

.workflow-arrow.arrow-1 { left: calc(33% - 8px); }
.workflow-arrow.arrow-2 { left: calc(66% - 8px); }

.workflow-arrow svg {
  width: 16px;
  height: 16px;
}

.workflow-arrow.completed {
  color: var(--brand-green);
}

/* Workflow Stats */
.workflow-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.workflow-stat {
  text-align: center;
}

.workflow-stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
}

.workflow-stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Feedback Cycle (Uzavretý Cyklus Zlepšovania) */
.feedback-cycle-card {
  background: var(--bg-card);
}


.feedback-cycle-steps {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.cycle-step {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-light);
}

.cycle-step:last-child {
  border-bottom: none;
}

.cycle-step-number {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--brand-green);
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.cycle-step-content {
  flex: 1;
}

.cycle-step-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
}

.cycle-step-desc {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 1px;
}

.feedback-cycle-stats {
  display: flex;
  justify-content: space-around;
  margin-top: 16px;
  padding: 14px 0;
  background: var(--bg-subtle);
  border-radius: 10px;
}

.feedback-stat {
  text-align: center;
}

.feedback-stat-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--brand-green-dark);
  font-variant-numeric: tabular-nums;
}

.feedback-stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Automation Benefits - Hero Section */
.automation-benefits {
  background: linear-gradient(135deg, var(--brand-green-light) 0%, #e8f5e0 100%);
  border: 1px solid var(--brand-green);
  border-radius: 12px;
  padding: 24px 28px;
  margin-bottom: 20px;
}

.automation-benefits-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--brand-green-dark);
  margin: 0 0 16px 0;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.automation-benefits-stats {
  display: flex;
  justify-content: space-around;
}

.benefit-stat {
  text-align: center;
  padding: 0 16px;
}

.benefit-stat-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--brand-green-dark);
  font-variant-numeric: tabular-nums;
}

.benefit-stat-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 4px;
  font-weight: 500;
}

.feedback-tip {
  margin-top: 14px;
  padding: 12px 14px;
  background: var(--bg-subtle);
  border-radius: 8px;
  border-left: 3px solid var(--brand-green);
  font-size: 0.8rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

.feedback-tip strong {
  color: var(--text-primary);
}

/* Integrations Grid */
.integrations-card {
  background: var(--bg-card);
  border-radius: 16px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  padding: 20px;
  margin-bottom: 16px;
}

.integrations-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.integrations-icon {
  width: 40px;
  height: 40px;
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.integrations-icon svg {
  width: 20px;
  height: 20px;
  color: var(--text-muted);
}

.integrations-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.integrations-section {
  margin-bottom: 16px;
}

.integrations-section:last-child {
  margin-bottom: 0;
}

.integrations-section-title {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.integrations-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.integration-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 14px 8px;
  background: var(--bg-subtle);
  border-radius: 12px;
  transition: all 0.2s ease;
  position: relative;
}

.integration-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.integration-logo {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.integration-name {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-primary);
  text-align: center;
}

.integration-status {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.integration-status.ready {
  background: var(--brand-green);
  box-shadow: 0 0 0 2px rgba(120, 190, 32, 0.2);
}

.integration-status.planned {
  background: var(--accent-warm);
  box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
}

.integration-status.future {
  background: var(--border-medium);
}

/* Legend */
.integrations-legend {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid var(--border-light);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.7rem;
  color: var(--text-muted);
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.legend-dot.ready { background: var(--brand-green); }
.legend-dot.planned { background: var(--accent-warm); }
.legend-dot.future { background: var(--border-medium); }

/* CTA Button */
.vision-cta {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 14px 24px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  font-size: 0.9rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(120, 190, 32, 0.3);
  margin-top: 8px;
  text-decoration: none;
}

.vision-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(120, 190, 32, 0.4);
}

.vision-cta svg {
  width: 18px;
  height: 18px;
}

/* Simulate Button */
.btn-simulate {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: var(--brand-green-light);
  border: 1px solid var(--brand-green);
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--brand-green-dark);
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
  animation: pulse-invite 2s ease-in-out infinite;
}

@keyframes pulse-invite {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(120, 190, 32, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(120, 190, 32, 0);
  }
}

.btn-simulate:hover {
  background: var(--brand-green);
  border-color: var(--brand-green-dark);
  color: white;
  animation: none;
}

.btn-simulate svg {
  width: 14px;
  height: 14px;
}

</style>
</head>
<body>
<!-- INTRO OVERLAY -->
<div class="intro-overlay" id="intro-overlay">
  <button class="intro-skip" onclick="dismissIntro()">
    Preskočiť
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
  </button>
  <div class="intro-content">
    <!-- PHASE 1: The Dramatic Question -->
    <div class="intro-question" id="intro-question">
      <p class="intro-question-text">
        Viete, kde strácate tržby<br>kvôli nesprávnemu obsadeniu?
      </p>
    </div>

    <!-- PHASE 2: The Solution (hidden initially) -->
    <div class="intro-solution" id="intro-solution">
      <h1 class="intro-headline">
        Teraz to zistíte<br><strong>za pár sekúnd</strong>
      </h1>
      <div class="intro-features">
        <div class="intro-feature">
          <span class="intro-feature-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </span>
          <span>Jasná odpoveď namiesto intuície</span>
        </div>
        <div class="intro-feature">
          <span class="intro-feature-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
          </span>
          <span>Odhaľte ohrozené tržby</span>
        </div>
        <div class="intro-feature">
          <span class="intro-feature-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
          </span>
          <span>Rozhodnutie za minútu</span>
        </div>
      </div>
      <button class="intro-cta" onclick="dismissIntro()">
        Začať analýzu
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"/>
          <polyline points="12 5 19 12 12 19"/>
        </svg>
      </button>
      <p class="intro-footer">Inteligentný FTE Manažment v5.1</p>
    </div>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>
<div class="container">
  <div class="header animate-in">
    <h1><img src="/static/images/drmax-logo.svg" alt="Dr.Max" class="header-logo"> Inteligentný FTE Manažment</h1>
    <p class="subtitle">Overte obsadenie lekárne — kde strácate tržby a brzdíte rast</p>
    <p class="data-period-note">Dáta: 2019-2021 | Retrospektívna validácia</p>
    <button onclick="document.getElementById('about-modal').style.display='flex'" style="
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: 1px solid var(--border-light);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    " title="About">ⓘ</button>
  </div>

  <!-- About Modal -->
  <div id="about-modal" onclick="if(event.target===this)this.style.display='none'" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
  ">
    <div style="
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
    ">
      <button onclick="document.getElementById('about-modal').style.display='none'" style="
        position: absolute;
        top: 12px;
        right: 12px;
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--text-muted);
      ">×</button>
      <h2 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1.25rem;">O aplikácii</h2>
      <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
        <p style="margin: 0 0 12px 0;"><strong>Inteligentný FTE Manažment</strong></p>
        <p style="margin: 0 0 12px 0;">ML model pre optimálne plánovanie personálu v lekárňach.</p>
        <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
          Verzia 5.1
        </p>
      </div>
    </div>
  </div>

  <!-- TAB NAVIGATION - Icon Based -->
  <div class="tab-nav animate-in">
    <button class="tab-btn active" data-tab="calculator" title="Kalkulačka">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="analyza" title="Porovnanie">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"/>
        <line x1="12" y1="20" x2="12" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="14"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="network" title="Prehľad">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="14" width="7" height="7" rx="1"/>
        <rect x="3" y="14" width="7" height="7" rx="1"/>
      </svg>
    </button>
    <button class="tab-btn agent-tab" data-tab="agent" title="AI Asistent">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="rozvrh" title="Rozvrh">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="vision" title="FTE Management Automation">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>
  </div>

  <!-- CALCULATOR TAB -->
  <div id="tab-calculator" class="tab-content active">

  <!-- FACTS -->
  <div class="card animate-in">
    <div class="card-title">Parametre lekárne</div>

    <label for="pharmacy-id-input">Zadajte ID lekárne</label>
    <div class="pharmacy-id-row">
      <input type="number" id="pharmacy-id-input" placeholder="napr. 33" min="1">
      <button type="button" id="pharmacy-load-btn" class="btn-load">Načítať</button>
      <button type="button" class="btn-new-pharmacy" id="btn-new-pharmacy" title="Vymazať formulár a zadať parametre novej/plánovanej lekárne">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        Nová
      </button>
      <span class="pharmacy-hint" id="pharmacy-hint"></span>
    </div>

    <label>Typ lekárne</label>
    <select id="typ">
      <option>A - shopping premium</option>
      <option>B - shopping</option>
      <option>C - street +</option>
      <option>D - street</option>
      <option>E - poliklinika</option>
    </select>

    <div class="form-row" style="gap: 12px;">
      <div class="tooltip-wrapper">
        <span class="tooltip-text" id="bloky-tooltip">Bloky za rok (v tisícoch)</span>
        <label>Bloky (tis.)</label>
        <input id="bloky" type="number" value="60" step="1">
      </div>
      <div class="tooltip-wrapper">
        <span class="tooltip-text" id="trzby-tooltip">Tržby za rok (v miliónoch €)</span>
        <label>Tržby (mil. €)</label>
        <input id="trzby" type="number" value="1.2" step="0.1">
      </div>
    </div>

    <div class="form-row" style="gap: 12px; margin-top: 16px;">
      <div class="tooltip-wrapper">
        <span class="tooltip-text">Podiel receptových blokov</span>
        <label>Podiel Rx</label>
        <div class="input-with-suffix">
          <input id="rx" type="number" min="20" max="90" value="50">
          <span class="input-suffix">%</span>
        </div>
      </div>
      <div class="tooltip-wrapper">
        <span class="tooltip-text">Nadpriemerná = viac transakcií/hod. ako priemer segmentu</span>
        <label>Produktivita</label>
        <div class="segmented-control">
          <div class="segment-option">
            <input type="radio" name="prod-toggle-radio" id="prod-avg" checked>
            <label for="prod-avg">Priemer</label>
          </div>
          <div class="segment-option high-productivity">
            <input type="radio" name="prod-toggle-radio" id="prod-high">
            <label for="prod-high">Nad</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="btn animate-in" id="calc">Vypočítať</button>

  <!-- RESULT -->
  <div id="result" style="display:none;">
    <div class="result-divider"></div>
    
    <div class="result-main result-stagger-1">
      <div class="val-row">
        <div class="val" id="fte-total">-</div>
        <div class="val-vs" id="val-vs" style="display:none;">
          <span class="val-vs-text">vs</span>
          <span class="val" id="fte-actual">-</span>
        </div>
      </div>
      <div class="label" id="fte-label">Odporúčané FTE</div>
      <div class="range" id="fte-range"></div>
    </div>

    <!-- Revenue Loss Display (Kahneman loss framing) - THE PEAK -->
    <div class="revenue-loss result-stagger-2" id="revenue-loss" style="display:none; position: relative;">
      <button onclick="this.parentElement.style.display='none'" style="position: absolute; top: 8px; right: 12px; background: transparent; border: none; cursor: pointer; color: #b91c1c; font-size: 20px; font-weight: 700; opacity: 0.5;">×</button>
      <div id="revenue-loss-content"></div>
    </div>


    <!-- Distribution comparison -->
    <div class="distribution-box result-stagger-3" id="distribution-box" style="display:none;">
      <div class="dist-header">
        <span class="dist-label">Podobné lekárne (<span id="dist-count">0</span>)</span>
      </div>
      <div class="dist-bar-container" id="dist-bar-container">
        <div class="dist-bar-bg"></div>
        <div class="dist-bar-range" id="dist-range"></div>
        <div id="dist-actuals"></div>
        <div class="dist-marker" id="dist-marker"></div>
      </div>
      <div class="dist-labels">
        <span id="dist-min">-</span>
        <span id="dist-max">-</span>
      </div>
    </div>

    <div class="breakdown result-stagger-4">
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-zf">-</div>
        <div class="breakdown-lbl">Zodp. farm.</div>
        <div class="breakdown-pct" id="pct-zf"></div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-f">-</div>
        <div class="breakdown-lbl">Farmaceut</div>
        <div class="breakdown-pct" id="pct-f"></div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-l">-</div>
        <div class="breakdown-lbl">Laborant</div>
        <div class="breakdown-pct" id="pct-l"></div>
      </div>
      <div class="breakdown-item breakdown-zastup" id="breakdown-zastup" style="display:none;">
        <div class="breakdown-val" id="fte-zastup">-</div>
        <div class="breakdown-lbl">Zástup</div>
        <div class="breakdown-pct" id="pct-zastup"></div>
      </div>
    </div>

    <div class="trust-box result-stagger-5" id="trust-box">
      <div class="trust-title">Overené proti podobným lekárňam</div>
      <div class="trust-content">Nájdené prevádzky: <span id="trust-count"></span></div>
      <div class="trust-content">ID: <span id="trust-ids"></span><span id="trust-expand" class="trust-link" style="display:none;" onclick="expandIds()"> zobraziť všetky</span></div>
      <div id="trust-all-ids" style="display:none;margin-top:8px;font-size:0.8rem;color:#6b7280;word-break:break-word;"></div>
    </div>

    <!-- Next Action - Gentle ending -->
    <div class="next-action result-stagger-5" id="next-action">
      Chcete skontrolovať ďalšiu lekáreň?<a href="javascript:void(0)" onclick="analyzeAnother()">Vybrať →</a>
    </div>

  </div>
  </div>
  <!-- END CALCULATOR TAB -->

  <!-- NETWORK TAB (Priority Dashboard) -->
  <div id="tab-network" class="tab-content">
    <div id="network-loading" class="loading-spinner">Pripravujem prehľad siete...</div>

    <div id="network-content" style="display:none;">
      <!-- Hero Stat - Revenue at Risk -->
      <div class="hero-stat" id="hero-revenue">
        <div class="hero-stat-label">Ohrozené tržby</div>
        <div class="hero-stat-value" id="net-revenue-at-risk">-</div>
        <div class="hero-stat-detail" id="hero-revenue-detail">-</div>
      </div>

      <!-- Quick Stats Row -->
      <div class="quick-stats">
        <div class="quick-stat urgent">
          <div class="quick-stat-value" id="net-urgent-count">-</div>
          <div class="quick-stat-label">Ohrozené tržby</div>
        </div>
        <div class="quick-stat monitor">
          <div class="quick-stat-value" id="net-monitor-count">-</div>
          <div class="quick-stat-label">Rastový signál</div>
        </div>
        <div class="quick-stat optimize">
          <div class="quick-stat-value" id="net-optimize-count">-</div>
          <div class="quick-stat-label">Prebytok FTE</div>
        </div>
      </div>

      <!-- Priority Sections -->
      <div class="card priority-card">
        <div class="card-title" style="margin-bottom:16px">Kde konať</div>

        <!-- URGENT: Understaffed + High Productivity = Losing Revenue -->
        <div class="priority-section priority-urgent-section">
          <div class="priority-header" onclick="togglePriority('urgent')">
            <span class="priority-icon urgent">!</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                OHROZENÉ TRŽBY
                <span class="priority-count" id="priority-urgent-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('urgent')">CSV</button>
              </h4>
              <span class="priority-subtitle">Nedostatok personálu pri vysokej produktivite</span>
            </div>
            <span class="priority-total urgent" id="priority-urgent-total">-</span>
            <span class="priority-arrow" id="urgent-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-urgent-list"></div>
        </div>

        <!-- MONITOR: Growing = Watch for Future -->
        <div class="priority-section priority-monitor-section">
          <div class="priority-header" onclick="togglePriority('monitor')">
            <span class="priority-icon monitor">↑</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                RASTOVÝ SIGNÁL
                <span class="priority-count" id="priority-monitor-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('monitor')">CSV</button>
              </h4>
              <span class="priority-subtitle">Rýchlo rastúce lekárne — pripravte sa na budúce potreby</span>
            </div>
            <span class="priority-total monitor" id="priority-monitor-total">-</span>
            <span class="priority-arrow" id="monitor-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-monitor-list"></div>
        </div>

        <!-- OPTIMIZE: Overstaffed = Can Reallocate -->
        <div class="priority-section priority-optimize-section">
          <div class="priority-header" onclick="togglePriority('optimize')">
            <span class="priority-icon optimize">↓</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                PREBYTOK FTE
                <span class="priority-count" id="priority-optimize-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('optimize')">CSV</button>
              </h4>
              <span class="priority-subtitle">Prebytok personálu — príležitosť na prerozdelenie</span>
            </div>
            <span class="priority-total optimize" id="priority-optimize-total">-</span>
            <span class="priority-arrow" id="optimize-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-optimize-list"></div>
        </div>
      </div>

      <!-- Segment Summary (collapsed by default) -->
      <div class="card" style="background:var(--bg-subtle);border:1px dashed var(--border-medium);">
        <div class="card-title" style="cursor:pointer;" onclick="toggleSegmentTable()">
          FTE podľa segmentu <span id="segment-toggle-arrow" style="float:right;">▶</span>
        </div>
        <div id="segment-table-container" style="display:none;">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">
            Stály personál <span style="color:#1e40af;font-weight:600;">+ zástup</span> = spolu vs. optimálne FTE. Rozdiel = spolu mínus optimálne.
          </div>
          <table class="segment-table">
            <thead>
              <tr>
                <th>Segment</th>
                <th>Počet</th>
                <th title="Stály personál (bez zástupov)">Stály</th>
                <th title="Zástup = personál zapožičaný z inej lekárne" class="zastup-header">+ Zástup</th>
                <th title="Stály + Zástup">=&nbsp;Spolu</th>
                <th>Optimálne</th>
                <th title="Spolu mínus Optimálne">Rozdiel</th>
              </tr>
            </thead>
            <tbody id="segment-tbody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Model Info Card (collapsed by default) -->
      <div class="card" style="background:var(--bg-subtle);border:1px dashed var(--border-medium);">
        <div class="card-title" style="cursor:pointer;" onclick="toggleModelInfo()">
          O modeli <span id="model-info-arrow" style="float:right;">▶</span>
        </div>
        <div id="model-info-container" style="display:none;">
          <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;">
            <p style="margin-bottom:12px;">
              <strong>Model:</strong> ML regresný model (v5)<br>
              <strong>Presnosť:</strong> Vysoká (R² > 90%)
            </p>
            <p style="margin-bottom:12px;">
              <strong>Vstupné parametre:</strong>
            </p>
            <ul style="margin:0 0 12px 20px;padding:0;">
              <li>Objem transakcií</li>
              <li>Tržby</li>
              <li>Typ lekárne (segment)</li>
              <li>Podiel Rx receptov</li>
              <li>Produktivita vs. segment</li>
            </ul>
            <p style="margin-bottom:0;">
              <strong>Férový princíp:</strong><br>
              Efektívne lekárne sú odmenené.<br>
              Menej efektívne nie sú penalizované.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- END NETWORK TAB -->

  <!-- ANALYZA TAB -->
  <div id="tab-analyza" class="tab-content">
    <div id="analyza-empty" class="card" style="text-align:center;padding:40px;">
      <div style="font-size:2rem;margin-bottom:12px;opacity:0.5;">📊</div>
      <div style="color:var(--text-muted);">Najprv vypočítajte FTE v záložke Kalkulačka</div>
    </div>

    <div id="analyza-content" style="display:none;">
      <!-- Revenue Trend Chart -->
      <div class="card" id="trend-chart-card" style="display:none;">
        <div class="card-title">TREND TRŽIEB</div>

        <!-- YoY Stats -->
        <div class="trend-yoy-stats">
          <div class="trend-yoy-item">
            <div class="trend-yoy-label">2021 vs 2020</div>
            <div class="trend-yoy-value" id="trend-yoy-2021">-</div>
          </div>
          <div class="trend-yoy-item">
            <div class="trend-yoy-label">2020 vs 2019</div>
            <div class="trend-yoy-value" id="trend-yoy-2020">-</div>
          </div>
        </div>

        <!-- Chart -->
        <div class="trend-chart-container">
          <svg class="trend-chart-svg" id="trend-chart" viewBox="0 0 580 240" preserveAspectRatio="xMidYMid meet">
          </svg>
          <div class="trend-tooltip" id="trend-tooltip"></div>
          <div class="trend-crosshair-tooltip" id="trend-crosshair-tooltip"></div>
        </div>
      </div>

      <!-- Segment Position Charts -->
      <div class="card">
        <div class="card-title">Pozícia v segmente</div>

        <div class="position-charts">
          <!-- Produktivita zone indicator (moved to top) -->
          <div class="position-row" id="row-efficiency">
            <div class="position-label">Produktivita</div>
            <div class="position-track-wrapper">
              <div class="position-track zone-track">
                <div class="zone zone-low"></div>
                <div class="zone zone-avg"></div>
                <div class="zone zone-high"></div>
                <div class="position-marker you" id="pos-efficiency-you"></div>
              </div>
              <div class="track-labels">
                <span>Nízka</span>
                <span>Priemerná</span>
                <span>Vysoká</span>
              </div>
            </div>
            <div class="position-result" id="pos-efficiency-result">
              <div class="position-value zone-label" id="pos-efficiency-value">-</div>
              <div class="position-indicator neutral" id="pos-efficiency-indicator">≈</div>
              <div class="position-tooltip" id="pos-efficiency-tooltip"></div>
            </div>
          </div>

          <!-- Bloky position -->
          <div class="position-row" id="row-bloky">
            <div class="position-label">Bloky</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-bloky"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-bloky-avg"></div>
                <div class="position-marker you" id="pos-bloky-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-bloky-min">0</span>
                <span id="pos-bloky-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-bloky-result">
              <div class="position-value" id="pos-bloky-value">-</div>
              <div class="position-indicator neutral" id="pos-bloky-indicator">≈</div>
              <div class="position-tooltip" id="pos-bloky-tooltip"></div>
            </div>
          </div>

          <!-- Tržby position -->
          <div class="position-row" id="row-trzby">
            <div class="position-label">Tržby</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-trzby"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-trzby-avg"></div>
                <div class="position-marker you" id="pos-trzby-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-trzby-min">0</span>
                <span id="pos-trzby-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-trzby-result">
              <div class="position-value" id="pos-trzby-value">-</div>
              <div class="position-indicator neutral" id="pos-trzby-indicator">≈</div>
              <div class="position-tooltip" id="pos-trzby-tooltip"></div>
            </div>
          </div>

          <!-- Rx position -->
          <div class="position-row" id="row-rx">
            <div class="position-label">Rx %</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-rx"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-rx-avg"></div>
                <div class="position-marker you" id="pos-rx-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-rx-min">0</span>
                <span id="pos-rx-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-rx-result">
              <div class="position-value" id="pos-rx-value">-</div>
              <div class="position-indicator neutral" id="pos-rx-indicator">≈</div>
              <div class="position-tooltip" id="pos-rx-tooltip"></div>
            </div>
          </div>

          <!-- FTE position -->
          <div class="position-row" id="row-fte">
            <div class="position-label">FTE</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-fte"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-fte-avg"></div>
                <div class="position-marker you" id="pos-fte-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-fte-min">0</span>
                <span id="pos-fte-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-fte-result">
              <div class="position-value" id="pos-fte-value">-</div>
              <div class="position-indicator neutral" id="pos-fte-indicator">≈</div>
              <div class="position-tooltip" id="pos-fte-tooltip"></div>
            </div>
          </div>

          <!-- Bloky/hod position -->
          <div class="position-row" id="row-blokyhod">
            <div class="position-label">Bloky/h</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-blokyhod"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-blokyhod-avg"></div>
                <div class="position-marker you" id="pos-blokyhod-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-blokyhod-min">0</span>
                <span id="pos-blokyhod-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-blokyhod-result">
              <div class="position-value" id="pos-blokyhod-value">-</div>
              <div class="position-indicator neutral" id="pos-blokyhod-indicator">≈</div>
              <div class="position-tooltip" id="pos-blokyhod-tooltip"></div>
            </div>
          </div>

          <!-- Tržby/hod position -->
          <div class="position-row" id="row-trzbyhod">
            <div class="position-label">Tržby/h</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-trzbyhod"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-trzbyhod-avg"></div>
                <div class="position-marker you" id="pos-trzbyhod-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-trzbyhod-min">0</span>
                <span id="pos-trzbyhod-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-trzbyhod-result">
              <div class="position-value" id="pos-trzbyhod-value">-</div>
              <div class="position-indicator neutral" id="pos-trzbyhod-indicator">≈</div>
              <div class="position-tooltip" id="pos-trzbyhod-tooltip"></div>
            </div>
          </div>

          <!-- Košík position -->
          <div class="position-row" id="row-basket">
            <div class="position-label">Košík</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-basket"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-basket-avg"></div>
                <div class="position-marker you" id="pos-basket-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-basket-min">0</span>
                <span id="pos-basket-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-basket-result">
              <div class="position-value" id="pos-basket-value">-</div>
              <div class="position-indicator neutral" id="pos-basket-indicator">≈</div>
              <div class="position-tooltip" id="pos-basket-tooltip"></div>
            </div>
          </div>
        </div>

        <div class="position-legend">
          <span class="legend-item"><span class="legend-dot avg"></span> Priemer segmentu</span>
          <span class="legend-item"><span class="legend-dot you"></span> Vaša lekáreň</span>
        </div>
      </div>

      <!-- Simulation - Unified with position charts -->
      <div class="card">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
          Simulácia zmien
          <button class="sim-reset-btn" id="sim-reset-btn">Reset</button>
        </div>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:20px;">
          Ako by sa zmenilo odporúčané FTE pri zmene parametrov
        </p>

        <div class="sim-charts">
          <!-- Tržby row -->
          <div class="sim-section">
            <div class="sim-row">
              <div class="sim-label">Tržby <span class="sim-input-value" id="sens-trzby-val"></span></div>
              <div class="sim-slider-wrap">
                <input type="range" class="sim-slider" id="sens-trzby" min="-20" max="30" value="0">
                <div class="sim-range-labels">
                  <span>-20%</span>
                  <span>0%</span>
                  <span>+30%</span>
                </div>
              </div>
              <div class="sim-result" id="sens-trzby-result">
                <div class="sim-result-value" id="sens-trzby-fte">0.0</div>
                <div class="sim-result-indicator"></div>
              </div>
            </div>
          </div>

          <!-- Produktivita row -->
          <div class="sim-section">
            <div class="sim-row">
              <div class="sim-label">Produktivita <span class="sim-input-value" id="sens-prod-val"></span></div>
              <div class="sim-slider-wrap">
                <input type="range" class="sim-slider" id="sens-prod" min="0" max="20" value="0">
                <div class="sim-range-labels">
                  <span>Priemer</span>
                  <span>+1σ</span>
                  <span>+2σ</span>
                </div>
              </div>
              <div class="sim-result zero" id="sens-prod-result">
                <div class="sim-result-value" id="sens-prod-fte">0.0</div>
                <div class="sim-result-indicator"></div>
              </div>
            </div>
          </div>

          <!-- Summary row -->
          <div class="sim-summary">
            <div class="sim-summary-label">Celkom</div>
            <div class="sim-summary-breakdown">
              <span id="sens-base-fte">0.0</span>
              <span class="sim-summary-arrow">→</span>
              <span class="sim-summary-new" id="sens-new-fte">0.0</span>
            </div>
            <div class="sim-summary-value" id="sens-total-fte">0.0 FTE</div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- END ANALYZA TAB -->

  <!-- AI AGENT TAB -->
  <div id="tab-agent" class="tab-content">
    <div class="agent-container">

      <!-- Simplified Input Area -->
      <div class="agent-search-bar">
        <input type="text" id="agent-input" placeholder="Opýtajte sa na čokoľvek o personálnom obsadení...">
        <button id="agent-submit" class="agent-search-btn" title="Odoslať">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>

      <!-- Results Area -->
      <div class="agent-results" id="agent-results">
        <div class="agent-welcome" id="agent-welcome">

          <!-- ML & AI Intro Panel - Expandable -->
          <div class="intro-panel" id="intro-panel">
            <button class="intro-panel-toggle" id="intro-panel-toggle">
              <div class="intro-panel-header">
                <span class="intro-panel-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg></span>
                <h4 class="intro-panel-title">Intuícia vs. dáta: Čomu veríte pri obsadzovaní?</h4>
              </div>
              <svg class="intro-panel-chevron" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            </button>
            <div class="intro-panel-content">
              <div class="intro-panel-story">
                <p>3 regióny, 200+ lekární, ale <strong>žiadna jednotná metodológia</strong> personálneho obsadenia. Rozhodnutia na základe intuície. Pritom práve farmaceuti a špecializovaný personál sú limitujúcim faktorom rastu.</p>

                <div class="intro-panel-highlight">
                  <strong>ML model</strong> nahrádza intuíciu dátami - analyzuje tržby, bloky, produktivitu a predpovedá optimálne FTE.<br>
                  <strong>AI asistent</strong> sprístupňuje tieto dáta v reálnom čase.
                </div>

                <p><strong>Jednotná metodológia</strong> pre celú sieť. Dáta hovoria jasne - kde pridať, kde presunúť, aký je prínos rozhodnutia.</p>

                <button class="intro-panel-cta" data-query="Ukáž mi prehľad siete a kde sú najväčšie príležitosti na zlepšenie">
                  <span>Ukáž mi to na mojich dátach</span>
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Drill-Down Question Hierarchy -->

          <!-- Level 1: SIEŤ -->
          <div class="question-section">
            <div class="section-header">
              <span class="section-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg></span>
              <span class="section-title">Sieť</span>
            </div>
            <div class="question-buttons">
              <button class="sample-question" data-query="Kde strácame najviac tržieb?">
                <span class="sample-text">Kde strácame tržby?</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Ukáž mi najurgentnejšie prípady v sieti">
                <span class="sample-text">Najurgentnejšie prípady</span>
                <span class="sample-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Level 2: SEGMENTY -->
          <div class="question-section">
            <div class="section-header">
              <span class="section-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg></span>
              <span class="section-title">Segmenty</span>
            </div>
            <div class="question-buttons">
              <button class="sample-question" data-query="Ktorý segment má najväčšie riziko?">
                <span class="sample-text">Ktorý segment má najväčšie riziko?</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Porovnanie segmentov A-E">
                <span class="sample-text">Porovnanie segmentov A-E</span>
                <span class="sample-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Level 3: REGIÓNY -->
          <div class="question-section">
            <div class="section-header">
              <span class="section-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg></span>
              <span class="section-title">Regióny</span>
            </div>
            <div class="question-buttons">
              <button class="sample-question" data-query="Aké sú problémy v regióne RR11?">
                <span class="sample-text">Problémy v mojom regióne</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Porovnaj výkonnosť všetkých regiónov">
                <span class="sample-text">Porovnaj všetky regióny</span>
                <span class="sample-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Level 4: LEKÁRNE -->
          <div class="question-section">
            <div class="section-header">
              <span class="section-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="4" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg></span>
              <span class="section-title">Lekárne</span>
            </div>
            <div class="question-buttons">
              <button class="sample-question" data-query="Top 10 lekární na riešenie">
                <span class="sample-text">Top 10 lekární na riešenie</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Ktoré lekárne v Košiciach potrebujú personál?">
                <span class="sample-text">Lekárne v meste potrebujúce personál</span>
                <span class="sample-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Toggle for more tools -->
          <button class="tools-toggle" id="tools-toggle">
            <span>Ďalšie možnosti</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 10l5 5 5-5H7z"/>
            </svg>
          </button>

          <!-- Extra Tools (hidden by default) -->
          <div class="tools-extra" id="tools-extra">
            <div class="question-buttons extra-questions">
              <button class="sample-question" data-query="Kde môžeme presunúť personál? Nájdi lekárne s prebytkom.">
                <span class="sample-text">Kde presunúť personál?</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Vygeneruj report za región RR11">
                <span class="sample-text">Generuj report za región</span>
                <span class="sample-arrow">→</span>
              </button>
              <button class="sample-question" data-query="Lekárne s prebytkom personálu, vysokým zástupom a produktivitou pod 110">
                <span class="sample-text">Prebytok + vysoký zástup</span>
                <span class="sample-arrow">→</span>
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
  <!-- END AGENT TAB -->

  <!-- ROZVRH TAB (Schedule Teaser) -->
  <div id="tab-rozvrh" class="tab-content">
    <div id="rozvrh-loading" class="loading-spinner">Analyzujem rozvrh...</div>

    <div id="rozvrh-content" style="display:none;">

      <!-- SECTION A: THE ANCHOR - Opportunity Number -->
      <div class="schedule-hero-loss">
        <div class="schedule-hero-pulse"></div>
        <div class="schedule-hero-label">
          <span class="schedule-hero-dot"></span>
          Potenciálne tržby tento mesiac
        </div>
        <div class="schedule-hero-value" id="schedule-total-loss">+0 €</div>
        <div class="schedule-hero-subtext">
          pri optimalizácii rozvrhu
        </div>
        <div class="schedule-hero-detail">
          <span class="schedule-detail-item">
            <span class="schedule-detail-num">29</span>
            <span class="schedule-detail-label">hodín na zlepšenie</span>
          </span>
          <span class="schedule-detail-divider"></span>
          <span class="schedule-detail-item">
            <span class="schedule-detail-num">5.3%</span>
            <span class="schedule-detail-label">kapacity na využitie</span>
          </span>
        </div>
      </div>

      <!-- SECTION B: Opportunity Heatmap -->
      <div class="card schedule-heatmap-card">
        <div class="card-title">
          <span class="title-icon">📈</span>
          Príležitosť podľa hodiny
          <span class="title-unit">€/mesiac</span>
        </div>

        <div class="schedule-heatmap-container">
          <div class="schedule-heatmap" id="schedule-heatmap">
            <!-- Header row -->
            <div class="schedule-heatmap-corner"></div>
            <div class="schedule-heatmap-hour">8</div>
            <div class="schedule-heatmap-hour">9</div>
            <div class="schedule-heatmap-hour">10</div>
            <div class="schedule-heatmap-hour">11</div>
            <div class="schedule-heatmap-hour">12</div>
            <div class="schedule-heatmap-hour">13</div>
            <div class="schedule-heatmap-hour">14</div>
            <div class="schedule-heatmap-hour">15</div>
            <div class="schedule-heatmap-hour">16</div>
            <div class="schedule-heatmap-hour">17</div>
            <div class="schedule-heatmap-hour">18</div>
            <div class="schedule-heatmap-hour">19</div>
            <!-- Rows will be generated by JavaScript -->
          </div>
        </div>

      </div>

      <!-- SECTION D: THE TEASER - Blurred Schedule Chart -->
      <div class="card schedule-teaser-card">
        <div class="schedule-teaser-header">
          <span class="schedule-teaser-title">Optimalizácia rozvrhu</span>
          <span class="schedule-teaser-badge">Pripravujeme</span>
        </div>

        <!-- Blurred Schedule Chart -->
        <div class="schedule-teaser-chart-wrap">
          <div class="schedule-teaser-chart">
            <!-- Chart header -->
            <div class="teaser-chart-row teaser-chart-header">
              <div class="teaser-chart-label"></div>
              <div class="teaser-chart-cell">8-11</div>
              <div class="teaser-chart-cell">11-14</div>
              <div class="teaser-chart-cell">14-17</div>
              <div class="teaser-chart-cell">17-20</div>
            </div>
            <!-- Chart rows with bar visualization -->
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">Po</div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:80%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:60%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">Ut</div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:90%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:85%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:55%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">St</div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:85%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:95%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:90%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:50%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">Št</div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:80%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:95%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:45%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">Pi</div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:75%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:100%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:60%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">So</div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:65%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:70%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar" style="width:80%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:40%"></div></div>
            </div>
            <div class="teaser-chart-row">
              <div class="teaser-chart-label">Ne</div>
              <div class="teaser-chart-cell"><div class="teaser-bar critical" style="width:45%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar critical" style="width:50%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:55%"></div></div>
              <div class="teaser-chart-cell"><div class="teaser-bar warn" style="width:40%"></div></div>
            </div>
          </div>

          <!-- Overlay with CTA -->
          <div class="schedule-teaser-overlay">
            <span class="teaser-lock-icon">🔒</span>
            <a href="mailto:marian.svatko@gmail.com?subject=Mám%20záujem%20o%20optimalizáciu%20rozvrhu&body=Dobrý%20deň,%0A%0Amám%20záujem%20o%20funkciu%20automatickej%20optimalizácie%20rozvrhu.%0A%0ADakujem" class="schedule-teaser-cta">
              <span>Mám záujem</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
            <span class="schedule-teaser-hint">Napíšte Mariánovi</span>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- END ROZVRH TAB -->

  <!-- FTE MANAGEMENT AUTOMATION TAB -->
  <div id="tab-vision" class="tab-content">

    <!-- Benefits Summary -->
    <div class="automation-benefits">
      <h3 class="automation-benefits-title">Prínosy automatizácie</h3>
      <div class="automation-benefits-stats">
        <div class="benefit-stat">
          <div class="benefit-stat-value">1-5%</div>
          <div class="benefit-stat-label">Ohrozené tržby</div>
        </div>
        <div class="benefit-stat">
          <div class="benefit-stat-value">min. 3.7M€</div>
          <div class="benefit-stat-label">Ročne</div>
        </div>
        <div class="benefit-stat">
          <div class="benefit-stat-value">90 dní</div>
          <div class="benefit-stat-label">Vyhodnotenie</div>
        </div>
      </div>
    </div>

    <!-- Autopilot Panel -->
    <div class="autopilot-card">
      <div class="autopilot-header">
        <div class="autopilot-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </div>
        <h3 class="autopilot-title">Mesačný Autopilot Režim</h3>
        <div class="autopilot-status">
          <span class="autopilot-status-dot"></span>
          Aktívny
        </div>
        <button class="btn-simulate" onclick="simulateAutopilot()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Simulovať
        </button>
      </div>

      <!-- 06:00 - Data Import -->
      <div class="schedule-group">
        <div class="schedule-group-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          06:00 - Import a validácia
        </div>
        <div class="schedule-items">
          <div class="schedule-item">
            <span class="schedule-item-status completed">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </span>
            <span class="schedule-item-text">Import mesačných dát z ERP</span>
            <span class="schedule-item-time">06:00</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status completed">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </span>
            <span class="schedule-item-text">Validácia dát: 286 lekární OK</span>
            <span class="schedule-item-time">06:02</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status completed">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </span>
            <span class="schedule-item-text">Detekcia anomálií: 3 upozornenia</span>
            <span class="schedule-item-time">06:03</span>
          </div>
        </div>
      </div>

      <!-- 06:05 - Analysis -->
      <div class="schedule-group">
        <div class="schedule-group-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          06:05 - Analýza a predikcie
        </div>
        <div class="schedule-items">
          <div class="schedule-item">
            <span class="schedule-item-status running">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
            </span>
            <span class="schedule-item-text">Prepočet FTE pre 286 lekární</span>
            <span class="schedule-item-time">prebieha</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status pending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
              </svg>
            </span>
            <span class="schedule-item-text">Porovnanie predikcie vs. realita (M-1)</span>
            <span class="schedule-item-time">06:08</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status pending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
              </svg>
            </span>
            <span class="schedule-item-text">Identifikácia Top 10 príležitostí</span>
            <span class="schedule-item-time">06:10</span>
          </div>
        </div>
      </div>

      <!-- 06:12 - Reporting -->
      <div class="schedule-group">
        <div class="schedule-group-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          06:12 - Reporty a notifikácie
        </div>
        <div class="schedule-items">
          <div class="schedule-item">
            <span class="schedule-item-status pending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
              </svg>
            </span>
            <span class="schedule-item-text">Executive summary pre vedenie</span>
            <span class="schedule-item-time">06:12</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status pending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
              </svg>
            </span>
            <span class="schedule-item-text">Regionálne reporty (email)</span>
            <span class="schedule-item-time">06:14</span>
          </div>
          <div class="schedule-item">
            <span class="schedule-item-status pending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
              </svg>
            </span>
            <span class="schedule-item-text">Slack notifikácie manažérom</span>
            <span class="schedule-item-time">06:15</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Workflow -->
    <div class="workflow-card">
      <div class="workflow-header">
        <div class="workflow-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a10 10 0 1 0 10 10H12V2z"/>
            <path d="M12 2a10 10 0 0 1 10 10"/>
            <circle cx="12" cy="12" r="6"/>
            <circle cx="12" cy="12" r="2"/>
          </svg>
        </div>
        <h3 class="workflow-title">Agent Pipeline</h3>
      </div>

      <div class="workflow-pipeline">
        <div class="workflow-stage completed">
          <div class="workflow-stage-circle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
          </div>
          <span class="workflow-stage-label">Planner</span>
        </div>

        <div class="workflow-stage active">
          <div class="workflow-stage-circle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
          </div>
          <span class="workflow-stage-label">Analyzer</span>
        </div>

        <div class="workflow-stage">
          <div class="workflow-stage-circle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
          </div>
          <span class="workflow-stage-label">Reviewer</span>
        </div>
      </div>
    </div>

    <!-- Feedback Loop - Complete Cycle -->
    <div class="workflow-card feedback-cycle-card">
      <div class="workflow-header">
        <div class="workflow-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/>
            <polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
        </div>
        <h3 class="workflow-title">Uzavretý Cyklus Zlepšovania</h3>
      </div>

      <!-- Cycle Steps -->
      <div class="feedback-cycle-steps">
        <div class="cycle-step">
          <div class="cycle-step-number">1</div>
          <div class="cycle-step-content">
            <div class="cycle-step-title">Odporúčanie</div>
            <div class="cycle-step-desc">Model identifikuje potrebu +0.5 FTE</div>
          </div>
        </div>
        <div class="cycle-step">
          <div class="cycle-step-number">2</div>
          <div class="cycle-step-content">
            <div class="cycle-step-title">Implementácia</div>
            <div class="cycle-step-desc">Prevádzka pridá zamestnanca na špičkové hodiny</div>
          </div>
        </div>
        <div class="cycle-step">
          <div class="cycle-step-number">3</div>
          <div class="cycle-step-content">
            <div class="cycle-step-title">Monitoring</div>
            <div class="cycle-step-desc">Sledovanie tržieb a produktivity (90 dní)</div>
          </div>
        </div>
        <div class="cycle-step">
          <div class="cycle-step-number">4</div>
          <div class="cycle-step-content">
            <div class="cycle-step-title">Vyhodnotenie</div>
            <div class="cycle-step-desc">Porovnanie predikcie so skutočnosťou</div>
          </div>
        </div>
        <div class="cycle-step">
          <div class="cycle-step-number">5</div>
          <div class="cycle-step-content">
            <div class="cycle-step-title">Spätná väzba</div>
            <div class="cycle-step-desc">Zlepšenie modelu → presnejšie predikcie</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Integrations -->
    <div class="integrations-card">
      <div class="integrations-header">
        <div class="integrations-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="2" width="20" height="8" rx="2"/>
            <rect x="2" y="14" width="20" height="8" rx="2"/>
            <line x1="6" y1="6" x2="6.01" y2="6"/>
            <line x1="6" y1="18" x2="6.01" y2="18"/>
          </svg>
        </div>
        <h3 class="integrations-title">Možné Integrácie</h3>
      </div>

      <!-- Data Sources -->
      <div class="integrations-section">
        <div class="integrations-section-title">Zdroje Dát</div>
        <div class="integrations-grid">
          <div class="integration-item">
            <span class="integration-status ready"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#4285F4">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </div>
            <span class="integration-name">BigQuery</span>
          </div>
          <div class="integration-item">
            <span class="integration-status planned"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#0FAAFF">
                <path d="M12.001 2.571L3.857 8.286v7.428L12 21.43l8.143-5.715V8.286L12.001 2.571zm5.143 11.715l-5.143 3.428-5.143-3.428V9.714L12 6.286l5.143 3.428v4.572z"/>
              </svg>
            </div>
            <span class="integration-name">SAP HR</span>
          </div>
          <div class="integration-item">
            <span class="integration-status future"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#6B7280">
                <rect x="2" y="4" width="20" height="16" rx="2"/>
                <line x1="6" y1="8" x2="6" y2="8.01" stroke-width="2"/>
                <line x1="6" y1="12" x2="18" y2="12"/>
                <line x1="6" y1="16" x2="14" y2="16"/>
              </svg>
            </div>
            <span class="integration-name">POS Live</span>
          </div>
        </div>
      </div>

      <!-- Outputs -->
      <div class="integrations-section">
        <div class="integrations-section-title">Výstupy</div>
        <div class="integrations-grid">
          <div class="integration-item">
            <span class="integration-status planned"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#E01E5A">
                <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zm10.124 2.521a2.528 2.528 0 0 1 2.52-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.52V8.834zm-1.271 0a2.528 2.528 0 0 1-2.521 2.521 2.528 2.528 0 0 1-2.521-2.521V2.522A2.528 2.528 0 0 1 15.166 0a2.528 2.528 0 0 1 2.521 2.522v6.312zm-2.521 10.124a2.528 2.528 0 0 1 2.521 2.52A2.528 2.528 0 0 1 15.166 24a2.528 2.528 0 0 1-2.521-2.522v-2.52h2.521zm0-1.271a2.528 2.528 0 0 1-2.521-2.521 2.528 2.528 0 0 1 2.521-2.521h6.312A2.528 2.528 0 0 1 24 15.166a2.528 2.528 0 0 1-2.522 2.521h-6.312z"/>
              </svg>
            </div>
            <span class="integration-name">Slack</span>
          </div>
          <div class="integration-item">
            <span class="integration-status ready"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#EA4335">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
            </div>
            <span class="integration-name">Email</span>
          </div>
          <div class="integration-item">
            <span class="integration-status planned"></span>
            <div class="integration-logo">
              <svg viewBox="0 0 24 24" width="28" height="28" fill="#F2C811">
                <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM10 17H5v-2h5v2zm0-4H5v-2h5v2zm0-4H5V7h5v2zm9 8h-7V7h7v10z"/>
              </svg>
            </div>
            <span class="integration-name">Power BI</span>
          </div>
        </div>
      </div>

    </div>

    <!-- CTA -->
    <a href="mailto:marian.svatko@gmail.com?subject=Mám%20záujem%20o%20produkčnú%20implementáciu&body=Dobrý%20deň,%0A%0Amám%20záujem%20o%20produkčnú%20implementáciu%20AI-riadeného%20FTE%20systému.%0A%0ADakujem" class="vision-cta">
      <span>Mám záujem</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </a>

  </div>
  <!-- END PRODUCTION VISION TAB -->

</div>

<!-- AI Chat Assistant -->
<button class="chat-trigger" id="chat-trigger" title="Opýtať sa AI">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
  </svg>
</button>

<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>FTE AI Asistent</h3>
    <button class="chat-close" id="chat-close">&times;</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-message assistant">
      <div class="bubble">Dobrý deň, som váš FTE AI asistent. Môžem vysvetliť výpočet alebo odpovedať na otázky o personálnom odporúčaní.</div>
    </div>
  </div>
  <div class="chat-suggestions" id="chat-suggestions">
    <button class="chat-suggestion" data-q="Vysvetli stav personálneho obsadenia uvedenej lekárne">Vysvetli stav lekárne</button>
    <button class="chat-suggestion" data-q="Uveď 5 lekární v segmente výkonom podobné uvedenej lekárne, ktoré majú viac FTE">Podobné s vyšším FTE</button>
  </div>
  <!-- Agent mode suggestions (hidden by default) -->
  <div class="chat-suggestions agent-suggestions" id="agent-suggestions" style="display:none;">
    <button class="chat-suggestion agent" data-q="Analyzuj všetky poddimenzované lekárne v regióne RR11 a vygeneruj report">Regionálna analýza</button>
    <button class="chat-suggestion agent" data-q="Nájdi 10 lekární s najvyššími ohrozenými tržbami a porovnaj ich s podobnými">Top 10 ohrozených</button>
    <button class="chat-suggestion agent" data-q="Vytvor report porovnania lekární ID 33, 36, 54 vrátane odporúčaní">Porovnávací report</button>
  </div>
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chat-input" placeholder="Napíšte otázku...">
    <button class="chat-send" id="chat-send">&#10148;</button>
  </div>
</div>

<script>
// Toast notification helper
function showToast(message, type = 'error', duration = 4000) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

const bloky = document.getElementById("bloky");
const trzby = document.getElementById("trzby");
const rxInput = document.getElementById("rx");
const calcBtn = document.getElementById("calc");
const typSelect = document.getElementById("typ");
const pharmacyIdInput = document.getElementById("pharmacy-id-input");
const pharmacyLoadBtn = document.getElementById("pharmacy-load-btn");

// Productivity toggle (segmented control)
let selectedProductivityZ = 0;  // Default: average
const prodToggleHigh = document.getElementById('prod-high');
const prodToggleAvg = document.getElementById('prod-avg');

// Helper to check if high productivity is selected
function isProdHigh() {
  return prodToggleHigh.checked;
}

// Listen to both radio buttons
[prodToggleHigh, prodToggleAvg].forEach(radio => {
  radio.addEventListener('change', () => {
    selectedProductivityZ = isProdHigh() ? 1 : 0;
  // Clear pre-calculated FTE so fresh prediction with new productivity is used
  window.selectedPharmacyData = null;
  // Update efficiency zone indicator in Analýza tab
  updateEfficiencyIndicator();
    // Auto-recalculate if result is already visible
    if (document.getElementById("result").style.display !== "none") {
      calcBtn.click();
    }
  });
});

function updateEfficiencyIndicator() {
  const marker = document.getElementById('pos-efficiency-you');
  const valueEl = document.getElementById('pos-efficiency-value');
  const indicatorEl = document.getElementById('pos-efficiency-indicator');
  const tooltipEl = document.getElementById('pos-efficiency-tooltip');

  if (marker && valueEl) {
    const pct = window.pharmacyProdPct || 0;

    let zoneLabel, zoneClass, indicatorClass, indicatorSymbol, tooltipText;

    if (isProdHigh()) {
      // Above average: centered in right zone (66.7-100%)
      marker.style.left = '83.3%';
      zoneLabel = 'Vysoká';
      zoneClass = 'high';
      indicatorClass = 'positive';
      indicatorSymbol = '↑';
      tooltipText = 'Nadpriemerná produktivita v segmente';
    } else if (pct < 0) {
      // Below average: left zone (0-33.3%)
      marker.style.left = '16.7%';
      zoneLabel = 'Nízka';
      zoneClass = 'low';
      indicatorClass = 'negative';
      indicatorSymbol = '↓';
      tooltipText = 'Podpriemerná produktivita v segmente';
    } else {
      // Average: middle zone (33.3-66.7%)
      marker.style.left = '50%';
      zoneLabel = 'Priemerná';
      zoneClass = 'avg';
      indicatorClass = 'neutral';
      indicatorSymbol = '≈';
      tooltipText = 'Priemerná produktivita v segmente';
    }

    valueEl.textContent = zoneLabel;
    valueEl.className = `position-value zone-label ${zoneClass}`;

    if (indicatorEl) {
      indicatorEl.className = `position-indicator ${indicatorClass}`;
      indicatorEl.textContent = indicatorSymbol;
    }

    if (tooltipEl) {
      tooltipEl.textContent = tooltipText;
    }
  }
}

function updateTrendIndicator() {
  const marker = document.getElementById('pos-trend-you');
  const valueEl = document.getElementById('pos-trend-value');
  const indicatorEl = document.getElementById('pos-trend-indicator');
  const tooltipEl = document.getElementById('pos-trend-tooltip');

  if (marker && valueEl) {
    const trendPct = window.pharmacyTrendPct || 0;
    const pctStr = trendPct > 0 ? `+${Math.round(trendPct)}%` : `${Math.round(trendPct)}%`;

    let zoneLabel, zoneClass, indicatorClass, indicatorSymbol, tooltipText;

    // Position marker in 3 zones based on trend threshold (±5%)
    if (trendPct < -5) {
      // Declining: left zone (0-33.3%)
      marker.style.left = '16.7%';
      zoneLabel = 'Klesajúci';
      zoneClass = 'declining';
      indicatorClass = 'negative';
      indicatorSymbol = '↓';
      tooltipText = `${pctStr} YoY · Klesajúci trend blokov`;
    } else if (trendPct > 5) {
      // Growing: right zone (66.7-100%)
      marker.style.left = '83.3%';
      zoneLabel = 'Rastúci';
      zoneClass = 'growing';
      indicatorClass = 'positive';
      indicatorSymbol = '↑';
      tooltipText = `${pctStr} YoY · Rastúci trend blokov`;
    } else {
      // Stable: middle zone (33.3-66.7%)
      marker.style.left = '50%';
      zoneLabel = 'Stabilný';
      zoneClass = 'stable';
      indicatorClass = 'neutral';
      indicatorSymbol = '≈';
      tooltipText = `${pctStr} YoY · Stabilný trend blokov`;
    }

    valueEl.textContent = zoneLabel;
    valueEl.className = `position-value zone-label ${zoneClass}`;

    if (indicatorEl) {
      indicatorEl.className = `position-indicator ${indicatorClass}`;
      indicatorEl.textContent = indicatorSymbol;
    }

    if (tooltipEl) {
      tooltipEl.textContent = tooltipText;
    }
  }
}

let allIds = [];
let selectedPharmacyId = null;

// Type-specific defaults (optimized for densest peer cluster)
const TYPE_DEFAULTS = {
  'A - shopping premium': {bloky: 93, trzby: 1.3, rx: 26},
  'B - shopping':         {bloky: 101, trzby: 1.7, rx: 49},
  'C - street +':         {bloky: 30, trzby: 0.6, rx: 67},
  'D - street':           {bloky: 28, trzby: 0.6, rx: 62},
  'E - poliklinika':      {bloky: 38, trzby: 1.0, rx: 78},
};

// ============================================
// PHARMACY SELECTOR
// ============================================
async function loadPharmacyById(pharmacyId) {
  const hint = document.getElementById('pharmacy-hint');
  hint.classList.remove('loaded', 'error');
  hint.textContent = 'Hľadám lekáreň...';

  try {
    const response = await fetch(`/api/pharmacy/${pharmacyId}`);
    if (!response.ok) {
      throw new Error('Pharmacy not found');
    }
    const data = await response.json();

    // Auto-fill form fields (display rounded values)
    typSelect.value = data.typ;
    bloky.value = Math.round(data.bloky / 1000); // Convert to thousands
    trzby.value = (data.trzby / 1000000).toFixed(1); // Convert to millions
    rxInput.value = Math.round(data.podiel_rx * 100);

    // Store pharmacy data including pre-calculated prediction (same as network)
    selectedPharmacyId = pharmacyId;
    window.selectedPharmacyActualFte = data.actual_fte;
    window.selectedPharmacyPredictedFte = data.predicted_fte;  // Store DB prediction for consistent loss calc (matches Sieť tab)
    window.selectedPharmacyIsAboveAvgProd = data.is_above_avg_productivity;  // Store separately (not nulled on calc)
    window.selectedPharmacyData = {
      mesto: data.mesto,
      bloky: data.bloky,
      trzby: data.trzby,
      podiel_rx: data.podiel_rx,
      predicted_fte: data.predicted_fte,
      predicted_fte_F: data.predicted_fte_F,
      predicted_fte_L: data.predicted_fte_L,
      predicted_fte_ZF: data.predicted_fte_ZF,
      actual_fte: data.actual_fte,
      fte_diff: data.fte_diff,
      is_above_avg_productivity: data.is_above_avg_productivity,
      revenue_at_risk: data.revenue_at_risk,
      bloky_trend: data.bloky_trend,
      hospital_supply: data.hospital_supply,
      zastup: data.zastup || 0,
      zastup_pct: data.zastup_pct || 0
    };
    window.selectedPharmacyExact = {
      bloky: data.bloky,
      trzby: data.trzby,
      podiel_rx: data.podiel_rx
    };

    // Auto-set productivity toggle based on pharmacy's actual productivity
    // Store the productivity percentage for display
    window.pharmacyProdPct = data.prod_pct || 0;
    window.pharmacyTrendPct = data.bloky_trend || 0;  // Store trend for display
    // Set the segmented control based on productivity
    if (data.is_above_avg_productivity) {
      prodToggleHigh.checked = true;
    } else {
      prodToggleAvg.checked = true;
    }
    selectedProductivityZ = data.is_above_avg_productivity ? 1 : 0;
    updateEfficiencyIndicator();
    updateTrendIndicator();

    // Update hint with success (include hospital badge if applicable)
    const hospitalBadge = data.hospital_supply ? ' <span class="hospital-badge" title="Zásobuje nemocnicu">H</span>' : '';
    hint.innerHTML = `${data.mesto}${hospitalBadge}`;
    hint.classList.add('loaded');

    // Load trend chart
    loadTrendChart(pharmacyId);

    // Auto-calculate
    calcBtn.click();

  } catch (error) {
    console.error('Error loading pharmacy:', error);
    hint.textContent = `ID ${pharmacyId} nenájdené`;
    hint.classList.add('error');
    showToast(`Lekáreň ID ${pharmacyId} nebola nájdená`);
    selectedPharmacyId = null;
    window.selectedPharmacyActualFte = null;
    window.selectedPharmacyPredictedFte = null;
    window.selectedPharmacyIsAboveAvgProd = null;
    window.selectedPharmacyData = null;
  }
}

pharmacyLoadBtn.onclick = () => {
  const id = parseInt(pharmacyIdInput.value);
  if (id && id > 0) {
    loadPharmacyById(id);
  }
};

// Allow Enter key to trigger load
pharmacyIdInput.onkeypress = (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    pharmacyLoadBtn.click();
  }
};

// "Nová lekáreň" button - reset form for new/pipeline pharmacy
document.getElementById('btn-new-pharmacy').addEventListener('click', function() {
  // Clear pharmacy ID
  document.getElementById('pharmacy-id-input').value = '';
  document.getElementById('pharmacy-hint').innerHTML = '';
  document.getElementById('pharmacy-hint').classList.remove('loaded', 'error');

  // Reset form fields
  document.getElementById('bloky').value = '';
  document.getElementById('trzby').value = '';
  document.getElementById('rx').value = 50;
  document.getElementById('typ').selectedIndex = 0;
  document.getElementById('prod-avg').checked = true;
  selectedProductivityZ = 0;

  // Hide results
  document.getElementById('result').style.display = 'none';

  // Reset Analýza tab
  document.getElementById('analyza-empty').style.display = 'flex';
  document.getElementById('analyza-content').style.display = 'none';

  // Clear stored data
  selectedPharmacyId = null;
  window.selectedPharmacyActualFte = null;
  window.selectedPharmacyPredictedFte = null;
  window.selectedPharmacyIsAboveAvgProd = null;
  window.selectedPharmacyData = null;
  window.pharmacyProdPct = null;

  // Focus on typ select for quick type selection
  document.getElementById('typ').focus();

  // Brief visual feedback
  showToast('Pripravené pre novú lekáreň', 'success', 2000);
});

// Type averages for new pharmacy auto-fill
const typeAverages = {
  'A - shopping premium': { bloky: 85000, trzby: 2100000, rx: 45 },
  'B - shopping': { bloky: 65000, trzby: 1400000, rx: 48 },
  'C - street +': { bloky: 35000, trzby: 750000, rx: 52 },
  'D - street': { bloky: 25000, trzby: 550000, rx: 55 },
  'E - poliklinika': { bloky: 40000, trzby: 900000, rx: 60 }
};

// Auto-fill when typ changes (only in new pharmacy mode)
document.getElementById('typ').addEventListener('change', function() {
  if (selectedPharmacyId === null) {
    const avg = typeAverages[this.value];
    if (avg) {
      document.getElementById('bloky').value = avg.bloky;
      document.getElementById('trzby').value = avg.trzby;
      document.getElementById('rx').value = avg.rx;
    }
  }
});

// Update actual FTE comparison in calculator tab
function updateActualFteCompare(recommendedFte) {
  const vsEl = document.getElementById('val-vs');
  const labelEl = document.getElementById('fte-label');
  const actualFte = window.selectedPharmacyActualFte;

  if (!actualFte) {
    vsEl.style.display = 'none';
    labelEl.textContent = 'Odporúčané FTE';
    return;
  }

  // Show actual FTE inline with recommended
  vsEl.style.display = 'flex';
  const actualParts = actualFte.toFixed(1).split('.');
  document.getElementById('fte-actual').innerHTML = actualParts[0] + '<span class="decimal">.' + actualParts[1] + '</span>';
  labelEl.innerHTML = 'Odporúčané vs <span style="color:rgba(0,0,0,0.5)">skutočné</span> FTE';
}

// Show revenue loss with Kahneman loss framing - THE PEAK MOMENT
// Enhanced with counting animation for dramatic effect
function showRevenueLoss(revenueAtRisk, trzby) {
  const lossEl = document.getElementById('revenue-loss');
  const contentEl = document.getElementById('revenue-loss-content');

  if (!revenueAtRisk || revenueAtRisk <= 0 || !trzby) {
    lossEl.style.display = 'none';
    return;
  }

  const lossPercent = ((revenueAtRisk / trzby) * 100).toFixed(1);
  const targetValue = Math.round(revenueAtRisk);

  // Set up the HTML structure with placeholder for counting
  contentEl.innerHTML = `
    <div class="revenue-loss-icon">⚠</div>
    <div class="revenue-loss-header">Ohrozené tržby</div>
    <div class="revenue-loss-value"><span class="currency">€</span><span id="revenue-count">0</span></div>
    <div class="revenue-loss-percent">${lossPercent}% ročných tržieb</div>
    <div class="revenue-loss-note">Kapacita tímu je prekročená</div>
  `;

  // Restart animation by forcing reflow
  lossEl.style.animation = 'none';
  lossEl.offsetHeight;
  lossEl.style.animation = '';
  lossEl.style.display = 'block';

  // Count-up animation for the revenue value
  const countEl = document.getElementById('revenue-count');
  const duration = 1200; // 1.2 seconds
  const startTime = performance.now();
  const easeOutQuart = t => 1 - Math.pow(1 - t, 4);

  function animateCount(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easeOutQuart(progress);
    const current = Math.round(targetValue * easedProgress);

    // Format with thousands separator
    countEl.textContent = current.toLocaleString('sk-SK');

    if (progress < 1) {
      requestAnimationFrame(animateCount);
    }
  }

  // Start counting after a brief delay for the card to appear
  setTimeout(() => requestAnimationFrame(animateCount), 500);
}

// Mark result as stale when inputs change (but keep visible)
function markResultStale() {
  const resultDiv = document.getElementById("result");
  if (resultDiv.style.display !== "none") {
    resultDiv.style.opacity = "0.6";
  }
}

// Reset result opacity when recalculated
function markResultFresh() {
  document.getElementById("result").style.opacity = "1";
}

// Update defaults when store type changes
function updateDefaults() {
  const defaults = TYPE_DEFAULTS[typSelect.value];
  if (defaults) {
    bloky.value = defaults.bloky;
    trzby.value = defaults.trzby;
    rxInput.value = defaults.rx;
  }
  markResultStale();
}

// Listen for store type changes (also clear pharmacy data)
typSelect.onchange = () => { window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; updateDefaults(); };

// Mark result stale when inputs change
// Also clear pharmacy data so manual input uses type-based factors
bloky.oninput = () => { markResultStale(); window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; };
trzby.oninput = () => { markResultStale(); window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; };
rxInput.oninput = () => {
  // Clamp value between 20-90
  const val = Math.max(20, Math.min(90, rxInput.value));
  rxInput.value = val;
  markResultStale();
  window.selectedPharmacyExact = null;
  window.selectedPharmacyData = null;
  selectedPharmacyId = null;
};

// Initialize with type-specific defaults
updateDefaults();

// Dismiss intro overlay and focus on pharmacy ID input
function dismissIntro() {
  const intro = document.getElementById('intro-overlay');
  intro.classList.add('hidden');

  // After transition, focus on pharmacy ID input with ready animation
  setTimeout(() => {
    intro.style.display = 'none';
    const input = document.getElementById('pharmacy-id-input');
    input.classList.add('ready');
    input.focus();
    setTimeout(() => input.classList.remove('ready'), 2000);
  }, 500);

  // Remember user has seen intro (persistent)
  localStorage.setItem('introSeen', 'true');
}

// Check if user has already seen intro
window.addEventListener('load', () => {
  if (localStorage.getItem('introSeen')) {
    const intro = document.getElementById('intro-overlay');
    intro.style.display = 'none';
    // Focus on pharmacy ID input
    setTimeout(() => {
      const input = document.getElementById('pharmacy-id-input');
      input.classList.add('ready');
      input.focus();
      setTimeout(() => input.classList.remove('ready'), 2000);
    }, 600);
  }
});

// Navigate back to pharmacy ID input
function analyzeAnother() {
  const input = document.getElementById('pharmacy-id-input');
  input.value = '';
  input.classList.add('ready');
  input.focus();
  input.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(() => input.classList.remove('ready'), 2000);

  // Clear previous data
  document.getElementById('pharmacy-hint').innerHTML = '';
  document.getElementById('pharmacy-hint').classList.remove('loaded', 'error');
}

// Switch to AI Assistant tab
function switchToAgentTab() {
  const agentTabBtn = document.querySelector('[data-tab="agent"]');
  if (agentTabBtn) {
    agentTabBtn.click();
    // Scroll to top and focus input
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      const agentInput = document.getElementById('agent-input');
      if (agentInput) agentInput.focus();
    }, 100);
  }
}

function expandIds() {
  document.getElementById("trust-ids").textContent = allIds.join(', ');
  document.getElementById("trust-expand").style.display = "none";
}

calcBtn.onclick = async () => {
  // Add loading state
  calcBtn.classList.add('loading');
  calcBtn.disabled = true;

  // Use exact values if pharmacy loaded, otherwise use form values
  const exact = window.selectedPharmacyExact;
  const pharmacyData = window.selectedPharmacyData;  // Pre-calculated FTE from pharmacy API
  const data = {
    typ: document.getElementById("typ").value,
    bloky: exact ? exact.bloky : +bloky.value * 1000,
    trzby: exact ? exact.trzby : +trzby.value * 1000000,
    podiel_rx: exact ? exact.podiel_rx : +rxInput.value / 100,
    productivity_z: selectedProductivityZ,  // From productivity buttons
    variability_z: 0,
    pharmacy_id: selectedPharmacyId
  };

  try {
    const r = await fetch('/api/predict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(r => r.json());

    // Show result and mark as fresh
    document.getElementById("result").style.display = "block";
    markResultFresh();

    // Use pre-calculated FTE if pharmacy loaded (consistent with network), otherwise use prediction
    const fteTotal = pharmacyData ? pharmacyData.predicted_fte : r.fte.total;
    const fteF = pharmacyData ? pharmacyData.predicted_fte_F : r.breakdown.F;
    const fteL = pharmacyData ? pharmacyData.predicted_fte_L : r.breakdown.L;
    const fteZF = pharmacyData ? pharmacyData.predicted_fte_ZF : r.breakdown.ZF;

    // Animate FTE count-up
    animateValue("fte-total", 0, fteTotal, 800);

    // Show range for all predictions
    document.getElementById("fte-range").textContent = `Rozsah: ${r.fte.min.toFixed(1)} – ${r.fte.max.toFixed(1)} FTE`;

    // Breakdown
    document.getElementById("fte-f").textContent = fteF.toFixed(1);
    document.getElementById("fte-l").textContent = fteL.toFixed(1);
    document.getElementById("fte-zf").textContent = fteZF.toFixed(1);

    // Breakdown percentages (shown on hover)
    const pctZF = ((fteZF / fteTotal) * 100).toFixed(0);
    const pctF = ((fteF / fteTotal) * 100).toFixed(0);
    const pctL = ((fteL / fteTotal) * 100).toFixed(0);
    document.getElementById("pct-zf").textContent = `${pctZF}% z celku`;
    document.getElementById("pct-f").textContent = `${pctF}% z celku`;
    document.getElementById("pct-l").textContent = `${pctL}% z celku`;

    // Zastup breakdown - show only for loaded pharmacies with zastup >= 0.1 FTE
    const zastupEl = document.getElementById("breakdown-zastup");
    const breakdownContainer = document.querySelector(".breakdown");
    const zastupData = window.selectedPharmacyData;
    if (zastupData && zastupData.zastup >= 0.1) {
      document.getElementById("fte-zastup").textContent = zastupData.zastup.toFixed(1);
      document.getElementById("pct-zastup").textContent = `${zastupData.zastup_pct.toFixed(0)}% z FTE`;
      zastupEl.style.display = "block";
      breakdownContainer.classList.add("has-zastup");
    } else {
      zastupEl.style.display = "none";
      breakdownContainer.classList.remove("has-zastup");
    }

    // Comparable count removed - field replaced with productivity toggle
    if (r.segment && r.benchmark) {
      document.getElementById("bloky-tooltip").textContent =
        `Segment (${r.benchmark.count}): ${r.segment.bloky_min} – ${r.segment.bloky_max} tis.`;
      document.getElementById("trzby-tooltip").textContent =
        `Segment (${r.benchmark.count}): ${r.segment.trzby_min} – ${r.segment.trzby_max} mil. €`;
    }

    // Trust box
    if (r.comparable.count > 0) {
      document.getElementById("trust-count").textContent = r.comparable.count;
      allIds = r.comparable.ids;
      if (allIds.length > 5) {
        document.getElementById("trust-ids").textContent = allIds.slice(0, 5).join(', ') + ', ...';
        document.getElementById("trust-expand").style.display = "inline";
      } else {
        document.getElementById("trust-ids").textContent = allIds.join(', ');
        document.getElementById("trust-expand").style.display = "none";
      }
      document.getElementById("trust-box").style.display = "block";
    } else {
      document.getElementById("trust-box").style.display = "none";
    }

    // Distribution visualization
    if (r.comparable.count > 0 && r.comparable.min_fte && r.comparable.max_fte) {
      const distBox = document.getElementById("distribution-box");
      const minFte = r.comparable.min_fte;
      const maxFte = r.comparable.max_fte;
      const recFte = r.fte.total;

      // Update labels
      document.getElementById("dist-count").textContent = r.comparable.count;
      document.getElementById("dist-min").textContent = minFte.toFixed(1) + " FTE";
      document.getElementById("dist-max").textContent = maxFte.toFixed(1) + " FTE";


      // Calculate marker position (0-100%)
      const range = maxFte - minFte;
      let markerPos;
      if (range > 0) {
        markerPos = ((recFte - minFte) / range) * 100;
        markerPos = Math.max(0, Math.min(100, markerPos)); // Clamp to 0-100%
      } else {
        markerPos = 50; // If all same, center it
      }

      // Set range bar to full width (min to max)
      document.getElementById("dist-range").style.left = "0%";
      document.getElementById("dist-range").style.width = "100%";

      // Render actual pharmacy markers (empty circles)
      const actualsContainer = document.getElementById("dist-actuals");
      actualsContainer.innerHTML = ''; // Clear previous
      if (r.comparable.fte_values && r.comparable.fte_values.length > 0) {
        r.comparable.fte_values.forEach(fte => {
          let pos = range > 0 ? ((fte - minFte) / range) * 100 : 50;
          pos = Math.max(0, Math.min(100, pos));
          const marker = document.createElement('div');
          marker.className = 'dist-marker-actual';
          marker.style.left = pos + '%';
          actualsContainer.appendChild(marker);
        });
      }

      // Set recommendation marker position (filled circle) with tooltip
      const recMarker = document.getElementById("dist-marker");
      recMarker.style.left = markerPos + "%";

      // Calculate rank among comparable pharmacies
      let rank = 1;
      if (r.comparable.fte_values && r.comparable.fte_values.length > 0) {
        rank = r.comparable.fte_values.filter(fte => fte < recFte).length + 1;
      }
      const total = r.comparable.count;
      recMarker.setAttribute("data-fte", `${recFte.toFixed(1)} FTE · ${rank}. z ${total}`);

      distBox.style.display = "block";
    } else {
      document.getElementById("distribution-box").style.display = "none";
    }

    // Store result for AI chat (pass displayed fteTotal for consistency)
    storeCalculationResult(r, data, fteTotal);

    // Update actual FTE comparison (if pharmacy loaded)
    updateActualFteCompare(fteTotal);

    // Show revenue loss (Kahneman loss framing) - THE PEAK
    // Use pre-calculated revenue_at_risk from pharmacy API when available
    const revenueAtRisk = window.selectedPharmacyData
      ? window.selectedPharmacyData.revenue_at_risk
      : r.revenue_at_risk;
    showRevenueLoss(revenueAtRisk, data.trzby);

    // Render sensitivity analysis
    if (r.sensitivity) {
      renderSensitivity(r.sensitivity);
    }

    // Render segment position charts
    if (r.segment) {
      renderPositionCharts(r.segment, r.hourly, data, data.typ);
    }

    // Render FTE position in segment (show actual FTE when pharmacy loaded, recommended otherwise)
    if (r.fte && r.benchmark) {
      const actualFte = pharmacyData ? pharmacyData.actual_fte : null;
      renderFteComparison(actualFte || fteTotal, r.benchmark, r.comparable, !!actualFte);
    }

    // Scroll to result smoothly
    document.getElementById("result").scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Pulse AI tab after a delay to suggest deeper exploration
    setTimeout(() => {
      const agentTab = document.querySelector('.tab-btn.agent-tab');
      if (agentTab) {
        agentTab.classList.add('pulse-hint');
        // Remove pulse after animation completes
        setTimeout(() => agentTab.classList.remove('pulse-hint'), 6000);
      }
    }, 2000);

  } catch (error) {
    console.error('Error:', error);
    showToast('Výpočet sa nepodaril. Skúste to znova.');
  } finally {
    // Remove loading state
    calcBtn.classList.remove('loading');
    calcBtn.disabled = false;
  }
};

// ============================================
// TAB NAVIGATION
// ============================================
let networkDataLoaded = false;

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    // Update active tab button
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Show corresponding content
    const tabId = btn.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');

    // Load network data on first view
    if (tabId === 'network' && !networkDataLoaded) {
      loadNetworkData();
    }

    // Load rozvrh data on first view
    if (tabId === 'rozvrh' && !rozvrhDataLoaded) {
      loadRozvrhData();
    }

    // Focus on pharmacy ID input when switching to calculator tab
    if (tabId === 'calculator') {
      const input = document.getElementById('pharmacy-id-input');
      // Small delay to let tab animation complete
      setTimeout(() => {
        input.classList.add('ready');
        input.focus();
        // Remove ready class after animation
        setTimeout(() => input.classList.remove('ready'), 2000);
      }, 150);
    }
  };
});

// ============================================
// NETWORK DASHBOARD
// ============================================
async function loadNetworkData() {
  const loadingEl = document.getElementById('network-loading');
  const contentEl = document.getElementById('network-content');
  
  loadingEl.style.display = 'flex';
  loadingEl.innerHTML = 'Pripravujem prehľad siete...';
  contentEl.style.display = 'none';

  try {
    const response = await fetch('/api/network');
    if (!response.ok) throw new Error('Network response was not ok');
    const data = await response.json();

    // Store data globally for CSV export
    window.networkData = data;

    // Priority Summary stats
    const priorities = data.priorities || {};
    const totalRevenueAtRisk = priorities.total_revenue_at_risk || 0;
    const urgentCount = priorities.urgent_count || 0;
    const monitorCount = priorities.monitor_count || 0;
    const optimizeCount = priorities.optimize_count || 0;

    // Format revenue at risk for hero stat
    const revenueText = totalRevenueAtRisk > 0
      ? (totalRevenueAtRisk >= 1000000
          ? `${(totalRevenueAtRisk / 1000000).toFixed(1)}M €`
          : `${Math.round(totalRevenueAtRisk / 1000)}K €`)
      : '0 €';

    // Hero stat with counting animation
    const heroValueEl = document.getElementById('net-revenue-at-risk');
    animateCurrency(heroValueEl, totalRevenueAtRisk, 1200);
    heroValueEl.classList.add('pulse');
    setTimeout(() => heroValueEl.classList.remove('pulse'), 1200);

    // Hero detail
    document.getElementById('hero-revenue-detail').textContent =
      `${urgentCount} lekární s vysokou produktivitou a nedostatkom personálu`;

    // Quick stats row
    document.getElementById('net-urgent-count').textContent = urgentCount;
    document.getElementById('net-monitor-count').textContent = monitorCount;
    document.getElementById('net-optimize-count').textContent = optimizeCount;

    // Priority section counts
    document.getElementById('priority-urgent-count').textContent = urgentCount;
    document.getElementById('priority-monitor-count').textContent = monitorCount;
    document.getElementById('priority-optimize-count').textContent = optimizeCount;

    // Priority section totals
    const urgentTotal = (priorities.urgent || []).reduce((sum, p) => sum + (p.revenue_at_risk || 0), 0);
    const monitorTotal = (priorities.monitor || []).reduce((sum, p) => sum + Math.abs(p.bloky_trend || 0), 0);
    const optimizeTotal = (priorities.optimize || []).reduce((sum, p) => sum + Math.abs(p.diff || 0), 0);

    document.getElementById('priority-urgent-total').textContent = urgentTotal >= 1000
      ? `-${Math.round(urgentTotal / 1000)}K` : `-${Math.round(urgentTotal)}`;
    document.getElementById('priority-monitor-total').textContent = `+${Math.round(monitorTotal / monitorCount || 0)}%`;
    document.getElementById('priority-optimize-total').textContent = `+${optimizeTotal.toFixed(1)} FTE`;

    // Render priority lists
    renderPriorityList('urgent', priorities.urgent || []);
    renderPriorityList('optimize', priorities.optimize || []);
    renderPriorityList('monitor', priorities.monitor || []);

    // Segment table
    const tbody = document.getElementById('segment-tbody');
    tbody.innerHTML = '';

    data.segments.forEach(seg => {
      const shortType = seg.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
      const zastupVal = seg.zastup || 0;
      const stalyVal = seg.actual_fte - zastupVal;  // Permanent staff
      const realDiff = seg.actual_fte - seg.predicted_fte;  // Difference (total vs optimal)
      const diffClass = Math.abs(realDiff) < 3 ? 'ok' : 'warning';
      const diffSign = realDiff >= 0 ? '+' : '';

      tbody.innerHTML += `
        <tr>
          <td class="segment-name">${shortType}</td>
          <td>${seg.count}</td>
          <td>${stalyVal.toFixed(1)}</td>
          <td class="zastup-cell">${zastupVal.toFixed(1)}</td>
          <td style="color:var(--text-muted);">${seg.actual_fte.toFixed(1)}</td>
          <td>${seg.predicted_fte.toFixed(1)}</td>
          <td><span class="status-badge ${diffClass}">${diffSign}${realDiff.toFixed(1)}</span></td>
        </tr>
      `;
    });

    // Total row
    const totalZastup = data.summary.total_zastup || 0;
    const totalStaly = data.summary.total_actual_fte - totalZastup;
    const totalRealDiff = data.summary.total_actual_fte - data.summary.total_predicted_fte;  // Total vs optimal
    const totalDiffClass = Math.abs(totalRealDiff) < 10 ? 'ok' : 'warning';
    tbody.innerHTML += `
      <tr class="total-row">
        <td class="segment-name">Celkom</td>
        <td>${data.summary.total_pharmacies}</td>
        <td>${totalStaly.toFixed(1)}</td>
        <td class="zastup-cell">${totalZastup.toFixed(1)}</td>
        <td style="color:var(--text-muted);">${data.summary.total_actual_fte.toFixed(1)}</td>
        <td>${data.summary.total_predicted_fte.toFixed(1)}</td>
        <td><span class="status-badge ${totalDiffClass}">${totalRealDiff >= 0 ? '+' : ''}${totalRealDiff.toFixed(1)}</span></td>
      </tr>
    `;

    // Show content, hide loading
    document.getElementById('network-loading').style.display = 'none';
    document.getElementById('network-content').style.display = 'block';

    // Trigger hero animation
    const heroStat = document.getElementById('hero-revenue');
    if (heroStat) {
      heroStat.classList.add('animate');
    }

    networkDataLoaded = true;

  } catch (error) {
    console.error('Error loading network data:', error);
    document.getElementById('network-loading').innerHTML = `
      <div style="text-align:center;">
        <p style="margin-bottom:10px;">Nepodarilo sa načítať prehľad</p>
        <button onclick="loadNetworkData()" class="btn-load">⟳ Skúsiť znova</button>
      </div>
    `;
    showToast('Nepodarilo sa načítať prehľad. Skúste to znova.');
  }
}

// Priority dashboard helper functions
const DISPLAY_LIMIT = 10; // Show top 10 in UI, CSV exports all

function renderPriorityList(type, items) {
  const list = document.getElementById(`priority-${type}-list`);
  if (!list) return;

  list.innerHTML = '';

  if (items.length === 0) {
    list.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem;">Žiadne lekárne v tejto kategórii</div>';
    return;
  }

  // Display only top 10, but full list is available for CSV
  const displayItems = items.slice(0, DISPLAY_LIMIT);
  const totalCount = items.length;

  displayItems.forEach((p, index) => {
    const shortType = p.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
    const pData = encodeURIComponent(JSON.stringify(p));
    const rank = index + 1;
    const hospitalBadge = p.hospital_supply ? '<span class="hospital-badge" title="Zásobuje nemocnicu">H</span>' : '';
    const smallPharmacyBadge = p.is_small_pharmacy ? '<span class="small-pharmacy-badge" title="Malá lekáreň bez laborantov - overiť manuálne">M</span>' : '';

    let valueHtml = '';
    let subtitleHtml = '';

    if (type === 'urgent') {
      // Revenue at risk - Kahneman loss framing
      const revenueAtRisk = p.revenue_at_risk || 0;
      const revenueText = revenueAtRisk >= 1000
        ? `${Math.round(revenueAtRisk / 1000)}K`
        : Math.round(revenueAtRisk).toString();
      valueHtml = `<span class="priority-item-value urgent">-${revenueText}</span>`;
      const smallPharmacyNote = p.is_small_pharmacy ? ' | <span style="color:#f59e0b">Overiť</span>' : '';
      subtitleHtml = `<span class="priority-item-subtitle">Chýba ${Math.abs(p.diff).toFixed(1)} FTE | Prod. +${p.prod_pct || 0}%${smallPharmacyNote}</span>`;
    } else if (type === 'optimize') {
      // Overstaffed - show excess FTE
      const excess = Math.abs(p.diff || 0);
      valueHtml = `<span class="priority-item-value optimize">+${excess.toFixed(1)} FTE</span>`;
      const zastupInfo = (p.zastup || 0) >= 0.1 ? ` | Zástup ${(p.zastup || 0).toFixed(1)} FTE` : '';
      subtitleHtml = p.hospital_supply
        ? `<span class="priority-item-subtitle">FTE zásobuje nemocnicu${zastupInfo}</span>`
        : `<span class="priority-item-subtitle">Možné prerozdelenie${zastupInfo}</span>`;
    } else if (type === 'monitor') {
      // Growing - show trend
      valueHtml = `<span class="priority-item-value monitor">+${p.bloky_trend || 0}%</span>`;
      subtitleHtml = `<span class="priority-item-subtitle">Rast transakcií YoY</span>`;
    }

    list.innerHTML += `
      <div class="priority-item ${type}" onclick="analyzePriorityItem(decodeURIComponent('${pData}'))">
        <span class="priority-item-rank">${rank}</span>
        <div class="priority-item-info">
          <div class="priority-item-name">
            ${p.id} - ${p.mesto}
            <span class="priority-item-id">${shortType}</span>
            ${hospitalBadge}${smallPharmacyBadge}
          </div>
          ${subtitleHtml}
        </div>
        ${valueHtml}
        <span class="priority-item-action">→</span>
      </div>
    `;
  });

  // Add note if there are more items than displayed
  if (totalCount > DISPLAY_LIMIT) {
    list.innerHTML += `
      <div style="padding:10px 14px;color:var(--text-muted);font-size:0.75rem;text-align:center;font-style:italic;">
        Zobrazených ${DISPLAY_LIMIT} z ${totalCount} · Kompletný zoznam v CSV exporte
      </div>
    `;
  }
}

function togglePriority(type) {
  const section = document.querySelector(`.priority-${type}-section`);
  const arrow = document.getElementById(`${type}-arrow`);
  if (!section || !arrow) return;

  const isExpanded = section.classList.contains('expanded');
  section.classList.toggle('expanded');
  arrow.textContent = isExpanded ? '▼' : '▲';

  // Re-trigger animations when expanding
  if (!isExpanded) {
    const items = section.querySelectorAll('.priority-item');
    items.forEach((item, i) => {
      item.style.animation = 'none';
      item.offsetHeight; // Trigger reflow
      item.style.animation = '';
    });
  }
}

function exportCSV(type) {
  // Get priority data from cached network data
  if (!window.networkData || !window.networkData.priorities) {
    alert('Data nie su dostupne. Skuste obnovit stranku.');
    return;
  }

  const priorities = window.networkData.priorities;
  const data = priorities[type] || [];

  if (data.length === 0) {
    alert('Ziadne data na export.');
    return;
  }

  // Helper to escape CSV values (wrap in quotes if contains comma, quote, or newline)
  const csvEscape = (val) => {
    if (val === null || val === undefined) return '';
    const str = String(val);
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  };

  // Define headers and filename based on type (with complete pharmacy info)
  const configs = {
    urgent: {
      filename: 'revenue_at_risk.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Gap FTE', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Ohrozené tržby (EUR)', 'Trend %', 'Malá lekáreň'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, p.diff?.toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, Math.round(p.revenue_at_risk || 0), p.bloky_trend, p.is_small_pharmacy ? 'Áno' : '']
    },
    monitor: {
      filename: 'growth_alert.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Gap FTE', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Trend %', 'Ohrozené tržby (EUR)'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, p.diff?.toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, p.bloky_trend, Math.round(p.revenue_at_risk || 0)]
    },
    optimize: {
      filename: 'fte_surplus.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Prebytok FTE', 'Zástup FTE', 'Zástup %', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Trend %', 'Nemocnica'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, Math.abs(p.diff || 0).toFixed(1), (p.zastup || 0).toFixed(2), (p.zastup_pct || 0).toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, p.bloky_trend, p.hospital_supply ? 'Áno' : '']
    }
  };

  const config = configs[type];

  // Build CSV content with UTF-8 BOM for Excel compatibility
  const BOM = '\uFEFF';
  let csv = BOM + config.headers.map(csvEscape).join(',') + '\n';
  data.forEach(p => {
    csv += config.row(p).map(csvEscape).join(',') + '\n';
  });

  // Download file
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = config.filename;
  link.click();
  URL.revokeObjectURL(url);
}

function toggleSegmentTable() {
  const container = document.getElementById('segment-table-container');
  const arrow = document.getElementById('segment-toggle-arrow');
  if (!container || !arrow) return;

  const isHidden = container.style.display === 'none';
  container.style.display = isHidden ? 'block' : 'none';
  arrow.textContent = isHidden ? '▼' : '▶';
}

function toggleModelInfo() {
  const container = document.getElementById('model-info-container');
  const arrow = document.getElementById('model-info-arrow');
  if (!container || !arrow) return;

  const isHidden = container.style.display === 'none';
  container.style.display = isHidden ? 'block' : 'none';
  arrow.textContent = isHidden ? '▼' : '▶';
}

function analyzePriorityItem(dataStr) {
  const p = JSON.parse(dataStr);

  // Switch to calculator tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('[data-tab="calculator"]').classList.add('active');
  document.getElementById('tab-calculator').classList.add('active');

  // Load pharmacy into calculator
  document.getElementById('pharmacy-id-input').value = p.id;
  document.getElementById('pharmacy-load-btn').click();
}

function renderOutlierList(type, outliers) {
  const list = document.getElementById(type + '-list');
  list.innerHTML = '';

  if (outliers.length === 0) {
    list.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem;">Žiadne lekárne</div>';
    return;
  }

  outliers.forEach(p => {
    const diffClass = p.diff > 0 ? 'positive' : 'negative';
    const diffSign = p.diff > 0 ? '+' : '';
    const shortType = p.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
    const pData = encodeURIComponent(JSON.stringify(p));

    list.innerHTML += `
      <div class="outlier-item" onclick="analyzeOutlier(decodeURIComponent('${pData}'))">
        <div class="outlier-chat-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg></div>
        <div class="outlier-info">
          <div class="outlier-name">${p.mesto} <span style="color:var(--text-muted);font-weight:400;">#${p.id}</span></div>
          <div class="outlier-type">${shortType} | ${(p.bloky/1000).toFixed(0)}k bloky | ${(p.trzby/1000000).toFixed(1)}M € | ${p.podiel_rx}% Rx</div>
        </div>
        <div class="outlier-diff ${diffClass}">${diffSign}${p.diff.toFixed(1)}</div>
      </div>
    `;
  });
}

function toggleOutliers(type) {
  const header = document.querySelector(`#${type}-list`).previousElementSibling;
  const list = document.getElementById(type + '-list');
  const arrow = document.getElementById(type + '-arrow');

  header.classList.toggle('expanded');
  list.classList.toggle('expanded');
  arrow.textContent = list.classList.contains('expanded') ? '▲' : '▼';
}

// ============================================
// AI CHAT ASSISTANT
// ============================================
let lastCalculationResult = null;
let chatOpen = false;

const chatTrigger = document.getElementById('chat-trigger');
const chatPanel = document.getElementById('chat-panel');
const chatClose = document.getElementById('chat-close');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const chatSuggestions = document.getElementById('chat-suggestions');

// Question history for arrow up/down navigation
const questionHistory = [];
let historyIndex = -1;
let tempInput = '';  // Store current input when navigating history

// Store segment histograms for FTE chart
let segmentHistograms = null;

// FTE Comparison
function renderFteComparison(fteValue, benchmark, comparable, isActual) {
  // Render FTE position in segment (as 4th row in position charts)
  // Shows actual FTE when pharmacy loaded, recommended otherwise
  const fteHist = segmentHistograms ? segmentHistograms.fte : null;
  renderPositionChart('fte', benchmark.min, benchmark.max, benchmark.avg, fteValue, '', 1, fteHist);
}

// Segment position chart
function renderPositionCharts(segment, hourly, inputs, typ) {

  // Convert inputs to display units
  const yourBloky = inputs.bloky / 1000;  // to thousands
  const yourTrzby = inputs.trzby / 1000000;  // to millions
  const yourRx = inputs.podiel_rx * 100;  // to percentage

  // Get histograms (if available) and store for FTE chart
  const hist = segment.histograms || {};
  segmentHistograms = hist;

  // Render each chart with histogram
  renderPositionChart('bloky', segment.bloky_min, segment.bloky_max, segment.bloky_avg, yourBloky, 'k', 0, hist.bloky);
  renderPositionChart('trzby', segment.trzby_min, segment.trzby_max, segment.trzby_avg, yourTrzby, 'M', 1, hist.trzby);
  renderPositionChart('rx', segment.rx_min, segment.rx_max, segment.rx_avg, yourRx, '%', 0, hist.rx);

  // Render additional metrics if hourly data available
  if (hourly) {
    renderPositionChart('basket', hourly.segment_basket_min, hourly.segment_basket_max, hourly.segment_basket_avg, hourly.basket_value, '€', 1, hist.basket);
    renderPositionChart('blokyhod', hourly.segment_bloky_hour_min, hourly.segment_bloky_hour_max, hourly.segment_bloky_hour_avg, hourly.bloky_per_hour, '', 1, hist.blokyhod);
    renderPositionChart('trzbyhod', hourly.segment_trzby_hour_min, hourly.segment_trzby_hour_max, hourly.segment_trzby_hour_avg, hourly.trzby_per_hour, '€', 0, hist.trzbyhod);
  }

  // Update efficiency and trend zone indicators based on current pharmacy data
  updateEfficiencyIndicator();
  updateTrendIndicator();
}

function renderPositionChart(name, min, max, avg, you, unit, decimals, histogram) {
  const range = max - min;

  // Calculate positions (0-100%)
  const avgPos = range > 0 ? ((avg - min) / range) * 100 : 50;
  const youPos = range > 0 ? Math.max(0, Math.min(100, ((you - min) / range) * 100)) : 50;

  // Position markers
  const avgMarker = document.getElementById(`pos-${name}-avg`);
  const youMarker = document.getElementById(`pos-${name}-you`);
  if (avgMarker) avgMarker.style.left = avgPos + '%';
  if (youMarker) youMarker.style.left = youPos + '%';

  // Update min/max labels
  document.getElementById(`pos-${name}-min`).textContent = min + unit;
  document.getElementById(`pos-${name}-max`).textContent = max + unit;

  // Update your value display
  const valueEl = document.getElementById(`pos-${name}-value`);
  valueEl.textContent = you.toFixed(decimals) + unit;

  // Calculate difference from average
  const diff = you - avg;
  const diffPct = avg > 0 ? (diff / avg) * 100 : 0;
  const isAbove = diff >= 0;

  // Calculate percentile (rough estimate based on position)
  const percentile = Math.round(youPos);

  // Determine indicator type and text
  const indicatorEl = document.getElementById(`pos-${name}-indicator`);
  const tooltipEl = document.getElementById(`pos-${name}-tooltip`);

  let indicatorClass, indicatorSymbol, tooltipText;

  if (Math.abs(diffPct) < 5) {
    // Close to average (within 5%)
    indicatorClass = 'neutral';
    indicatorSymbol = '≈';
    tooltipText = `≈ priemer segmentu`;
  } else if (isAbove) {
    // Above average
    indicatorClass = 'positive';
    indicatorSymbol = '↑';
    const topPct = 100 - percentile;
    tooltipText = `+${diffPct.toFixed(0)}% vs priemer · Top ${topPct < 50 ? topPct : percentile}%`;
  } else {
    // Below average
    indicatorClass = 'negative';
    indicatorSymbol = '↓';
    tooltipText = `${diffPct.toFixed(0)}% vs priemer · ${percentile}. percentil`;
  }

  if (indicatorEl) {
    indicatorEl.className = `position-indicator ${indicatorClass}`;
    indicatorEl.textContent = indicatorSymbol;
  }

  if (tooltipEl) {
    tooltipEl.textContent = tooltipText;
  }

  // Render histogram if available
  if (histogram && histogram.length > 0) {
    const histEl = document.getElementById(`hist-${name}`);
    if (histEl) {
      const maxVal = Math.max(...histogram);
      histEl.innerHTML = histogram.map(h =>
        `<div class="histogram-bar" style="height:${maxVal > 0 ? (h / maxVal) * 100 : 0}%"></div>`
      ).join('');
    }
  }
}

// Simulation - Simplified (2 sliders: Tržby + Produktivita)
let sensitivityCoeffs = null;
let baseFteTotal = null;

function initSensitivitySliders(sensitivity, baseFte) {
  // Store coefficients
  sensitivityCoeffs = {
    trzby: sensitivity.trzby_10pct / 10,  // FTE per 1% revenue change
    prod: 0.5                              // FTE saved per 1σ productivity improvement
  };
  baseFteTotal = baseFte;

  // Get slider elements
  const trzbySlider = document.getElementById('sens-trzby');
  const prodSlider = document.getElementById('sens-prod');

  // Reset sliders to 0
  trzbySlider.value = 0;
  prodSlider.value = 0;

  // Add event listeners
  trzbySlider.oninput = updateSimulationDisplay;
  prodSlider.oninput = updateSimulationDisplay;

  // Reset button
  document.getElementById('sim-reset-btn').addEventListener('click', function() {
    trzbySlider.value = 0;
    prodSlider.value = 0;
    updateSimulationDisplay();
  });

  // Initial display
  updateSimulationDisplay();

  // Show content, hide empty state
  document.getElementById('analyza-empty').style.display = 'none';
  document.getElementById('analyza-content').style.display = 'block';
}

function updateSimulationDisplay() {
  const trzbyVal = parseInt(document.getElementById('sens-trzby').value);
  const prodVal = parseInt(document.getElementById('sens-prod').value) / 10;  // Scale: 0-20 -> 0-2.0σ

  // Calculate FTE impacts
  const trzbyFte = trzbyVal * sensitivityCoeffs.trzby;
  const prodFte = -prodVal * sensitivityCoeffs.prod;  // Negative = saves FTE

  const totalFte = trzbyFte + prodFte;

  // Update Tržby display
  const trzbyResultEl = document.getElementById('sens-trzby-result');
  const trzbyFteEl = document.getElementById('sens-trzby-fte');
  const trzbyValEl = document.getElementById('sens-trzby-val');

  trzbyFteEl.textContent = (trzbyFte >= 0 ? '+' : '') + trzbyFte.toFixed(1);
  trzbyResultEl.classList.remove('negative', 'zero');

  // Show input value next to label
  if (trzbyVal !== 0) {
    trzbyValEl.textContent = (trzbyVal >= 0 ? '+' : '') + trzbyVal + '%';
    trzbyValEl.classList.add('visible');
    trzbyValEl.classList.toggle('negative', trzbyVal < 0);
  } else {
    trzbyValEl.classList.remove('visible');
  }

  if (Math.abs(trzbyFte) < 0.05) {
    trzbyResultEl.classList.add('zero');
  } else if (trzbyFte < 0) {
    trzbyResultEl.classList.add('negative');
  }

  // Update Productivity display
  const prodResultEl = document.getElementById('sens-prod-result');
  const prodFteEl = document.getElementById('sens-prod-fte');
  const prodValEl = document.getElementById('sens-prod-val');

  prodFteEl.textContent = prodFte.toFixed(1);
  prodResultEl.classList.remove('negative', 'zero');

  // Show input value next to label
  if (prodVal > 0) {
    prodValEl.textContent = '+' + prodVal.toFixed(1) + 'σ';
    prodValEl.classList.add('visible');
  } else {
    prodValEl.classList.remove('visible');
  }

  if (Math.abs(prodFte) < 0.05) {
    prodResultEl.classList.add('zero');
  } else {
    prodResultEl.classList.add('negative');
  }

  // Update total with pulse animation
  const totalEl = document.getElementById('sens-total-fte');
  totalEl.textContent = (totalFte >= 0 ? '+' : '') + totalFte.toFixed(1) + ' FTE';

  totalEl.classList.remove('pulse');
  void totalEl.offsetWidth; // Trigger reflow
  totalEl.classList.add('pulse');

  document.getElementById('sens-base-fte').textContent = baseFteTotal.toFixed(1);
  document.getElementById('sens-new-fte').textContent = (baseFteTotal + totalFte).toFixed(1) + ' FTE';
}

// Backwards compatibility wrapper
function renderSensitivity(sensitivity) {
  // Called from calcBtn.onclick - use actual FTE as base (if available), otherwise predicted
  if (lastCalculationResult) {
    const baseFte = lastCalculationResult.fte_actual || lastCalculationResult.fte_total;
    if (baseFte) {
      initSensitivitySliders(sensitivity, baseFte);
    }
  }
}

// Store calculation result for chat context
function storeCalculationResult(result, inputs, displayedFteTotal = null) {
  lastCalculationResult = {
    pharmacy_id: inputs.pharmacy_id,
    pharmacy_name: window.selectedPharmacyData ? window.selectedPharmacyData.mesto : null,
    fte_actual: window.selectedPharmacyData ? window.selectedPharmacyData.actual_fte : null,
    fte_diff: window.selectedPharmacyData ? window.selectedPharmacyData.fte_diff : null,
    revenue_at_risk: window.selectedPharmacyData ? window.selectedPharmacyData.revenue_at_risk : null,
    bloky_trend: window.selectedPharmacyData ? window.selectedPharmacyData.bloky_trend : null,
    is_above_avg_productivity: window.selectedPharmacyIsAboveAvgProd || false,
    typ: inputs.typ,
    bloky: inputs.bloky,
    trzby: inputs.trzby,
    podiel_rx: inputs.podiel_rx,
    effective_bloky: result.inputs?.effective_bloky || 0,
    fte_total: displayedFteTotal || result.fte.total,
    fte_min: result.fte.min,
    fte_max: result.fte.max,
    fte_F: result.breakdown.F,
    fte_L: result.breakdown.L,
    fte_ZF: result.breakdown.ZF,
    comparable_count: result.comparable?.count || 0,
    comparable_avg: result.comparable?.avg_fte || null,
    comparable_min: result.comparable?.min_fte || null,
    comparable_max: result.comparable?.max_fte || null,
    benchmark_avg: result.benchmark?.avg || null,
    benchmark_count: result.benchmark?.count || 0,
    bloky_per_hour: result.hourly?.bloky_per_hour || null,
    trzby_per_hour: result.hourly?.trzby_per_hour || null,
    segment_bloky_hour_avg: result.hourly?.segment_bloky_hour_avg || null,
    segment_bloky_hour_min: result.hourly?.segment_bloky_hour_min || null,
    segment_bloky_hour_max: result.hourly?.segment_bloky_hour_max || null,
    segment_rx_avg: result.segment?.rx_avg || null,
    segment_bloky_avg: result.segment?.bloky_avg || null,
    segment_trzby_avg: result.segment?.trzby_avg || null
  };
  // Show chat trigger when we have calculation result
  chatTrigger.classList.add('visible');
}

// Toggle chat panel
chatTrigger.onclick = () => {
  chatOpen = !chatOpen;
  chatPanel.classList.toggle('open', chatOpen);
  if (chatOpen) {
    chatInput.focus();
  }
};

chatClose.onclick = () => {
  chatOpen = false;
  chatPanel.classList.remove('open');
};

// Send message
async function sendChatMessage(question) {
  if (!question.trim()) return;

  // Add to question history (avoid duplicates)
  const trimmedQ = question.trim();
  if (questionHistory.length === 0 || questionHistory[questionHistory.length - 1] !== trimmedQ) {
    questionHistory.push(trimmedQ);
  }
  historyIndex = -1;  // Reset history navigation
  tempInput = '';

  // If no context, provide a generic helpful message instead of failing silently
  if (!lastCalculationResult) {
    addChatMessage(question, 'user');
    chatInput.value = '';
    setTimeout(() => {
      addChatMessage("Najprv prosím vypočítajte FTE pre lekáreň v záložke Kalkulačka alebo vyberte lekáreň v záložke Prehľad, aby som vám mohol poradiť s konkrétnymi dátami. Zatiaľ vám môžem vysvetliť princípy modelu.", 'assistant');
    }, 500);
    return;
  }

  // Add user message
  addChatMessage(question, 'user');
  chatInput.value = '';
  chatSend.disabled = true;

  // Hide suggestions after first question
  chatSuggestions.style.display = 'none';

  // Show typing indicator
  const typingId = showTypingIndicator();

  // Set up 90-second timeout
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 90000);

  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: question,
        context: lastCalculationResult
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);
    const data = await response.json();
    removeTypingIndicator(typingId);

    if (data.error) {
      addChatMessage('Prepáčte, nastala chyba: ' + data.error, 'assistant');
    } else {
      addChatMessage(formatAnswer(data.answer), 'assistant');
    }
  } catch (error) {
    clearTimeout(timeoutId);
    removeTypingIndicator(typingId);
    if (error.name === 'AbortError') {
      addChatMessage('Prepáčte, odpoveď trvala príliš dlho. Skúste znova alebo položte jednoduchšiu otázku.', 'assistant');
    } else {
      addChatMessage('Prepáčte, nepodarilo sa spojiť so serverom.', 'assistant');
    }
  }

  chatSend.disabled = false;
}

function addChatMessage(text, role) {
  const msg = document.createElement('div');
  msg.className = 'chat-message ' + role;
  msg.innerHTML = '<div class="bubble">' + text + '</div>';
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function formatAnswer(text) {
  // First convert markdown tables to HTML
  text = convertMarkdownTables(text);

  // Convert markdown-like formatting to HTML
  return text
    // Remove markdown code block markers
    .replace(/```\n?/g, '')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Style revenue at risk lines in red
    .replace(/(⚠[^<\n]*(?:ohrozené|Ohrozené)[^<\n]*)/gi, '<span class="risk-text">$1</span>')
    // Style bar characters (filled and empty)
    .replace(/([█]+)/g, '<span class="bar-filled">$1</span>')
    .replace(/([░]+)/g, '<span class="bar-empty">$1</span>')
    // Productivity indicators
    .replace(/↑↑/g, '<span class="prod-up">↑↑</span>')
    .replace(/↑/g, '<span class="prod-up">↑</span>')
    .replace(/↓/g, '<span class="prod-down">↓</span>')
    // Gap values
    .replace(/\+(\d+\.?\d*)/g, '<span class="gap-positive">+$1</span>')
    .replace(/-(\d+\.?\d*)/g, '<span class="gap-negative">-$1</span>')
    .replace(/\n/g, '<br>');
}

// === AGENT MODE ===
const agentSuggestions = document.getElementById('agent-suggestions');

// Handle agent suggestion clicks
document.querySelectorAll('.chat-suggestion.agent').forEach(btn => {
  btn.addEventListener('click', () => {
    const q = btn.dataset.q;
    if (q) sendAgentMessage(q);
  });
});

async function sendAgentMessage(prompt) {
  if (!prompt.trim()) return;

  // Add to question history (avoid duplicates)
  const trimmedQ = prompt.trim();
  if (questionHistory.length === 0 || questionHistory[questionHistory.length - 1] !== trimmedQ) {
    questionHistory.push(trimmedQ);
  }
  historyIndex = -1;  // Reset history navigation
  tempInput = '';

  // Add user message
  addChatMessage(prompt, 'user');
  chatInput.value = '';
  chatSend.disabled = true;
  agentSuggestions.style.display = 'none';

  // Show typing indicator
  const typingId = showTypingIndicator();

  try {
    const response = await fetch('/api/agent/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    });

    const data = await response.json();
    removeTypingIndicator(typingId);

    if (data.error) {
      addChatMessage('Prepáčte, nastala chyba: ' + data.error, 'assistant');
    } else {
      // Format response with agent indicator
      const formattedResponse = formatAnswer(data.response);
      addChatMessage(formattedResponse, 'assistant');
    }
  } catch (error) {
    removeTypingIndicator(typingId);
    addChatMessage('Prepáčte, nepodarilo sa spojiť s Claude agentom.', 'assistant');
  }

  chatSend.disabled = false;
}

function showTypingIndicator() {
  const id = 'typing-' + Date.now();
  const typing = document.createElement('div');
  typing.id = id;
  typing.className = 'chat-message assistant';
  typing.innerHTML = '<div class="bubble"><div class="chat-typing"><span></span><span></span><span></span></div></div>';
  chatMessages.appendChild(typing);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return id;
}

function removeTypingIndicator(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

// Event listeners
chatSend.onclick = () => sendChatMessage(chatInput.value);
chatInput.onkeypress = (e) => {
  if (e.key === 'Enter') sendChatMessage(chatInput.value);
};

// Arrow up/down for question history
chatInput.onkeydown = (e) => {
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (questionHistory.length === 0) return;

    // Save current input when starting to navigate
    if (historyIndex === -1) {
      tempInput = chatInput.value;
    }

    // Move up in history
    if (historyIndex < questionHistory.length - 1) {
      historyIndex++;
      chatInput.value = questionHistory[questionHistory.length - 1 - historyIndex];
    }
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (historyIndex === -1) return;

    // Move down in history
    historyIndex--;
    if (historyIndex === -1) {
      // Back to current input
      chatInput.value = tempInput;
    } else {
      chatInput.value = questionHistory[questionHistory.length - 1 - historyIndex];
    }
  }
};

// Suggestion buttons
document.querySelectorAll('.chat-suggestion').forEach(btn => {
  btn.onclick = () => sendChatMessage(btn.dataset.q);
});

// Analyze outlier from Network tab
function analyzeOutlier(jsonStr) {
  const p = JSON.parse(jsonStr);
  const rxFactor = 0.41;
  const effectiveBloky = p.bloky * (1 + rxFactor * (p.podiel_rx / 100));

  // Set chat context with outlier data
  lastCalculationResult = {
    pharmacy_id: p.id,
    typ: p.typ,
    bloky: p.bloky,
    trzby: p.trzby,
    podiel_rx: p.podiel_rx / 100,
    effective_bloky: effectiveBloky,
    fte_total: p.predicted_fte,
    fte_actual: p.actual_fte,
    fte_diff: p.diff,
    revenue_at_risk: p.revenue_at_risk || 0,
    bloky_trend: p.bloky_trend || 0,
    is_above_avg_productivity: p.is_above_avg_productivity || false,
    fte_min: null,
    fte_max: null,
    fte_F: null,
    fte_L: null,
    fte_ZF: null,
    comparable_count: 0,
    comparable_avg: null,
    benchmark_avg: null,
    benchmark_count: null,
    bloky_per_hour: null,
    trzby_per_hour: null,
    pharmacy_name: p.mesto
  };

  // Show chat trigger and open panel
  chatTrigger.classList.add('visible');
  chatPanel.classList.add('open');
  chatOpen = true;

  // Reset chat messages
  const hospitalNote = p.hospital_supply ? '<br><em style="color:#0ea5e9;font-size:0.85em;">Lekáreň zásobuje nemocnicu - FTE zahŕňa aj nemocničnú logistiku</em>' : '';
  chatMessages.innerHTML = `
    <div class="chat-message assistant">
      <div class="bubble"><strong>${p.mesto}</strong> (${p.typ})${hospitalNote}<br><br>Model odporúča ${p.predicted_fte.toFixed(1)} FTE, aktuálne má ${p.actual_fte.toFixed(1)} FTE (${p.diff > 0 ? '+' : ''}${p.diff.toFixed(1)}). Opýtajte sa prečo.</div>
    </div>
  `;

  // Show suggestions
  chatSuggestions.style.display = 'flex';
  chatSuggestions.innerHTML = `
    <button class="chat-suggestion" onclick="sendChatMessage('Vysvetli stav personálneho obsadenia uvedenej lekárne ${p.id}')">Vysvetli stav lekárne</button>
    <button class="chat-suggestion" onclick="sendChatMessage('Uveď 5 lekární v segmente výkonom podobné uvedenej lekárni ${p.id}, ktoré majú viac FTE')">Podobné s vyšším FTE</button>
  `;

  chatInput.focus();
}

// Count-up animation for FTE result
function animateValue(elementId, start, end, duration) {
  const el = document.getElementById(elementId);
  if (!el) return;

  const startTime = performance.now();
  const easeOutQuart = t => 1 - Math.pow(1 - t, 4);

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easeOutQuart(progress);
    const current = start + (end - start) * easedProgress;

    const parts = current.toFixed(1).split('.');
    el.innerHTML = parts[0] + '<span class="decimal">.' + parts[1] + '</span>';

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);
}

// Animate currency value with K/M suffix
function animateCurrency(element, targetValue, duration = 1000) {
  if (!element || targetValue <= 0) {
    element.textContent = '0 €';
    return;
  }

  const startTime = performance.now();
  const easeOutQuart = t => 1 - Math.pow(1 - t, 4);

  function formatCurrency(value) {
    if (value >= 1000000) {
      return `${(value / 1000000).toFixed(1)}M €`;
    }
    return `${Math.round(value / 1000)}K €`;
  }

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easeOutQuart(progress);
    const current = targetValue * easedProgress;

    element.textContent = formatCurrency(current);

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);
}

// === AGENT TAB FUNCTIONALITY ===
const agentInput = document.getElementById('agent-input');
const agentSubmit = document.getElementById('agent-submit');
const agentResults = document.getElementById('agent-results');
const quickActions = document.querySelectorAll('.quick-action');

// Store original welcome HTML for restoration
const originalWelcomeHTML = document.getElementById('agent-welcome').outerHTML;

// Query history for arrow-up
let agentHistory = [];
let agentHistoryIndex = -1;

// Quick action buttons - populate input for review, don't auto-submit
quickActions.forEach(btn => {
  btn.addEventListener('click', () => {
    const query = btn.dataset.query;
    agentInput.value = query;
    agentInput.focus();
    // Select all text so user can easily modify or press Enter to submit
    agentInput.select();
  });
});

// Tools toggle button - show/hide extra tools
const toolsToggle = document.getElementById('tools-toggle');
const toolsExtra = document.getElementById('tools-extra');
if (toolsToggle && toolsExtra) {
  toolsToggle.addEventListener('click', () => {
    toolsToggle.classList.toggle('expanded');
    toolsExtra.classList.toggle('visible');
    const span = toolsToggle.querySelector('span');
    if (toolsExtra.classList.contains('visible')) {
      span.textContent = 'Skryť ďalšie nástroje';
    } else {
      span.textContent = 'Zobraziť ďalšie nástroje (6)';
    }
  });
}

// Intro panel toggle
const introPanel = document.getElementById('intro-panel');
const introPanelToggle = document.getElementById('intro-panel-toggle');
if (introPanelToggle && introPanel) {
  introPanelToggle.addEventListener('click', () => {
    introPanel.classList.toggle('expanded');
  });
}

// Intro panel CTA button
document.querySelectorAll('.intro-panel-cta').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const query = btn.dataset.query;
    if (query) {
      agentInput.value = query;
      agentInput.focus();
    }
  });
});

// Sample question buttons - populate input for user review
document.querySelectorAll('.sample-question').forEach(btn => {
  btn.addEventListener('click', () => {
    const query = btn.dataset.query;
    if (query) {
      agentInput.value = query;
      agentInput.focus();
    }
  });
});

// Submit button
agentSubmit.addEventListener('click', submitAgentQuery);

// Enter to submit
agentInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    submitAgentQuery();
  }
  // Arrow up for history
  if (e.key === 'ArrowUp' && agentInput.value === '') {
    e.preventDefault();
    if (agentHistory.length > 0) {
      if (agentHistoryIndex < agentHistory.length - 1) {
        agentHistoryIndex++;
      }
      agentInput.value = agentHistory[agentHistory.length - 1 - agentHistoryIndex];
    }
  }
  // Arrow down for history
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (agentHistoryIndex > 0) {
      agentHistoryIndex--;
      agentInput.value = agentHistory[agentHistory.length - 1 - agentHistoryIndex];
    } else {
      agentHistoryIndex = -1;
      agentInput.value = '';
    }
  }
});

async function submitAgentQuery() {
  const query = agentInput.value.trim();
  if (!query) return;

  // Add to history
  agentHistory.push(query);
  agentHistoryIndex = -1;
  agentInput.value = '';

  // Show streaming progress UI with 4 phases
  agentResults.innerHTML = `
    <div class="agent-streaming">
      <div class="streaming-steps">
        <div class="streaming-step active" id="step-planning">
          <div class="step-icon"><div class="spinner-small"></div></div>
          <div class="step-text">Plánovanie</div>
          <div class="step-timer"></div>
        </div>
        <div class="streaming-step" id="step-ai-response">
          <div class="step-icon">○</div>
          <div class="step-text">Odpoveď AI</div>
          <div class="step-timer"></div>
        </div>
        <div class="streaming-step" id="step-tools">
          <div class="step-icon">○</div>
          <div class="step-text">Zber dát</div>
          <div class="step-timer"></div>
          <div class="step-tools" id="tools-list"></div>
        </div>
        <div class="streaming-step" id="step-synthesis">
          <div class="step-icon">○</div>
          <div class="step-text">Generovanie</div>
          <div class="step-timer"></div>
        </div>
      </div>
    </div>
  `;
  agentSubmit.disabled = true;

  const toolsCollected = [];
  let finalResponse = null;
  let finalError = null;

  try {
    // Use streaming endpoint
    const response = await fetch('/api/agent/analyze/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: query })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop(); // Keep incomplete line in buffer

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const event = JSON.parse(line.slice(6));
            handleStreamEvent(event, toolsCollected);

            if (event.type === 'result') {
              finalResponse = event;
            } else if (event.type === 'error') {
              finalError = event;
            }
          } catch (e) {
            console.warn('Failed to parse SSE event:', line);
          }
        }
      }
    }

    // Handle errors (result is rendered immediately via handleStreamEvent)
    if (finalError && !finalResponse) {
      agentResults.innerHTML = `
        <div class="agent-response-actions">
          <button class="back-to-tools" onclick="showAgentWelcome()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            Späť na nástroje
          </button>
        </div>
        <div class="agent-response">
          <p style="color: #dc2626;">Chyba: ${finalError.message || finalError.content || 'Neznáma chyba'}</p>
        </div>
      `;
    }
  } catch (error) {
    agentResults.innerHTML = `
      <div class="agent-response-actions">
        <button class="back-to-tools" onclick="showAgentWelcome()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          Späť na nástroje
        </button>
      </div>
      <div class="agent-response">
        <p style="color: #dc2626;">Chyba pri komunikácii so serverom: ${error.message}</p>
      </div>
    `;
  }

  agentSubmit.disabled = false;
}

// Track timing for each phase
let phaseStartTime = null;
let phaseTimerInterval = null;

function updatePhaseTimer(stepElement) {
  if (!phaseStartTime || !stepElement) return;
  const elapsed = ((Date.now() - phaseStartTime) / 1000).toFixed(1);
  const timerEl = stepElement.querySelector('.step-timer');
  if (timerEl) {
    timerEl.textContent = `${elapsed}s`;
  }
}

function handleStreamEvent(event, toolsCollected) {
  const stepPlanning = document.getElementById('step-planning');
  const stepAiResponse = document.getElementById('step-ai-response');
  const stepTools = document.getElementById('step-tools');
  const stepSynthesis = document.getElementById('step-synthesis');
  const toolsList = document.getElementById('tools-list');

  // Helper to mark step as done
  function markStepDone(step, duration) {
    if (!step) return;
    step.classList.remove('active');
    step.classList.add('done');
    step.querySelector('.step-icon').textContent = '✓';
    if (duration !== undefined) {
      step.querySelector('.step-timer').textContent = `${duration}s`;
    }
  }

  // Helper to activate step
  function activateStep(step) {
    if (!step) return;
    if (phaseTimerInterval) clearInterval(phaseTimerInterval);
    phaseStartTime = Date.now();
    step.classList.add('active');
    step.querySelector('.step-icon').innerHTML = '<div class="spinner-small"></div>';
    phaseTimerInterval = setInterval(() => updatePhaseTimer(step), 100);
  }

  switch (event.type) {
    case 'status':
      const phase = event.phase;
      const status = event.status;

      if (phase === 'planning') {
        if (status === 'start') {
          activateStep(stepPlanning);
        } else if (status === 'complete') {
          markStepDone(stepPlanning, event.duration || ((Date.now() - phaseStartTime) / 1000).toFixed(1));
        }
      } else if (phase === 'ai_response') {
        if (status === 'start') {
          // Planning done (instant), AI response starts
          markStepDone(stepPlanning, '0.1');
          activateStep(stepAiResponse);
        } else if (status === 'complete') {
          markStepDone(stepAiResponse, event.duration || ((Date.now() - phaseStartTime) / 1000).toFixed(1));
        }
      } else if (phase === 'executing') {
        if (status === 'start') {
          activateStep(stepTools);
        } else if (status === 'complete') {
          markStepDone(stepTools, event.duration || ((Date.now() - phaseStartTime) / 1000).toFixed(1));
        }
      } else if (phase === 'synthesizing') {
        if (status === 'start') {
          activateStep(stepSynthesis);
        } else if (status === 'complete') {
          markStepDone(stepSynthesis, event.duration || ((Date.now() - phaseStartTime) / 1000).toFixed(1));
        }
      }
      break;

    case 'tool':
      toolsCollected.push(event.tool);
      if (toolsList) {
        const toolSpan = document.createElement('span');
        toolSpan.className = 'tool-badge';
        toolSpan.textContent = event.tool;
        toolsList.appendChild(toolSpan);
      }
      break;

    case 'result':
      // Stop timer
      if (phaseTimerInterval) clearInterval(phaseTimerInterval);
      // Mark synthesis done if not already
      if (stepSynthesis && !stepSynthesis.classList.contains('done')) {
        markStepDone(stepSynthesis, ((Date.now() - phaseStartTime) / 1000).toFixed(1));
      }
      // Render immediately - don't wait for stream to end
      renderAgentResult(event, toolsCollected);
      break;
  }
}

function renderAgentResult(event, toolsCollected) {
  const actionsHTML = `
    <div class="agent-response-actions">
      <button class="back-to-tools" onclick="showAgentWelcome()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        Späť na nástroje
      </button>
    </div>
  `;

  const formattedResponse = formatAgentResponse(event.response || '');

  agentResults.innerHTML = `
    ${actionsHTML}
    <div class="agent-response" id="agent-response-content">${formattedResponse}</div>
  `;
}

function formatAgentResponse(text) {
  console.log('[formatAgentResponse] Input:', text.substring(0, 200));

  // First, convert markdown tables to HTML tables
  text = convertMarkdownTables(text);
  console.log('[formatAgentResponse] After table conversion:', text.substring(0, 200));

  // Configure marked for clean rendering
  marked.setOptions({
    breaks: false,
    gfm: true,
    headerIds: false,
    mangle: false
  });

  // Parse remaining markdown to HTML
  let html = marked.parse(text);

  // Post-process: style indicators and special characters
  html = html
    .replace(/([█]+)/g, '<span class="bar-filled">$1</span>')
    .replace(/([░]+)/g, '<span class="bar-empty">$1</span>')
    .replace(/(⚠[^<\n]*)/gi, '<span class="risk-text">$1</span>')
    // Productivity indicators
    .replace(/↑↑/g, '<span class="prod-up">↑↑</span>')
    .replace(/↑/g, '<span class="prod-up">↑</span>')
    .replace(/↓/g, '<span class="prod-down">↓</span>')
    // Gap values
    .replace(/\+(\d+\.?\d*)/g, '<span class="gap-positive">+$1</span>')
    .replace(/-(\d+\.?\d*)/g, '<span class="gap-negative">-$1</span>');

  return html;
}

function convertMarkdownTables(text) {
  // Simple regex-based conversion for markdown tables
  const tableRegex = /\|(.+)\|\n\|[\s:|-]+\|\n((?:\|.+\|\n?)+)/g;

  return text.replace(tableRegex, (match, headerRow, bodyRows) => {
    console.log('[convertMarkdownTables] Found table match');

    // Parse header
    const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
    let html = '<table><thead><tr>';
    headers.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr></thead><tbody>';

    // Parse body rows
    const rows = bodyRows.trim().split('\n');
    rows.forEach(row => {
      const cells = row.split('|').map(c => c.trim()).filter(c => c);
      if (cells.length > 0) {
        html += '<tr>';
        cells.forEach(c => { html += `<td>${c}</td>`; });
        html += '</tr>';
      }
    });

    html += '</tbody></table>';
    return html;
  });
}

// Show agent welcome/tools showcase
function showAgentWelcome() {
  // Restore from stored HTML
  agentResults.innerHTML = originalWelcomeHTML;

  // Re-attach event listeners for the cloned elements (populate input only, no auto-submit)
  document.querySelectorAll('.sample-question').forEach(btn => {
    btn.addEventListener('click', () => {
      const query = btn.dataset.query;
      if (query) {
        agentInput.value = query;
        agentInput.focus();
      }
    });
  });

  // Re-attach tools toggle
  const newToolsToggle = document.getElementById('tools-toggle');
  const newToolsExtra = document.getElementById('tools-extra');
  if (newToolsToggle && newToolsExtra) {
    newToolsToggle.addEventListener('click', () => {
      newToolsToggle.classList.toggle('expanded');
      newToolsExtra.classList.toggle('visible');
      const span = newToolsToggle.querySelector('span');
      if (newToolsExtra.classList.contains('visible')) {
        span.textContent = 'Skryť ďalšie nástroje';
      } else {
        span.textContent = 'Zobraziť ďalšie nástroje (6)';
      }
    });
  }
}

// ============================================
// REVENUE TREND CHART
// ============================================
const trendMonthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Máj', 'Jún', 'Júl', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
const trendMargin = { top: 20, right: 20, bottom: 30, left: 50 };
const trendWidth = 580 - trendMargin.left - trendMargin.right;
const trendHeight = 240 - trendMargin.top - trendMargin.bottom;

function trendScaleX(month) {
  return trendMargin.left + ((month - 1) / 11) * trendWidth;
}

function trendScaleY(value, minVal, maxVal) {
  return trendMargin.top + trendHeight - ((value - minVal) / (maxVal - minVal)) * trendHeight;
}

function formatTrendCurrency(value) {
  // Use K format for tooltip (e.g., 85K)
  return Math.round(value / 1000) + 'K';
}

function createTrendPath(data, minVal, maxVal) {
  return data.map((d, i) => {
    const x = trendScaleX(d.month);
    const y = trendScaleY(d.revenue, minVal, maxVal);
    return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
  }).join(' ');
}

function createTrendAreaPath(data, minVal, maxVal) {
  const linePath = data.map((d, i) => {
    const x = trendScaleX(d.month);
    const y = trendScaleY(d.revenue, minVal, maxVal);
    return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
  }).join(' ');

  const lastX = trendScaleX(data[data.length - 1].month);
  const firstX = trendScaleX(data[0].month);
  const bottomY = trendMargin.top + trendHeight;

  return `${linePath} L ${lastX} ${bottomY} L ${firstX} ${bottomY} Z`;
}

function renderTrendChart(revenueData, currentMonth, forecastData = []) {
  const svg = document.getElementById('trend-chart');
  const chartCard = document.getElementById('trend-chart-card');

  if (!svg || !chartCard) return;

  // Check if we have data
  const hasData = revenueData && (revenueData[2019]?.length > 0 || revenueData[2020]?.length > 0 || revenueData[2021]?.length > 0);

  if (!hasData) {
    chartCard.style.display = 'none';
    return;
  }

  chartCard.style.display = 'block';

  // Find min/max values for scaling (including forecast)
  const allValues = [...Object.values(revenueData).flat().map(d => d.revenue), ...forecastData.map(d => d.revenue)];
  const minValue = Math.min(...allValues) * 0.9;
  const maxValue = Math.max(...allValues) * 1.05;

  let svgContent = '';

  // Grid lines
  const gridStep = (maxValue - minValue) / 4;
  for (let i = 0; i <= 4; i++) {
    const value = minValue + gridStep * i;
    const y = trendScaleY(value, minValue, maxValue);
    svgContent += `<line class="trend-grid-line" x1="${trendMargin.left}" y1="${y}" x2="${trendMargin.left + trendWidth}" y2="${y}" />`;
    svgContent += `<text class="trend-axis-label trend-axis-label-value" x="${trendMargin.left - 8}" y="${y + 3}">${(value/1000).toFixed(0)}k</text>`;
  }

  // Month labels
  trendMonthNames.forEach((name, i) => {
    const x = trendScaleX(i + 1);
    svgContent += `<text class="trend-axis-label trend-axis-label-month" x="${x}" y="${trendMargin.top + trendHeight + 18}">${name}</text>`;
  });

  // Areas (back to front)
  if (revenueData[2019]?.length > 0) {
    svgContent += `<path class="trend-area trend-area-2019" d="${createTrendAreaPath(revenueData[2019], minValue, maxValue)}" />`;
  }
  if (revenueData[2020]?.length > 0) {
    svgContent += `<path class="trend-area trend-area-2020" d="${createTrendAreaPath(revenueData[2020], minValue, maxValue)}" />`;
  }
  if (revenueData[2021]?.length > 0) {
    svgContent += `<path class="trend-area trend-area-2021" d="${createTrendAreaPath(revenueData[2021], minValue, maxValue)}" />`;
  }

  // Lines (back to front)
  if (revenueData[2019]?.length > 0) {
    svgContent += `<path class="trend-line trend-line-2019" d="${createTrendPath(revenueData[2019], minValue, maxValue)}" />`;
  }
  if (revenueData[2020]?.length > 0) {
    svgContent += `<path class="trend-line trend-line-2020" d="${createTrendPath(revenueData[2020], minValue, maxValue)}" />`;
  }
  if (revenueData[2021]?.length > 0) {
    svgContent += `<path class="trend-line trend-line-2021" d="${createTrendPath(revenueData[2021], minValue, maxValue)}" />`;
  }

  // Forecast line (dashed, continuing from last 2021 data point)
  if (forecastData.length > 0 && revenueData[2021]?.length > 0) {
    const lastActual = revenueData[2021][revenueData[2021].length - 1];
    const forecastWithConnection = [lastActual, ...forecastData];
    const forecastLinePath = forecastWithConnection.map((d, i) => {
      const x = trendScaleX(d.month);
      const y = trendScaleY(d.revenue, minValue, maxValue);
      return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
    }).join(' ');
    svgContent += `<path class="trend-line-forecast" d="${forecastLinePath}" />`;
  }

  // Current month marker on 2021 line
  if (revenueData[2021]?.length > 0) {
    const currentData = revenueData[2021].find(d => d.month === currentMonth);
    if (currentData) {
      const cx = trendScaleX(currentData.month);
      const cy = trendScaleY(currentData.revenue, minValue, maxValue);
      svgContent += `<g class="trend-current-marker" style="transform-origin: ${cx}px ${cy}px;">
        <circle cx="${cx}" cy="${cy}" r="5" fill="var(--brand-green)" />
        <circle cx="${cx}" cy="${cy}" r="3" fill="white" />
      </g>`;
    }
  }

  // Interactive hover points
  Object.entries(revenueData).forEach(([year, data]) => {
    data.forEach(d => {
      const x = trendScaleX(d.month);
      const y = trendScaleY(d.revenue, minValue, maxValue);
      svgContent += `<circle
        class="trend-hover-point"
        cx="${x}"
        cy="${y}"
        r="12"
        fill="transparent"
        data-year="${year}"
        data-month="${d.month}"
        data-revenue="${d.revenue}"
        style="cursor: pointer;"
      />`;
    });
  });

  // Forecast hover points
  forecastData.forEach(d => {
    const x = trendScaleX(d.month);
    const y = trendScaleY(d.revenue, minValue, maxValue);
    svgContent += `<circle
      class="trend-hover-point"
      cx="${x}"
      cy="${y}"
      r="12"
      fill="transparent"
      data-year="2021"
      data-month="${d.month}"
      data-revenue="${d.revenue}"
      data-forecast="true"
      style="cursor: pointer;"
    />`;
  });

  // Add crosshair line
  svgContent += `<line class="trend-crosshair" id="trend-crosshair-line" x1="0" y1="${trendMargin.top}" x2="0" y2="${trendMargin.top + trendHeight}" />`;

  svg.innerHTML = svgContent;

  // Store data for crosshair access
  svg._revenueData = revenueData;
  svg._minValue = minValue;
  svg._maxValue = maxValue;

  // Add hover interactions for individual points
  const tooltip = document.getElementById('trend-tooltip');
  const hoverPoints = svg.querySelectorAll('.trend-hover-point');

  hoverPoints.forEach(point => {
    point.addEventListener('mouseenter', (e) => {
      const year = e.target.getAttribute('data-year');
      const month = parseInt(e.target.getAttribute('data-month'));
      const revenue = parseFloat(e.target.getAttribute('data-revenue'));
      const isForecast = e.target.getAttribute('data-forecast') === 'true';

      const label = isForecast ? `${trendMonthNames[month - 1]} ${year} (prognóza)` : `${trendMonthNames[month - 1]} ${year}`;
      tooltip.innerHTML = `${label}: ${formatTrendCurrency(revenue)}`;
      tooltip.style.opacity = '1';

      const rect = svg.getBoundingClientRect();
      const x = parseFloat(e.target.getAttribute('cx'));
      const y = parseFloat(e.target.getAttribute('cy'));

      const tooltipX = (x / 580) * rect.width;
      const tooltipY = (y / 240) * rect.height;

      tooltip.style.left = `${tooltipX}px`;
      tooltip.style.top = `${tooltipY - 35}px`;
      tooltip.style.transform = 'translateX(-50%)';
    });

    point.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
    });
  });

  // Crosshair interaction with tooltip
  const crosshairLine = document.getElementById('trend-crosshair-line');
  const crosshairTooltip = document.getElementById('trend-crosshair-tooltip');

  svg.addEventListener('mousemove', (e) => {
    const rect = svg.getBoundingClientRect();
    const svgX = ((e.clientX - rect.left) / rect.width) * 580;

    // Only show crosshair within chart area
    if (svgX < trendMargin.left || svgX > trendMargin.left + trendWidth) {
      crosshairLine.classList.remove('active');
      crosshairTooltip.classList.remove('active');
      return;
    }

    // Calculate nearest month (1-12) and snap to it
    const monthFloat = ((svgX - trendMargin.left) / trendWidth) * 11 + 1;
    const month = Math.round(monthFloat);
    const snappedX = trendScaleX(month);

    // Update crosshair line position
    crosshairLine.setAttribute('x1', snappedX);
    crosshairLine.setAttribute('x2', snappedX);
    crosshairLine.classList.add('active');

    // Build compact tooltip: "Jan: 85K / 92K / 98K"
    const data = svg._revenueData;
    let values = [];
    [2019, 2020, 2021].forEach(year => {
      if (data[year]) {
        const monthData = data[year].find(d => d.month === month);
        if (monthData) {
          values.push(formatTrendCurrency(monthData.revenue));
        }
      }
    });

    crosshairTooltip.textContent = `${trendMonthNames[month - 1]}: ${values.join(' / ')}`;
    crosshairTooltip.classList.add('active');

    // Position tooltip to the RIGHT of crosshair (offset by 15px)
    const tooltipX = (snappedX / 580) * rect.width + 15;
    crosshairTooltip.style.left = `${tooltipX}px`;
  });

  svg.addEventListener('mouseleave', () => {
    crosshairLine.classList.remove('active');
    crosshairTooltip.classList.remove('active');
  });
}

function updateTrendYoY(yoy2020, yoy2021) {
  const el2020 = document.getElementById('trend-yoy-2020');
  const el2021 = document.getElementById('trend-yoy-2021');

  if (el2020) {
    if (yoy2020 !== null && !isNaN(yoy2020)) {
      el2020.textContent = (yoy2020 >= 0 ? '+' : '') + yoy2020.toFixed(1) + '%';
      el2020.classList.toggle('positive', yoy2020 >= 0);
      el2020.classList.toggle('negative', yoy2020 < 0);
    } else {
      el2020.textContent = '-';
      el2020.classList.remove('positive', 'negative');
    }
  }

  if (el2021) {
    if (yoy2021 !== null && !isNaN(yoy2021)) {
      el2021.textContent = (yoy2021 >= 0 ? '+' : '') + yoy2021.toFixed(1) + '%';
      el2021.classList.toggle('positive', yoy2021 >= 0);
      el2021.classList.toggle('negative', yoy2021 < 0);
    } else {
      el2021.textContent = '-';
      el2021.classList.remove('positive', 'negative');
    }
  }
}

async function loadTrendChart(pharmacyId) {
  try {
    const response = await fetch(`/api/pharmacy/${pharmacyId}/revenue`);
    if (!response.ok) {
      document.getElementById('trend-chart-card').style.display = 'none';
      return;
    }

    const data = await response.json();

    // Update YoY values
    updateTrendYoY(data.yoy_growth_2020, data.yoy_growth_2021);

    // Render chart with forecast
    renderTrendChart(data.monthly, data.current_month || 8, data.forecast || []);

  } catch (error) {
    console.error('Error loading trend chart:', error);
    document.getElementById('trend-chart-card').style.display = 'none';
  }
}

// ============================================
// ROZVRH TAB - Schedule with Kahneman Principles
// ============================================
let rozvrhDataLoaded = false;

// Static demo data (from utilization.html)
const rozvrhMonthlyLoss = {
  'Po': {8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 364, 17: 463, 18: 134, 19: 0},
  'Ut': {8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 160, 17: 234, 18: 173, 19: 0},
  'St': {8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 255, 17: 251, 18: 0, 19: 0},
  'Št': {8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 225, 17: 394, 18: 0, 19: 0},
  'Pi': {8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 372, 17: 372, 18: 234, 19: 0},
  'So': {8: 0, 9: 355, 10: 662, 11: 615, 12: 165, 13: 0, 14: 0, 15: 0, 16: 169, 17: 204, 18: 264, 19: 0},
  'Ne': {8: 0, 9: 238, 10: 394, 11: 277, 12: 121, 13: 152, 14: 247, 15: 156, 16: 178, 17: 0, 18: 143, 19: 0}
};

const rozvrhWeeklyStaff = {
  'Po': {8: 3.9, 9: 3.9, 10: 4.1, 11: 4.0, 12: 4.0, 13: 3.9, 14: 4.0, 15: 3.9, 16: 3.1, 17: 3.0, 18: 3.0, 19: 2.7},
  'Ut': {8: 4.4, 9: 4.4, 10: 4.2, 11: 3.8, 12: 4.2, 13: 4.3, 14: 4.2, 15: 4.0, 16: 3.5, 17: 3.0, 18: 3.0, 19: 2.8},
  'St': {8: 4.4, 9: 4.2, 10: 4.4, 11: 4.4, 12: 4.0, 13: 4.0, 14: 3.6, 15: 4.2, 16: 3.2, 17: 3.0, 18: 3.0, 19: 3.0},
  'Št': {8: 4.6, 9: 4.4, 10: 4.6, 11: 4.4, 12: 4.1, 13: 4.1, 14: 4.1, 15: 4.1, 16: 3.3, 17: 3.0, 18: 3.0, 19: 2.9},
  'Pi': {8: 4.3, 9: 4.1, 10: 4.4, 11: 4.4, 12: 4.4, 13: 4.1, 14: 4.1, 15: 4.4, 16: 3.4, 17: 3.0, 18: 3.0, 19: 3.0},
  'So': {8: 3.0, 9: 3.0, 10: 3.0, 11: 3.0, 12: 3.0, 13: 3.0, 14: 3.0, 15: 2.9, 16: 2.1, 17: 2.0, 18: 2.0, 19: 2.0},
  'Ne': {8: 2.0, 9: 2.0, 10: 2.0, 11: 2.0, 12: 2.0, 13: 2.0, 14: 2.0, 15: 2.0, 16: 2.0, 17: 2.0, 18: 2.0, 19: 2.0}
};

const rozvrhDays = ['Po', 'Ut', 'St', 'Št', 'Pi', 'So', 'Ne'];
const rozvrhHours = [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];

function getRozvrhLossClass(loss) {
  // Simplified: only ok or loss (single red shade)
  return loss === 0 ? 'loss-0' : 'loss-active';
}

function loadRozvrhData() {
  const loadingEl = document.getElementById('rozvrh-loading');
  const contentEl = document.getElementById('rozvrh-content');

  loadingEl.style.display = 'flex';
  contentEl.style.display = 'none';

  // Simulate brief loading for effect
  setTimeout(() => {
    buildScheduleHeatmap();

    // Calculate total loss
    let totalLoss = 0;
    rozvrhDays.forEach(day => {
      rozvrhHours.forEach(hour => {
        totalLoss += rozvrhMonthlyLoss[day][hour];
      });
    });

    // Animate the hero value
    animateScheduleHeroValue(totalLoss);

    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
    rozvrhDataLoaded = true;
  }, 600);
}

function buildScheduleHeatmap() {
  const heatmap = document.getElementById('schedule-heatmap');

  rozvrhDays.forEach(day => {
    // Row label
    const label = document.createElement('div');
    label.className = 'schedule-heatmap-day';
    label.textContent = day;
    heatmap.appendChild(label);

    // Cells for each hour - only show loss amount, hide FTE
    rozvrhHours.forEach(hour => {
      const loss = rozvrhMonthlyLoss[day][hour];
      const staff = rozvrhWeeklyStaff[day][hour];

      const cell = document.createElement('div');
      cell.className = 'schedule-heatmap-cell ' + getRozvrhLossClass(loss);

      // Only show opportunity value, no FTE
      if (loss > 0) {
        cell.innerHTML = `<span class="cell-value">+${loss}€</span>`;
      }

      cell.dataset.day = day;
      cell.dataset.hour = hour;
      cell.dataset.loss = loss;
      cell.dataset.staff = staff;

      heatmap.appendChild(cell);
    });
  });
}

function animateScheduleHeroValue(targetValue) {
  const el = document.getElementById('schedule-total-loss');
  const duration = 1500;
  const start = performance.now();

  function update(now) {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);

    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(targetValue * eased);

    el.textContent = '+' + current.toLocaleString('sk-SK') + ' €';

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);
}

// ============================================
// PRODUCTION VISION TAB - Simulation
// ============================================
function simulateAutopilot() {
  const btn = event.target.closest('.btn-simulate');
  if (btn.disabled) return;

  btn.disabled = true;
  btn.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
      <path d="M21 12a9 9 0 11-6.219-8.56"/>
    </svg>
    Simulujem...
  `;

  // Add spin animation
  const style = document.createElement('style');
  style.textContent = `
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  `;
  document.head.appendChild(style);

  // Simulate workflow progression
  const stages = document.querySelectorAll('#tab-vision .workflow-stage');
  const scheduleItems = document.querySelectorAll('#tab-vision .schedule-item');
  // Items: 0-2 = Import (completed), 3-5 = Analysis (3=running, 4-5=pending), 6-8 = Reports (pending)

  let step = 0;
  const interval = setInterval(() => {
    step++;

    if (step === 1) {
      // Complete first analysis task (index 3)
      if (scheduleItems[3]) {
        const status = scheduleItems[3].querySelector('.schedule-item-status');
        status.classList.remove('running');
        status.classList.add('completed');
        status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        scheduleItems[3].querySelector('.schedule-item-time').textContent = '06:07';
      }
    }

    if (step === 2) {
      // Complete second analysis task (index 4)
      if (scheduleItems[4]) {
        const status = scheduleItems[4].querySelector('.schedule-item-status');
        status.classList.remove('pending');
        status.classList.add('completed');
        status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        scheduleItems[4].querySelector('.schedule-item-time').textContent = '06:09';
      }
      // Move workflow to next stage
      if (stages[1]) {
        stages[1].classList.remove('active');
        stages[1].classList.add('completed');
      }
      if (stages[2]) {
        stages[2].classList.add('active');
      }
    }

    if (step === 3) {
      // Complete third analysis task (index 5)
      if (scheduleItems[5]) {
        const status = scheduleItems[5].querySelector('.schedule-item-status');
        status.classList.remove('pending');
        status.classList.add('completed');
        status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        scheduleItems[5].querySelector('.schedule-item-time').textContent = '06:11';
      }
    }

    if (step === 4) {
      // Complete first report task (index 6)
      if (scheduleItems[6]) {
        const status = scheduleItems[6].querySelector('.schedule-item-status');
        status.classList.remove('pending');
        status.classList.add('completed');
        status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        scheduleItems[6].querySelector('.schedule-item-time').textContent = '06:13';
      }

      // Update stats
      const statValues = document.querySelectorAll('#tab-vision .workflow-stat-value');
      if (statValues[0]) statValues[0].textContent = '4,231';
      if (statValues[1]) statValues[1].textContent = '96%';
      if (statValues[2]) statValues[2].textContent = '$0.06';
    }

    if (step === 5) {
      // Complete remaining report tasks (indices 7, 8)
      [7, 8].forEach((idx, i) => {
        if (scheduleItems[idx]) {
          const status = scheduleItems[idx].querySelector('.schedule-item-status');
          status.classList.remove('pending');
          status.classList.add('completed');
          status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
          scheduleItems[idx].querySelector('.schedule-item-time').textContent = i === 0 ? '06:14' : '06:15';
        }
      });

      // Complete workflow
      if (stages[2]) {
        stages[2].classList.remove('active');
        stages[2].classList.add('completed');
      }

      // Show success toast
      showToast('Mesačný cyklus dokončený za 15 minút! Všetky úlohy spracované.', 'success', 5000);

      clearInterval(interval);

      // Reset button
      btn.disabled = false;
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="1 4 1 10 7 10"/>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
        Resetovať
      `;

      // Change button to reset
      btn.onclick = resetAutopilot;
    }
  }, 600);
}

function resetAutopilot() {
  const stages = document.querySelectorAll('#tab-vision .workflow-stage');
  const scheduleItems = document.querySelectorAll('#tab-vision .schedule-item');

  // Reset workflow stages
  stages.forEach((stage, i) => {
    stage.classList.remove('completed', 'active');
    if (i === 0) stage.classList.add('completed');
    if (i === 1) stage.classList.add('active');
  });

  // Reset analysis items (indices 3, 4, 5)
  const analysisDefaults = [
    { time: 'prebieha', status: 'running', icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>` },
    { time: '06:08', status: 'pending', icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/></svg>` },
    { time: '06:10', status: 'pending', icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/></svg>` }
  ];

  [3, 4, 5].forEach((idx, i) => {
    if (scheduleItems[idx]) {
      const status = scheduleItems[idx].querySelector('.schedule-item-status');
      status.classList.remove('completed');
      status.classList.add(analysisDefaults[i].status);
      status.innerHTML = analysisDefaults[i].icon;
      scheduleItems[idx].querySelector('.schedule-item-time').textContent = analysisDefaults[i].time;
    }
  });

  // Reset report items (indices 6, 7, 8)
  const reportDefaults = ['06:12', '06:14', '06:15'];
  [6, 7, 8].forEach((idx, i) => {
    if (scheduleItems[idx]) {
      const status = scheduleItems[idx].querySelector('.schedule-item-status');
      status.classList.remove('completed');
      status.classList.add('pending');
      status.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/></svg>`;
      scheduleItems[idx].querySelector('.schedule-item-time').textContent = reportDefaults[i];
    }
  });

  // Reset stats
  const statValues = document.querySelectorAll('#tab-vision .workflow-stat-value');
  if (statValues[0]) statValues[0].textContent = '2,847';
  if (statValues[1]) statValues[1].textContent = '92%';
  if (statValues[2]) statValues[2].textContent = '$0.04';

  // Reset button
  const btn = event.target.closest('.btn-simulate');
  btn.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Simulovať
  `;
  btn.onclick = simulateAutopilot;

  showToast('Simulácia resetovaná', 'info', 2000);
}
</script>

<footer style="
  text-align: center;
  padding: 24px 16px;
  margin-top: 40px;
  color: var(--text-muted);
  font-size: 0.75rem;
">
  Inteligentný FTE Manažment v5.1
</footer>
</body>
</html>
