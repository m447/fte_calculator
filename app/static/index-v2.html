<!DOCTYPE html>
<!--
  FTE Kalkulačka v5.1
  Dr.Max Pharmacy Staffing Tool
-->
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTE Kalkulačka | Dr.Max</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,500;6..12,600;6..12,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* ============================================
   DR.MAX FTE CALCULATOR - CORPORATE STYLING
   ============================================ */

:root {
  --brand-green: #78be20;
  --brand-green-dark: #6aab1a;
  --btn-green: #8ed12e;
  --btn-green-dark: #78be20;
  --brand-green-light: rgba(120, 190, 32, 0.1);
  --brand-green-glow: rgba(120, 190, 32, 0.25);
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --text-muted: #6b7280;
  --bg-page: #f8faf6;
  --bg-card: #ffffff;
  --bg-subtle: #f4f7f2;
  --border-light: #e5e7eb;
  --border-medium: #d1d5db;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
  --shadow-brand: 0 4px 14px rgba(120, 190, 32, 0.3);
  --transition-fast: 0.15s ease;
  --transition-smooth: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --accent-warm: #f59e0b;
  --accent-warm-light: rgba(245, 158, 11, 0.1);
}

/* Page load animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes resultPop {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  70% {
    transform: scale(1.05);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-in {
  animation: fadeInUp 0.5s ease-out forwards;
  opacity: 0;
}

.animate-in:nth-child(1) { animation-delay: 0ms; }
.animate-in:nth-child(2) { animation-delay: 80ms; }
.animate-in:nth-child(3) { animation-delay: 160ms; }
.animate-in:nth-child(4) { animation-delay: 240ms; }
.animate-in:nth-child(5) { animation-delay: 320ms; }

* {
  box-sizing: border-box;
}

body {
  font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-page);
  margin: 0;
  padding: 20px 16px 120px; /* Increased bottom padding for mobile safe area */
  color: var(--text-primary);
  line-height: 1.5;
}

.container {
  max-width: 680px;
  margin: 0 auto;
  padding: 0 24px;
}

/* ============================================
   HEADER
   ============================================ */
.header {
  text-align: center;
  margin-bottom: 28px;
  padding-top: 8px;
  position: relative;
}

.header::before {
  content: '';
  display: block;
  width: 60px;
  height: 4px;
  background: linear-gradient(90deg, var(--brand-green), var(--brand-green-dark));
  border-radius: 2px;
  margin: 0 auto 20px;
}

h1 {
  font-size: 1.6rem;
  font-weight: 700;
  margin: 0 0 8px;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.header-logo {
  height: 32px;
  width: auto;
  vertical-align: middle;
}

.subtitle {
  color: var(--text-muted);
  font-size: 0.95rem;
  margin: 0;
  font-weight: 400;
}

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--bg-card);
  border-radius: 14px;
  padding: 24px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
  margin-bottom: 16px;
  transition: box-shadow var(--transition-smooth), transform var(--transition-smooth);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-title {
  text-transform: uppercase;
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  font-weight: 700;
  letter-spacing: 0.08em;
  display: flex;
  align-items: center;
  gap: 8px;
}


/* ============================================
   FORM ELEMENTS
   ============================================ */
label {
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 6px;
  display: block;
  color: var(--text-secondary);
}

input, select {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid var(--border-medium);
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-primary);
  background: var(--bg-card);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

input:hover, select:hover {
  border-color: #9ca3af;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px var(--brand-green-light), inset 0 1px 2px rgba(0,0,0,0.04);
}

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}

.form-row {
  display: flex;
  gap: 16px;
  margin-top: 20px;
}

.form-row > div {
  flex: 1;
}

.form-row-3 {
  gap: 12px;
}

.calculated-row {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px dashed var(--border-light);
}

.basket-readonly {
  background: var(--bg-subtle);
  color: var(--brand-green);
  cursor: default;
}

/* Tooltip styles */
.tooltip-wrapper {
  position: relative;
}

.tooltip-wrapper .tooltip-text {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
  z-index: 100;
  transition: opacity 0.2s, visibility 0.2s;
  box-shadow: var(--shadow-md);
}

.tooltip-wrapper .tooltip-text::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--text-primary);
}

.tooltip-wrapper:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

.form-group {
  margin-top: 20px;
}

/* ============================================
   SLIDER (Range Input)
   ============================================ */
.slider-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  flex: 1;
  height: 8px;
  background: linear-gradient(to right, var(--brand-green) 0%, var(--brand-green) var(--slider-progress, 50%), var(--border-light) var(--slider-progress, 50%), var(--border-light) 100%);
  border-radius: 4px;
  border: none;
  padding: 0;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background var(--transition-fast);
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 22px;
  height: 22px;
  background: var(--bg-card);
  border: 3px solid var(--brand-green);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 3px 10px rgba(120, 190, 32, 0.3);
}

input[type="range"]::-moz-range-thumb {
  width: 22px;
  height: 22px;
  background: var(--bg-card);
  border: 3px solid var(--brand-green);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.slider-value {
  width: 65px;
  text-align: center;
  font-weight: 700;
  color: var(--brand-green);
  padding: 8px 10px;
  font-size: 0.95rem;
}

.slider-unit {
  color: var(--brand-green);
  font-weight: 600;
  font-size: 0.95rem;
}

/* ============================================
   PRODUCTIVITY TOGGLE
   ============================================ */
.productivity-group {
  margin-top: 16px;
}

.productivity-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toggle-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  transition: color var(--transition-fast);
}

.toggle-label-high {
  color: var(--text-muted);
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border-light);
  transition: var(--transition-fast);
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: var(--transition-fast);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input:checked + .toggle-slider {
  background-color: var(--brand-green);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

/* Compact productivity toggle for inline use */
.productivity-toggle-compact {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 8px;
}

.toggle-switch-sm {
  position: relative;
  width: 36px;
  height: 20px;
  flex-shrink: 0;
}

.toggle-switch-sm input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider-sm {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border-light);
  transition: var(--transition-fast);
  border-radius: 20px;
}

.toggle-slider-sm:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: var(--transition-fast);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch-sm input:checked + .toggle-slider-sm {
  background-color: var(--brand-green);
}

.toggle-switch-sm input:checked + .toggle-slider-sm:before {
  transform: translateX(16px);
}

.toggle-label-sm {
  font-size: 0.85rem;
  color: var(--text-muted);
  transition: color var(--transition-fast);
}


.prod-info-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--border-light);
  color: var(--text-muted);
  font-size: 10px;
  cursor: help;
  margin-left: 4px;
  vertical-align: middle;
}

/* ============================================
   SEGMENTED CONTROL (Produktivita)
   ============================================ */
.segmented-control {
  display: flex;
  background: var(--bg-subtle);
  border-radius: 10px;
  padding: 4px;
  gap: 4px;
}

.segment-option {
  flex: 1;
  position: relative;
}

.segment-option input {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.segment-option label {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0;
  text-align: center;
}

.segment-option input:checked + label {
  background: var(--bg-card);
  color: var(--text-primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.segment-option.high-productivity input:checked + label {
  background: var(--brand-green);
  color: white;
}

/* ============================================
   INPUT WITH SUFFIX (Rx %)
   ============================================ */
.input-with-suffix {
  position: relative;
  display: flex;
  align-items: center;
}

.input-with-suffix input {
  padding-right: 36px;
}

.input-suffix {
  position: absolute;
  right: 14px;
  color: var(--text-muted);
  font-weight: 600;
  font-size: 0.9rem;
  pointer-events: none;
}

/* ============================================
   TOOLTIP ON HOVER ONLY
   ============================================ */
.tooltip-wrapper {
  position: relative;
}

.tooltip-wrapper .tooltip-text {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.7rem;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  z-index: 100;
  pointer-events: none;
}

.tooltip-wrapper .tooltip-text::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--text-primary);
}

.tooltip-wrapper:hover .tooltip-text {
  opacity: 1;
  visibility: visible;
}

/* ============================================
   CALCULATE BUTTON
   ============================================ */
.btn {
  width: 100%;
  background: white;
  color: var(--brand-green);
  padding: 18px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 1.1rem;
  border: 2px solid var(--brand-green);
  cursor: pointer;
  margin: 0 0 16px 0;
  font-family: inherit;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.btn:hover {
  background: var(--brand-green);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 14px rgba(120, 190, 32, 0.35);
}

.btn:hover::before {
  opacity: 1;
}

.btn:active {
  transform: translateY(0) scale(0.98);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn.loading {
  pointer-events: none;
  color: transparent;
}

.btn.loading::after {
  content: '';
  position: absolute;
  width: 24px;
  height: 24px;
  top: 50%;
  left: 50%;
  margin: -12px 0 0 -12px;
  border: 3px solid rgba(120, 190, 32, 0.3);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ============================================
   RESULTS SECTION
   ============================================ */
#result {
  margin-top: 0;
  transition: opacity 0.2s ease;
}

.result-divider {
  display: none;
}

/* Main Result Card */
.result-main {
  text-align: center;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  padding: 36px 24px;
  border-radius: 16px;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px var(--brand-green-glow);
  animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  position: relative;
  overflow: hidden;
}

.result-main::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.val-row {
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 12px;
}

.result-main .val {
  font-size: 4.5rem;
  font-weight: 700;
  line-height: 1;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.result-main .val .decimal {
  font-size: 55%;
  opacity: 0.9;
}

.val-vs {
  display: flex;
  align-items: baseline;
  gap: 12px;
}

.val-vs .val {
  color: rgba(0,0,0,0.5);
  text-shadow: none;
}

.val-vs-text {
  font-size: 1.5rem;
  font-weight: 400;
  opacity: 0.7;
}

.result-main .label {
  font-size: 1rem;
  margin-top: 8px;
  opacity: 0.95;
  font-weight: 500;
}

.result-main .range {
  margin-top: 14px;
  font-size: 0.9rem;
  opacity: 0.85;
  background: rgba(255,255,255,0.15);
  display: inline-block;
  padding: 6px 16px;
  border-radius: 20px;
}

/* Distribution Comparison */
.distribution-box {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 1px solid var(--border-light);
  animation: fadeUp 0.5s ease-out 0.15s backwards;
}

.dist-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.dist-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  font-weight: 600;
}


.dist-bar-container {
  position: relative;
  height: 8px;
  margin-bottom: 8px;
}

.dist-bar-bg {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
}

.dist-bar-range {
  position: absolute;
  top: 0;
  height: 8px;
  background: linear-gradient(90deg, var(--brand-green-light), var(--brand-green));
  border-radius: 4px;
  opacity: 0.6;
}

.dist-marker {
  position: absolute;
  top: -4px;
  width: 16px;
  height: 16px;
  background: var(--brand-green);
  border: 3px solid white;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transform: translateX(-50%);
  z-index: 2;
  cursor: pointer;
}

.dist-marker::after {
  content: attr(data-fte);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
  margin-bottom: 6px;
}

.dist-marker:hover::after {
  opacity: 1;
}

.dist-marker-actual {
  position: absolute;
  top: -2px;
  width: 12px;
  height: 12px;
  background: white;
  border: 2px solid var(--brand-green);
  border-radius: 50%;
  transform: translateX(-50%);
  z-index: 1;
  opacity: 0.5;
}

.dist-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
}

/* Breakdown Cards */
.breakdown {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  text-align: center;
  margin-bottom: 20px;
}

.breakdown-item {
  background: var(--bg-card);
  padding: 18px 12px;
  border-radius: 12px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  animation: fadeUp 0.5s ease-out backwards;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.breakdown-item:nth-child(1) { animation-delay: 0.1s; }
.breakdown-item:nth-child(2) { animation-delay: 0.2s; }
.breakdown-item:nth-child(3) { animation-delay: 0.3s; }

.breakdown-item:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}

.breakdown-item:hover .breakdown-pct {
  opacity: 1;
  transform: translateY(0);
}

.breakdown-val {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--brand-green);
}

.breakdown-lbl {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 600;
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

.breakdown-pct {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 4px;
  opacity: 0;
  transform: translateY(4px);
  transition: opacity 0.2s, transform 0.2s;
}

/* Trust Box */
.trust-box {
  background: var(--bg-subtle);
  border-left: 4px solid var(--brand-green);
  padding: 18px;
  border-radius: 8px;
  margin-bottom: 16px;
  animation: fadeUp 0.5s ease-out 0.4s backwards;
}

.trust-title {
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text-primary);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.trust-title::before {
  content: '✓';
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  color: white;
  border-radius: 50%;
  font-size: 0.65rem;
  font-weight: 700;
}

.trust-content {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 6px;
}

.trust-link {
  color: var(--brand-green);
  cursor: pointer;
  font-weight: 600;
  transition: color var(--transition-fast);
}

.trust-link:hover {
  color: var(--brand-green-dark);
  text-decoration: underline;
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 400px) {
  .result-main .val {
    font-size: 3.5rem;
  }
  
  .breakdown {
    gap: 10px;
  }
  
  .breakdown-item {
    padding: 14px 8px;
  }

  .breakdown-val {
    font-size: 1.3rem;
  }
}

/* ============================================
   TAB NAVIGATION
   ============================================ */
.tab-nav {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  background: var(--bg-card);
  padding: 6px;
  border-radius: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
}

.tab-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition-fast);
}

.tab-btn:hover {
  background: var(--bg-subtle);
  color: var(--text-primary);
}

.tab-btn.active {
  background: var(--brand-green);
  color: white;
  box-shadow: var(--shadow-brand);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeUp 0.3s ease-out;
}

/* Ensure animated elements stay visible after tab switch */
.tab-content.active .animate-in {
  opacity: 1;
}

/* Agent tab button styling - unified with brand */
.tab-btn.agent-tab {
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
  position: relative;
}
.tab-btn.agent-tab::after {
  content: '✦';
  font-size: 0.6rem;
  margin-left: 4px;
  opacity: 0.7;
}
.tab-btn.agent-tab:hover {
  background: rgba(120, 190, 32, 0.2);
}
.tab-btn.agent-tab.active {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
}

/* ============================================
   AI AGENT TAB
   ============================================ */
.agent-container {
  padding: 20px 0;
}

.agent-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding: 20px;
  background: linear-gradient(135deg, var(--brand-green-light) 0%, rgba(120, 190, 32, 0.05) 100%);
  border-radius: 16px;
  border: 1px solid rgba(120, 190, 32, 0.25);
  position: relative;
  overflow: hidden;
}

/* Subtle AI accent - animated shimmer */
.agent-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: headerShimmer 4s ease-in-out infinite;
}

@keyframes headerShimmer {
  0%, 100% { left: -100%; }
  50% { left: 150%; }
}

.agent-icon {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.3);
  position: relative;
}

/* Subtle pulsing glow for AI indicator */
.agent-icon::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 17px;
  background: linear-gradient(135deg, var(--brand-green), var(--brand-green-dark));
  opacity: 0;
  z-index: -1;
  animation: iconGlow 3s ease-in-out infinite;
}

@keyframes iconGlow {
  0%, 100% { opacity: 0; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(1.05); }
}

.agent-title h2 {
  margin: 0;
  font-size: 1.4rem;
  color: var(--text-primary);
}

.agent-title p {
  margin: 4px 0 0;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.agent-status {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(34, 197, 94, 0.1);
  border-radius: 20px;
  font-size: 0.75rem;
  color: #16a34a;
}

.agent-status .status-dot {
  width: 8px;
  height: 8px;
  background: #22c55e;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.agent-quick-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.quick-action {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  font-size: 0.8rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

.quick-action:hover {
  border-color: var(--brand-green);
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
}

.quick-icon {
  font-size: 0.9rem;
}

.agent-input-area {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.agent-input-area textarea {
  flex: 1;
  padding: 14px 16px;
  border: 2px solid var(--border-light);
  border-radius: 12px;
  font-family: inherit;
  font-size: 0.95rem;
  resize: none;
  transition: border-color 0.2s;
}

.agent-input-area textarea:focus {
  outline: none;
  border-color: var(--brand-green);
  box-shadow: 0 0 0 3px var(--brand-green-light);
}

.agent-submit-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 24px;
  background: linear-gradient(135deg, var(--btn-green) 0%, var(--brand-green) 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-family: inherit;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.agent-submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-brand);
}

.agent-submit-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.agent-results {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 24px;
  min-height: 300px;
}

/* Tools Showcase - Welcome State */
.agent-welcome {
  padding: 20px 0;
}

.agent-welcome-header {
  text-align: center;
  margin-bottom: 24px;
}

.agent-welcome-header h3 {
  color: var(--text-primary);
  margin: 0 0 8px 0;
  font-size: 1.2rem;
}

.agent-welcome-header p {
  color: var(--text-secondary);
  margin: 0;
  font-size: 0.9rem;
}

/* Tools Grid */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

/* Tool Card */
.tool-card {
  background: var(--bg-white);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 16px;
  transition: all 0.2s ease;
}

.tool-card:hover {
  border-color: var(--brand-green);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.15);
}

.tool-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.tool-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

/* Icon color variants */
.tool-icon.search { background: #e0f2fe; color: #0284c7; }
.tool-icon.details { background: #fef3c7; color: #d97706; }
.tool-icon.compare { background: #f3e8ff; color: #9333ea; }
.tool-icon.understaffed { background: #fee2e2; color: #dc2626; }
.tool-icon.region { background: #d1fae5; color: #059669; }
.tool-icon.segment { background: #fce7f3; color: #db2777; }
.tool-icon.network { background: #e0e7ff; color: #4f46e5; }
.tool-icon.trend { background: #ccfbf1; color: #0d9488; }
.tool-icon.priority { background: #ffedd5; color: #ea580c; }
.tool-icon.report { background: #f1f5f9; color: #475569; }
.tool-icon.city { background: #fef9c3; color: #ca8a04; }
.tool-icon.overview { background: var(--brand-green-light); color: var(--brand-green-dark); }

.tool-card-title {
  flex: 1;
}

.tool-card-title h4 {
  margin: 0;
  font-size: 0.95rem;
  color: var(--text-primary);
  font-weight: 600;
}

.tool-card-title p {
  margin: 2px 0 0;
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Sample Questions */
.tool-samples {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.sample-question {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-subtle);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-align: left;
  width: 100%;
}

.sample-question:hover {
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
}

.sample-question:hover .sample-arrow {
  transform: translateX(3px);
  opacity: 1;
}

.sample-icon {
  font-size: 0.9rem;
  opacity: 0.7;
}

.sample-text {
  flex: 1;
  line-height: 1.3;
}

.sample-arrow {
  font-size: 0.8rem;
  opacity: 0;
  transition: all 0.15s ease;
}

/* Collapsible tools section */
.tools-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  margin-top: 16px;
  background: transparent;
  border: 1px dashed var(--border-light);
  border-radius: 8px;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 0.8rem;
  width: 100%;
  transition: all 0.2s;
  font-family: inherit;
}

.tools-toggle:hover {
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
  background: var(--brand-green-light);
}

.tools-toggle svg {
  transition: transform 0.2s;
}

.tools-toggle.expanded svg {
  transform: rotate(180deg);
}

.tools-extra {
  display: none;
  margin-top: 16px;
}

.tools-extra.visible {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

/* Back to tools button */
.back-to-tools {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  margin-bottom: 16px;
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.back-to-tools:hover {
  border-color: var(--brand-green);
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
}

.back-to-tools svg {
  width: 14px;
  height: 14px;
}

.agent-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  padding: 40px;
  color: var(--text-secondary);
}

.agent-loading .spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-light);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.agent-response {
  line-height: 1.7;
}

.agent-response p {
  margin: 0 0 12px 0;
}

.agent-response p:last-child {
  margin-bottom: 0;
}

.agent-response h1, .agent-response h2, .agent-response h3 {
  margin-top: 20px;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.agent-response h1:first-child,
.agent-response h2:first-child,
.agent-response h3:first-child {
  margin-top: 0;
}

.agent-response ul, .agent-response ol {
  margin: 12px 0;
  padding-left: 24px;
}

.agent-response li {
  margin-bottom: 6px;
}

.agent-response hr {
  border: none;
  border-top: 1px solid var(--border-light);
  margin: 20px 0;
}

.agent-response blockquote {
  border-left: 3px solid var(--brand-green);
  margin: 12px 0;
  padding: 8px 16px;
  background: var(--brand-green-light);
  color: var(--text-secondary);
}

.agent-response code {
  background: var(--bg-subtle);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.9em;
}

.agent-response table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.9rem;
}

.agent-response th, .agent-response td {
  padding: 10px 12px;
  border: 1px solid var(--border-light);
  text-align: left;
}

.agent-response th {
  background: var(--bg-subtle);
  font-weight: 600;
}

.agent-response pre {
  background: var(--bg-subtle);
  padding: 16px;
  border-radius: 8px;
  overflow-x: auto;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.85rem;
}

.agent-tools-used {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.agent-tools-used span {
  display: inline-block;
  padding: 4px 8px;
  background: var(--brand-green-light);
  color: var(--brand-green-dark);
  border-radius: 4px;
  margin-right: 8px;
  margin-top: 8px;
}

/* ============================================
   NETWORK DASHBOARD
   ============================================ */

/* Hero Stat - Revenue at Risk */
.hero-stat {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.12) 0%, rgba(185, 28, 28, 0.18) 100%);
  border: 1px solid rgba(220, 38, 38, 0.25);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
  animation: fadeUp 0.5s ease-out;
}

.hero-stat::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -30%;
  width: 60%;
  height: 150%;
  background: radial-gradient(circle, rgba(220, 38, 38, 0.08) 0%, transparent 70%);
  pointer-events: none;
}

.hero-stat-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #b91c1c;
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.hero-stat-label::before {
  content: '⚠';
  font-size: 0.9rem;
}

.hero-stat-value {
  font-size: 2.8rem;
  font-weight: 800;
  color: #dc2626;
  line-height: 1;
  animation: heroReveal 0.8s ease-out;
}

.hero-stat-value.pulse {
  animation: heroPulse 0.6s ease-out;
}

@keyframes heroReveal {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes heroPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}

.hero-stat-detail {
  font-size: 0.85rem;
  color: #b91c1c;
  margin-top: 8px;
  opacity: 0.9;
}

/* Quick Stats Row */
.quick-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.quick-stat {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 14px 12px;
  text-align: center;
  border: 1px solid var(--border-light);
  animation: fadeUp 0.4s ease-out backwards;
}

.quick-stat:nth-child(1) { animation-delay: 0.1s; }
.quick-stat:nth-child(2) { animation-delay: 0.15s; }
.quick-stat:nth-child(3) { animation-delay: 0.2s; }

.quick-stat-value {
  font-size: 1.4rem;
  font-weight: 700;
}

.quick-stat-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 2px;
}

.quick-stat.urgent .quick-stat-value { color: #dc2626; }
.quick-stat.monitor .quick-stat-value { color: #22c55e; }
.quick-stat.optimize .quick-stat-value { color: #eab308; }

/* Legacy summary-bar (keep for compatibility) */
.summary-bar {
  display: none;
}

.summary-stat {
  flex: 1;
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
}

.summary-stat .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--brand-green);
}

.summary-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-stat.balanced .value {
  color: var(--brand-green);
}

.segment-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.segment-table th {
  text-align: left;
  padding: 10px 8px;
  border-bottom: 2px solid var(--border-light);
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.segment-table th:not(:first-child) {
  text-align: right;
}

.segment-table td {
  padding: 12px 8px;
  border-bottom: 1px solid var(--border-light);
}

.segment-table td:not(:first-child) {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.segment-table tr:last-child td {
  border-bottom: none;
}

.segment-table .segment-name {
  font-weight: 600;
  color: var(--text-primary);
}

.segment-table .total-row {
  background: var(--bg-subtle);
  font-weight: 700;
}

.segment-table .total-row td {
  border-bottom: none;
}

.status-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-badge.ok {
  background: rgba(120, 190, 32, 0.15);
  color: var(--brand-green-dark);
}

.status-badge.warning {
  background: rgba(245, 158, 11, 0.15);
  color: #b45309;
}

.outlier-section {
  margin-top: 8px;
}

.outlier-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  cursor: pointer;
  border-bottom: 1px solid var(--border-light);
}

.outlier-header h4 {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.outlier-count {
  background: var(--bg-subtle);
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.outlier-arrow {
  transition: transform 0.2s;
}

.outlier-header.expanded .outlier-arrow {
  transform: rotate(180deg);
}

.outlier-list {
  display: none;
  padding: 8px 0;
}

.outlier-list.expanded {
  display: block;
}

/* Priority Dashboard Styles */
.priority-card {
  padding: 0;
  overflow: hidden;
}

.priority-card > .card-title {
  padding: 16px 20px 12px;
  margin: 0;
  border-bottom: 1px solid var(--border-light);
}

.priority-section {
  border-bottom: 1px solid var(--border-light);
  animation: fadeUp 0.4s ease-out backwards;
}

.priority-section:nth-child(2) { animation-delay: 0.1s; }
.priority-section:nth-child(3) { animation-delay: 0.15s; }
.priority-section:nth-child(4) { animation-delay: 0.2s; }

.priority-section:last-child {
  border-bottom: none;
}

.priority-header {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  cursor: pointer;
  gap: 12px;
  transition: background 0.15s;
}

.priority-header:hover {
  background: var(--bg-subtle);
}

.priority-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 700;
  flex-shrink: 0;
  color: white;
}

.priority-icon.urgent {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.priority-icon.monitor {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.priority-icon.optimize {
  background: linear-gradient(135deg, #eab308, #ca8a04);
}

.priority-header-content {
  flex: 1;
  min-width: 0;
}

.priority-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
}

.priority-count {
  background: var(--bg-subtle);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.priority-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
  display: block;
}

.priority-total {
  font-size: 0.9rem;
  font-weight: 700;
  text-align: right;
}

.priority-total.urgent { color: #dc2626; }
.priority-total.monitor { color: #22c55e; }
.priority-total.optimize { color: #eab308; }

.priority-arrow {
  color: var(--text-muted);
  font-size: 0.75rem;
  transition: transform 0.2s;
  margin-left: 8px;
}

.priority-section.expanded .priority-arrow {
  transform: rotate(180deg);
}

.priority-list {
  display: none;
  padding: 0 12px 12px;
}

.priority-section.expanded .priority-list {
  display: block;
}

.priority-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  background: var(--bg-subtle);
  border-radius: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.15s;
  gap: 12px;
  animation: listItemSlide 0.3s ease-out backwards;
}

/* Category background colors - subtle, uniform */
.priority-item.urgent { background: rgba(220, 38, 38, 0.08); }
.priority-item.monitor { background: rgba(34, 197, 94, 0.08); }
.priority-item.optimize { background: rgba(234, 179, 8, 0.08); }

.priority-item:nth-child(1) { animation-delay: 0.05s; }
.priority-item:nth-child(2) { animation-delay: 0.1s; }
.priority-item:nth-child(3) { animation-delay: 0.15s; }
.priority-item:nth-child(4) { animation-delay: 0.2s; }
.priority-item:nth-child(5) { animation-delay: 0.25s; }

@keyframes listItemSlide {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.priority-item:last-child {
  margin-bottom: 0;
}

.priority-item:hover {
  transform: translateX(4px);
}

.priority-item.urgent:hover { background: rgba(220, 38, 38, 0.12); }
.priority-item.monitor:hover { background: rgba(34, 197, 94, 0.12); }
.priority-item.optimize:hover { background: rgba(234, 179, 8, 0.12); }

.priority-item:hover .priority-item-action {
  opacity: 1;
}

.priority-item-rank {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--bg-card);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  flex-shrink: 0;
  z-index: 1;
}

.priority-item-info {
  flex: 1;
  min-width: 0;
  z-index: 1;
}

.priority-item-name {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.priority-item-id {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 400;
}

.priority-item-detail {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Severity mini-bar */
.severity-bar {
  width: 40px;
  height: 4px;
  background: var(--border-light);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
  display: inline-block;
}

.severity-bar-fill {
  height: 100%;
  border-radius: 2px;
}

.severity-bar-fill.urgent { background: #dc2626; }
.severity-bar-fill.monitor { background: #22c55e; }
.severity-bar-fill.optimize { background: #eab308; }

.priority-item-value {
  font-weight: 700;
  font-size: 0.9rem;
  text-align: right;
  z-index: 1;
}

.priority-item-value.loss,
.priority-item-value.urgent {
  color: #dc2626;
}

.priority-item-value.save,
.priority-item-value.optimize {
  color: #eab308;
}

.priority-item-value.growth,
.priority-item-value.monitor {
  color: #22c55e;
}

.priority-item-action {
  opacity: 0;
  background: var(--brand-green);
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s, background 0.15s;
  z-index: 1;
  font-family: inherit;
}

.priority-item-action:hover {
  background: var(--brand-green-dark);
}

.priority-item-type {
  font-size: 0.7rem;
  color: var(--text-muted);
  background: var(--bg-card);
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  margin-top: 2px;
}

.priority-item-subtitle {
  font-size: 0.7rem;
  color: var(--text-muted);
  display: block;
  margin-top: 2px;
}

/* Legacy styles for compatibility */
.summary-stat.priority-urgent {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(220, 38, 38, 0.05));
  border: 1px solid rgba(220, 38, 38, 0.3);
}

.summary-stat.priority-urgent .value {
  color: #dc2626;
}

/* Remove old section backgrounds */
.priority-urgent-section,
.priority-optimize-section,
.priority-monitor-section {
  background: none;
  border-left: none;
}

.outlier-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: var(--bg-subtle);
  border-radius: 8px;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.outlier-item:last-child {
  margin-bottom: 0;
}

.outlier-info {
  flex: 1;
}

.outlier-name {
  font-weight: 600;
  color: var(--text-primary);
}

.outlier-type {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.outlier-diff {
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
}

.outlier-diff.positive {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.outlier-diff.negative {
  background: rgba(59, 130, 246, 0.1);
  color: #2563eb;
}

.outlier-item {
  cursor: pointer;
  transition: background 0.2s;
}

.outlier-item:hover {
  background: var(--brand-green-light);
}

.outlier-chat-icon {
  width: 28px;
  height: 28px;
  background: var(--brand-green);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  margin-right: 8px;
  flex-shrink: 0;
}

.loading-spinner {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.loading-spinner::before {
  content: '';
  width: 32px;
  height: 32px;
  border: 3px solid var(--border-light);
  border-top-color: var(--brand-green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 12px;
}

/* ============================================
   AI CHAT ASSISTANT
   ============================================ */
.chat-trigger {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(120, 190, 32, 0.4);
  font-size: 1.5rem;
  display: none;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}

.chat-trigger:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(120, 190, 32, 0.5);
}

.chat-trigger.visible {
  display: flex;
}

.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 24px;
  width: 480px;
  max-width: calc(100vw - 48px);
  max-height: calc(100vh - 120px);
  background: var(--bg-card);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  border: 1px solid var(--border-light);
  display: none;
  flex-direction: column;
  z-index: 1001;
  overflow: hidden;
  animation: chatSlideUp 0.3s ease-out;
}

.chat-panel.open {
  display: flex;
}

@keyframes chatSlideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-header {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header h3 {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
}

.chat-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.chat-close:hover {
  background: rgba(255,255,255,0.3);
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  max-height: 400px;
  min-height: 150px;
}

.chat-message {
  margin-bottom: 12px;
  animation: fadeUp 0.3s ease-out;
}

.chat-message.user {
  text-align: right;
}

.chat-message .bubble {
  display: inline-block;
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 0.85rem;
  line-height: 1.5;
  text-align: left;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.chat-message.user .bubble {
  background: var(--brand-green);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-message.assistant .bubble {
  background: var(--bg-subtle);
  color: var(--text-primary);
  border-bottom-left-radius: 4px;
}

.chat-message.assistant .bubble strong {
  color: var(--brand-green-dark);
}

/* Micro chart styling in AI responses */
.chat-message .risk-text {
  color: #dc2626;
  font-weight: 600;
}

.chat-message .bar-filled {
  color: var(--brand-green);
}

.chat-message .bar-empty {
  color: var(--border-medium);
  opacity: 0.6;
}

/* Also style bars in agent responses */
.agent-response .bar-filled {
  color: var(--brand-green);
}

.agent-response .bar-empty {
  color: var(--border-medium);
  opacity: 0.6;
}

.chat-input-area {
  padding: 12px 16px;
  border-top: 1px solid var(--border-light);
  display: flex;
  gap: 8px;
}

.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1.5px solid var(--border-medium);
  border-radius: 24px;
  font-size: 0.85rem;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}

.chat-input:focus {
  border-color: var(--brand-green);
}

.chat-send {
  width: 40px;
  height: 40px;
  background: var(--brand-green);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.chat-send:hover {
  background: var(--brand-green-dark);
}

.chat-send:disabled {
  background: var(--border-medium);
  cursor: not-allowed;
}

.chat-typing {
  display: flex;
  gap: 4px;
  padding: 10px 14px;
}

.chat-typing span {
  width: 8px;
  height: 8px;
  background: var(--border-medium);
  border-radius: 50%;
  animation: typingDot 1.4s infinite ease-in-out;
}

.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingDot {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

.chat-suggestions {
  padding: 0 16px 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.chat-suggestion {
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 6px 12px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.chat-suggestion:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
}

/* Agent mode styling - unified with brand */
.chat-suggestion.agent {
  background: linear-gradient(135deg, rgba(120, 190, 32, 0.15) 0%, rgba(120, 190, 32, 0.08) 100%);
  border-color: var(--brand-green);
  color: var(--brand-green-dark);
}

.chat-suggestion.agent:hover {
  background: linear-gradient(135deg, rgba(120, 190, 32, 0.25) 0%, rgba(120, 190, 32, 0.15) 100%);
  border-color: var(--brand-green-dark);
}

.agent-toggle {
  background: var(--bg-subtle);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
}

.agent-toggle:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  color: var(--brand-green);
}

.agent-toggle.active {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  border-color: var(--brand-green-dark);
  color: white;
}

.agent-mode-indicator {
  background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
  color: white;
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 8px;
}

/* ============================================
   SIMULATION - Simplified (2 questions)
   ============================================ */
/* Simulation section - unified with position charts */
.sim-section {
  padding: 0;
  margin-bottom: 18px;
}

.sim-section:last-of-type {
  margin-bottom: 0;
}

.sim-row {
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  gap: 12px;
}

.sim-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.sim-input-value {
  font-weight: 700;
  color: var(--brand-green);
  margin-left: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sim-input-value.visible {
  opacity: 1;
}

.sim-input-value.negative {
  color: #dc2626;
}

.sim-slider-wrap {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sim-slider {
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
  height: 8px;
  background: linear-gradient(90deg, var(--border-light) 0%, var(--brand-green-light) 50%, var(--border-light) 100%);
  border-radius: 4px;
  cursor: pointer;
  transition: box-shadow 0.2s;
}

.sim-slider:focus {
  outline: none;
}

.sim-slider:active {
  box-shadow: 0 0 0 4px rgba(120, 190, 32, 0.2);
}

.sim-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  border: 2px solid white;
  border-radius: 50%;
  cursor: grab;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: transform 0.15s;
}

.sim-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.sim-slider:active::-webkit-slider-thumb {
  cursor: grabbing;
}

.sim-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--brand-green);
  border: 2px solid white;
  border-radius: 50%;
  cursor: grab;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.sim-range-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.65rem;
  color: var(--text-muted);
}

/* Result - matches position-result style */
.sim-result {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.sim-result-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--brand-green);
  transition: color 0.2s;
}

.sim-result.negative .sim-result-value {
  color: #dc2626;
}

.sim-result.zero .sim-result-value {
  color: var(--text-muted);
}

.sim-result-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--brand-green);
}

.sim-result.negative .sim-result-indicator {
  background: #dc2626;
}

.sim-result.zero .sim-result-indicator {
  background: var(--text-muted);
}

/* Summary section - cleaner style */
.sim-summary {
  margin-top: 18px;
  padding: 16px;
  background: var(--bg-subtle);
  border-radius: 8px;
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  gap: 12px;
}

.sim-summary-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.sim-summary-breakdown {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.sim-summary-arrow {
  color: var(--text-muted);
}

.sim-summary-new {
  font-weight: 600;
  color: var(--text-primary);
}

.sim-summary-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--brand-green);
  text-align: center;
}

.sim-summary-value.negative {
  color: #dc2626;
}

.sim-summary-value.pulse {
  animation: simPulse 0.3s ease-out;
}

@keyframes simPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.sim-reset-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 4px 10px;
  font-size: 0.75rem;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}
.sim-reset-btn:hover {
  background: var(--card-bg);
  color: var(--text);
}

.btn-new-pharmacy {
  padding: 12px 16px;
  background: var(--bg-subtle);
  border: 1.5px dashed var(--border-medium);
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn-new-pharmacy:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  border-style: solid;
  color: var(--brand-green);
}
.btn-new-pharmacy svg {
  width: 16px;
  height: 16px;
}

.sim-charts {
  display: flex;
  flex-direction: column;
  gap: 18px;
  max-width: 100%;
  margin: 0 auto;
}

/* ============================================
   FTE IMPACT SIMULATION
   ============================================ */
.impact-card {
  background: var(--bg-subtle);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 12px;
}

.impact-title {
  font-weight: 600;
  font-size: 0.85rem;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.impact-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  margin-bottom: 4px;
}

.impact-row.highlight {
  font-weight: 700;
  font-size: 1rem;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--border-light);
}

.impact-row .positive { color: var(--brand-green); }
.impact-row .negative { color: #dc2626; }
.impact-row .warning { color: #f59e0b; }

.info-note {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 12px;
  padding: 8px 12px;
  background: #fef3c7;
  border-radius: 6px;
}

/* ============================================
   SEGMENT POSITION CHARTS (Enhanced)
   ============================================ */
.position-charts {
  display: flex;
  flex-direction: column;
  gap: 18px;
  max-width: 100%;
  margin: 0 auto;
}

.position-row {
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  gap: 12px;
}

.position-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.position-track-wrapper {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.position-track {
  position: relative;
  height: 8px;
  background: var(--bg-subtle);
  border-radius: 4px;
  transition: height 0.2s ease;
}

.position-range {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(90deg, var(--border-light) 0%, var(--brand-green-light) 50%, var(--border-light) 100%);
  border-radius: 4px;
  transition: opacity 0.2s ease;
}

.track-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.65rem;
  color: var(--text-muted);
}

/* Histogram overlay - visible on hover */
.position-histogram {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: flex-end;
  gap: 1px;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.position-row:hover .position-histogram {
  opacity: 1;
}

.position-row:hover .position-track:not(.zone-track) {
  height: 28px;
}

.position-row:hover .position-range {
  opacity: 0.3;
}

.histogram-bar {
  flex: 1;
  background: var(--brand-green);
  opacity: 0.6;
  border-radius: 1px 1px 0 0;
  min-height: 1px;
}

.position-marker {
  position: absolute;
  top: 50%;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: transform 0.2s;
  z-index: 2;
}

.position-marker.avg {
  background: white;
  border: 2px solid var(--text-muted);
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.position-marker.you {
  background: var(--brand-green);
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(120, 190, 32, 0.5);
  z-index: 3;
}

/* Result column with value + indicator + tooltip */
.position-result {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  position: relative;
  cursor: help;
}

.position-value {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-primary);
}

.position-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  font-size: 0.7rem;
  font-weight: 700;
}

.position-indicator.positive {
  background: rgba(22, 163, 74, 0.12);
  color: var(--positive);
}

.position-indicator.negative {
  background: rgba(220, 38, 38, 0.12);
  color: var(--negative);
}

.position-indicator.neutral {
  background: rgba(107, 114, 128, 0.1);
  color: var(--neutral);
}

/* Tooltip on hover */
.position-tooltip {
  display: none;
  position: absolute;
  right: 0;
  top: calc(100% + 8px);
  background: var(--text-primary);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.75rem;
  white-space: nowrap;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.position-tooltip::before {
  content: '';
  position: absolute;
  bottom: 100%;
  right: 16px;
  border: 6px solid transparent;
  border-bottom-color: var(--text-primary);
}

.position-result:hover .position-tooltip {
  display: block;
}

/* Zone-based tracks (Produktivita, Trend) */
.zone-track {
  display: flex;
  overflow: hidden;
  height: 10px !important;
}

.zone-track:hover {
  height: 10px !important;
}

.zone {
  flex: 1;
  height: 100%;
}

.zone-low, .zone-declining {
  background: rgba(220, 38, 38, 0.15);
  border-radius: 4px 0 0 4px;
}

.zone-avg, .zone-stable {
  background: rgba(107, 114, 128, 0.12);
}

.zone-high, .zone-growing {
  background: rgba(22, 163, 74, 0.15);
  border-radius: 0 4px 4px 0;
}

/* Zone labels in result */
.zone-label {
  font-size: 0.85rem !important;
  font-weight: 600 !important;
}

.zone-label.high, .zone-label.growing {
  color: var(--positive);
}

.zone-label.avg, .zone-label.stable {
  color: var(--neutral);
}

.zone-label.low, .zone-label.declining {
  color: var(--negative);
}

/* Three-label track for zones */
.position-track-wrapper:has(.zone-track) .track-labels {
  justify-content: space-around;
}

/* Separator */
.position-separator {
  height: 1px;
  background: var(--border-light);
  margin: 4px 0;
}

/* Legend */
.position-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.legend-dot.avg {
  background: white;
  border: 2px solid var(--text-muted);
}

.legend-dot.you {
  background: var(--brand-green);
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(120, 190, 32, 0.4);
}

@media (max-width: 480px) {
  .position-row {
    grid-template-columns: 70px 1fr 90px;
    gap: 8px;
  }
  .position-value {
    font-size: 0.85rem;
  }
  .track-labels {
    font-size: 0.6rem;
  }
}

/* ============================================
   PHARMACY SELECTOR
   ============================================ */
.pharmacy-selector label {
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 6px;
  display: block;
  color: var(--text-secondary);
}

.pharmacy-id-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
}

.pharmacy-id-row input {
  width: 100px;
}

.btn-load {
  padding: 12px 16px;
  background: var(--bg-subtle);
  border: 1.5px solid var(--border-medium);
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.btn-load:hover {
  background: var(--brand-green-light);
  border-color: var(--brand-green);
  color: var(--brand-green);
}

.pharmacy-hint {
  font-size: 0.95rem;
  color: var(--text-muted);
  margin-left: 12px;
}

.pharmacy-hint.loaded {
  color: var(--brand-green);
  font-weight: 600;
}

.pharmacy-hint.error {
  color: #dc2626;
}

/* Revenue Loss Display - only shown for above-average productivity pharmacies */
.revenue-loss {
  margin: 16px 0 20px 0;
  padding: 14px 18px;
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.12) 0%, rgba(185, 28, 28, 0.18) 100%);
  border: 1px solid rgba(220, 38, 38, 0.3);
  border-radius: 12px;
  color: #b91c1c;
  text-align: center;
  animation: fadeUp 0.5s ease-out 0.1s backwards, heartbeat 0.8s ease-in-out 0.7s;
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
}

/* Heartbeat animation - single dramatic pulse */
@keyframes heartbeat {
  0% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
  15% {
    transform: scale(1.04);
    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.25);
  }
  30% {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
  45% {
    transform: scale(1.02);
    box-shadow: 0 3px 14px rgba(220, 38, 38, 0.18);
  }
  60%, 100% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
  }
}

.revenue-loss-header {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  opacity: 0.9;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.revenue-loss-header::before {
  content: '⚠';
  font-size: 0.85rem;
}

.revenue-loss-value {
  font-size: 1.25rem;
  font-weight: 700;
  letter-spacing: -0.01em;
}

.revenue-loss-note {
  font-size: 0.7rem;
  opacity: 0.75;
  margin-top: 6px;
  font-style: italic;
}

/* Revenue Teaser - show problem, hide solution */
.revenue-teaser {
  margin: 16px 0;
  padding: 20px;
  background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
  border-radius: 14px;
  color: #f9fafb;
  text-align: center;
}

.teaser-header {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: #f87171;
  margin-bottom: 8px;
  text-transform: uppercase;
}

.teaser-value {
  font-size: 1.6rem;
  font-weight: 700;
  color: #fca5a5;
  margin-bottom: 16px;
}

.teaser-bars {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.teaser-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.teaser-bar-label {
  font-size: 0.75rem;
  color: #9ca3af;
  width: 90px;
  text-align: right;
}

.teaser-bar-track {
  flex: 1;
  height: 8px;
  background: #374151;
  border-radius: 4px;
  overflow: hidden;
}

.teaser-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #f87171, #dc2626);
  border-radius: 4px;
  position: relative;
}

.teaser-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent,
    transparent 4px,
    rgba(0,0,0,0.3) 4px,
    rgba(0,0,0,0.3) 8px
  );
}

.teaser-question {
  font-size: 0.9rem;
  color: #d1d5db;
  margin: 16px 0 12px;
  font-style: italic;
}

.teaser-cta {
  display: inline-block;
  background: var(--brand-green);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.85rem;
  text-decoration: none;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  border: none;
}

.teaser-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(120, 190, 32, 0.4);
}

.teaser-hint {
  font-size: 0.7rem;
  color: #6b7280;
  margin-top: 12px;
}

/* Blurred preview sections */
.teaser-blurred-section {
  margin: 16px 0;
}

.teaser-section-label {
  font-size: 0.7rem;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}

.teaser-heatmap-blur,
.teaser-schedule-blur {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
}

.blur-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  background: rgba(31, 41, 55, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Mini heatmap */
.teaser-heatmap {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 8px;
  background: #374151;
  border-radius: 8px;
}

.th-row {
  display: flex;
  gap: 2px;
}

.th-row span {
  width: 22px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  color: #9ca3af;
  border-radius: 2px;
}

.th-row span.g {
  background: #065f46;
}

.th-row span.y {
  background: #92400e;
}

.th-row span.r {
  background: #dc2626;
}

/* Mini schedule table */
.teaser-schedule {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  background: #374151;
  border-radius: 8px;
  overflow: hidden;
}

.teaser-schedule th,
.teaser-schedule td {
  padding: 8px 12px;
  text-align: center;
  color: #d1d5db;
}

.teaser-schedule th {
  background: #4b5563;
  font-weight: 600;
  color: #9ca3af;
}

.teaser-schedule td {
  border-top: 1px solid #4b5563;
}

.teaser-schedule td.warn {
  background: rgba(220, 38, 38, 0.3);
  color: #fca5a5;
  font-weight: 600;
}

/* Capacity visual bars */
.capacity-visual {
  padding: 12px;
  background: #374151;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.capacity-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.capacity-label {
  font-size: 0.7rem;
  color: #9ca3af;
  width: 70px;
  text-align: right;
  flex-shrink: 0;
}

.capacity-bar {
  flex: 1;
  height: 28px;
  background: rgba(220, 38, 38, 0.2);
  border-radius: 6px;
  display: flex;
  overflow: hidden;
  border: 1px dashed rgba(220, 38, 38, 0.4);
}

.capacity-fill {
  background: linear-gradient(135deg, #065f46 0%, #047857 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 5px 0 0 5px;
  position: relative;
}

.capacity-fill.critical {
  background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
}

.capacity-icons {
  font-size: 0.75rem;
  letter-spacing: 2px;
}

.capacity-gap {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 4px,
    rgba(220, 38, 38, 0.15) 4px,
    rgba(220, 38, 38, 0.15) 8px
  );
}

.capacity-gap.critical {
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 4px,
    rgba(220, 38, 38, 0.3) 4px,
    rgba(220, 38, 38, 0.3) 8px
  );
}

.gap-icon {
  font-size: 0.85rem;
}

.capacity-pct {
  font-size: 0.75rem;
  font-weight: 700;
  width: 36px;
  text-align: right;
  flex-shrink: 0;
}

.capacity-pct.warn {
  color: #fbbf24;
}

.capacity-pct.critical {
  color: #f87171;
}

/* CSV export button styling */
.btn-export-csv {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border-medium);
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
  margin-left: 8px;
}
.btn-export-csv:hover {
  background: var(--bg-subtle);
  color: var(--text-secondary);
}

/* Toast notifications */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  background: #dc2626;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-size: 0.9rem;
  animation: toastSlideIn 0.3s ease-out;
  max-width: 350px;
}
.toast.success { background: #16a34a; }
.toast.warning { background: #f59e0b; }
@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes toastFadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

</style>
</head>
<body>
<div class="toast-container" id="toast-container"></div>
<div class="container">
  <div class="header animate-in">
    <h1><img src="/static/images/drmax-logo.svg" alt="Dr.Max" class="header-logo"> FTE Kalkulačka</h1>
    <p class="subtitle">Overte obsadenie lekárne — kde strácate tržby a brzdíte rast?</p>
    <button onclick="document.getElementById('about-modal').style.display='flex'" style="
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: 1px solid var(--border-light);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    " title="About">ⓘ</button>
  </div>

  <!-- About Modal -->
  <div id="about-modal" onclick="if(event.target===this)this.style.display='none'" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
  ">
    <div style="
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
    ">
      <button onclick="document.getElementById('about-modal').style.display='none'" style="
        position: absolute;
        top: 12px;
        right: 12px;
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--text-muted);
      ">×</button>
      <h2 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 1.25rem;">O aplikácii</h2>
      <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
        <p style="margin: 0 0 12px 0;"><strong>FTE Kalkulačka</strong></p>
        <p style="margin: 0 0 12px 0;">ML model pre optimálne plánovanie personálu v lekárňach.</p>
        <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
          Verzia 5.1
        </p>
      </div>
    </div>
  </div>

  <!-- TAB NAVIGATION -->
  <div class="tab-nav animate-in">
    <button class="tab-btn active" data-tab="calculator">Kalkulačka</button>
    <button class="tab-btn" data-tab="analyza">Porovnanie</button>
    <button class="tab-btn" data-tab="network">Prehľad</button>
    <button class="tab-btn agent-tab" data-tab="agent">AI Asistent</button>
  </div>

  <!-- CALCULATOR TAB -->
  <div id="tab-calculator" class="tab-content active">

  <!-- FACTS -->
  <div class="card animate-in">
    <div class="card-title">Parametre lekárne</div>

    <label>Lekáreň ID</label>
    <div class="pharmacy-id-row">
      <input type="number" id="pharmacy-id-input" placeholder="ID" min="1">
      <button type="button" id="pharmacy-load-btn" class="btn-load">Načítať</button>
      <button type="button" class="btn-new-pharmacy" id="btn-new-pharmacy" title="Vymazať formulár a zadať parametre novej/plánovanej lekárne">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        Nová
      </button>
      <span class="pharmacy-hint" id="pharmacy-hint"></span>
    </div>

    <label>Typ lekárne</label>
    <select id="typ">
      <option>A - shopping premium</option>
      <option>B - shopping</option>
      <option>C - street +</option>
      <option>D - street</option>
      <option>E - poliklinika</option>
    </select>

    <div class="form-row" style="gap: 12px;">
      <div class="tooltip-wrapper">
        <span class="tooltip-text" id="bloky-tooltip">Bloky za rok (v tisícoch)</span>
        <label>Bloky (tis.)</label>
        <input id="bloky" type="number" value="60" step="1">
      </div>
      <div class="tooltip-wrapper">
        <span class="tooltip-text" id="trzby-tooltip">Tržby za rok (v miliónoch €)</span>
        <label>Tržby (mil. €)</label>
        <input id="trzby" type="number" value="1.2" step="0.1">
      </div>
    </div>

    <div class="form-row" style="gap: 12px; margin-top: 16px;">
      <div class="tooltip-wrapper">
        <span class="tooltip-text">Podiel receptových blokov</span>
        <label>Podiel Rx</label>
        <div class="input-with-suffix">
          <input id="rx" type="number" min="20" max="90" value="50">
          <span class="input-suffix">%</span>
        </div>
      </div>
      <div class="tooltip-wrapper">
        <span class="tooltip-text">Nadpriemerná = viac transakcií/hod. ako priemer segmentu</span>
        <label>Produktivita</label>
        <div class="segmented-control">
          <div class="segment-option">
            <input type="radio" name="prod-toggle-radio" id="prod-avg" checked>
            <label for="prod-avg">Priemer</label>
          </div>
          <div class="segment-option high-productivity">
            <input type="radio" name="prod-toggle-radio" id="prod-high">
            <label for="prod-high">Nad</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="btn animate-in" id="calc">Vypočítať</button>

  <!-- RESULT -->
  <div id="result" style="display:none;">
    <div class="result-divider"></div>
    
    <div class="result-main">
      <div class="val-row">
        <div class="val" id="fte-total">-</div>
        <div class="val-vs" id="val-vs" style="display:none;">
          <span class="val-vs-text">vs</span>
          <span class="val" id="fte-actual">-</span>
        </div>
      </div>
      <div class="label" id="fte-label">Odporúčané FTE</div>
      <div class="range" id="fte-range"></div>
    </div>

    <!-- Revenue Loss Display (Kahneman loss framing) -->
    <div class="revenue-loss" id="revenue-loss" style="display:none; position: relative;">
      <button onclick="this.parentElement.style.display='none'" style="position: absolute; top: 8px; right: 12px; background: transparent; border: none; cursor: pointer; color: #b91c1c; font-size: 20px; font-weight: 700; opacity: 0.5;">×</button>
      <div id="revenue-loss-content"></div>
    </div>


    <!-- Distribution comparison -->
    <div class="distribution-box" id="distribution-box" style="display:none;">
      <div class="dist-header">
        <span class="dist-label">Podobné lekárne (<span id="dist-count">0</span>)</span>
      </div>
      <div class="dist-bar-container" id="dist-bar-container">
        <div class="dist-bar-bg"></div>
        <div class="dist-bar-range" id="dist-range"></div>
        <div id="dist-actuals"></div>
        <div class="dist-marker" id="dist-marker"></div>
      </div>
      <div class="dist-labels">
        <span id="dist-min">-</span>
        <span id="dist-max">-</span>
      </div>
    </div>

    <div class="breakdown">
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-zf">-</div>
        <div class="breakdown-lbl">Zodp. farm.</div>
        <div class="breakdown-pct" id="pct-zf"></div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-f">-</div>
        <div class="breakdown-lbl">Farmaceut</div>
        <div class="breakdown-pct" id="pct-f"></div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-val" id="fte-l">-</div>
        <div class="breakdown-lbl">Laborant</div>
        <div class="breakdown-pct" id="pct-l"></div>
      </div>
    </div>

    <div class="trust-box" id="trust-box">
      <div class="trust-title">Overené proti podobným lekárňam</div>
      <div class="trust-content">Nájdené prevádzky: <span id="trust-count"></span></div>
      <div class="trust-content">ID: <span id="trust-ids"></span><span id="trust-expand" class="trust-link" style="display:none;" onclick="expandIds()"> zobraziť všetky</span></div>
      <div id="trust-all-ids" style="display:none;margin-top:8px;font-size:0.8rem;color:#6b7280;word-break:break-word;"></div>
    </div>
  </div>
  </div>
  <!-- END CALCULATOR TAB -->

  <!-- NETWORK TAB (Priority Dashboard) -->
  <div id="tab-network" class="tab-content">
    <div id="network-loading" class="loading-spinner">Načítavam dáta...</div>

    <div id="network-content" style="display:none;">
      <!-- Hero Stat - Revenue at Risk -->
      <div class="hero-stat" id="hero-revenue">
        <div class="hero-stat-label">Potential Revenue at Risk</div>
        <div class="hero-stat-value" id="net-revenue-at-risk">-</div>
        <div class="hero-stat-detail" id="hero-revenue-detail">-</div>
      </div>

      <!-- Quick Stats Row -->
      <div class="quick-stats">
        <div class="quick-stat urgent">
          <div class="quick-stat-value" id="net-urgent-count">-</div>
          <div class="quick-stat-label">Revenue at Risk</div>
        </div>
        <div class="quick-stat monitor">
          <div class="quick-stat-value" id="net-monitor-count">-</div>
          <div class="quick-stat-label">Growth Alert</div>
        </div>
        <div class="quick-stat optimize">
          <div class="quick-stat-value" id="net-optimize-count">-</div>
          <div class="quick-stat-label">Potential FTE Surplus</div>
        </div>
      </div>

      <!-- Priority Sections -->
      <div class="card priority-card">
        <div class="card-title" style="margin-bottom:16px">Kde konať</div>

        <!-- URGENT: Understaffed + High Productivity = Losing Revenue -->
        <div class="priority-section priority-urgent-section">
          <div class="priority-header" onclick="togglePriority('urgent')">
            <span class="priority-icon urgent">!</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                REVENUE AT RISK
                <span class="priority-count" id="priority-urgent-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('urgent')">CSV</button>
              </h4>
              <span class="priority-subtitle">Understaffed with high productivity</span>
            </div>
            <span class="priority-total urgent" id="priority-urgent-total">-</span>
            <span class="priority-arrow" id="urgent-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-urgent-list"></div>
        </div>

        <!-- MONITOR: Growing = Watch for Future -->
        <div class="priority-section priority-monitor-section">
          <div class="priority-header" onclick="togglePriority('monitor')">
            <span class="priority-icon monitor">↑</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                GROWTH ALERT
                <span class="priority-count" id="priority-monitor-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('monitor')">CSV</button>
              </h4>
              <span class="priority-subtitle">Fast-growing pharmacies - prepare for future needs</span>
            </div>
            <span class="priority-total monitor" id="priority-monitor-total">-</span>
            <span class="priority-arrow" id="monitor-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-monitor-list"></div>
        </div>

        <!-- OPTIMIZE: Overstaffed = Can Reallocate -->
        <div class="priority-section priority-optimize-section">
          <div class="priority-header" onclick="togglePriority('optimize')">
            <span class="priority-icon optimize">↓</span>
            <div class="priority-header-content">
              <h4 class="priority-title">
                POTENTIAL FTE SURPLUS
                <span class="priority-count" id="priority-optimize-count">0</span>
                <button class="btn-export-csv" onclick="event.stopPropagation(); exportCSV('optimize')">CSV</button>
              </h4>
              <span class="priority-subtitle">Overstaffed - reallocation opportunity</span>
            </div>
            <span class="priority-total optimize" id="priority-optimize-total">-</span>
            <span class="priority-arrow" id="optimize-arrow">▼</span>
          </div>
          <div class="priority-list" id="priority-optimize-list"></div>
        </div>
      </div>

      <!-- Segment Summary (collapsed by default) -->
      <div class="card" style="background:var(--bg-subtle);border:1px dashed var(--border-medium);">
        <div class="card-title" style="cursor:pointer;" onclick="toggleSegmentTable()">
          FTE podľa segmentu <span id="segment-toggle-arrow" style="float:right;">▶</span>
        </div>
        <div id="segment-table-container" style="display:none;">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">
            Skutočné FTE (2020-21) vs. optimálne FTE vypočítané modelom
          </div>
          <table class="segment-table">
            <thead>
              <tr>
                <th>Segment</th>
                <th>Počet</th>
                <th>Skutočné</th>
                <th>Optimálne</th>
                <th>Rozdiel</th>
              </tr>
            </thead>
            <tbody id="segment-tbody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Model Info Card (collapsed by default) -->
      <div class="card" style="background:var(--bg-subtle);border:1px dashed var(--border-medium);">
        <div class="card-title" style="cursor:pointer;" onclick="toggleModelInfo()">
          O modeli <span id="model-info-arrow" style="float:right;">▶</span>
        </div>
        <div id="model-info-container" style="display:none;">
          <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;">
            <p style="margin-bottom:12px;">
              <strong>Model:</strong> ML regresný model (v5)<br>
              <strong>Presnosť:</strong> Vysoká (R² > 90%)
            </p>
            <p style="margin-bottom:12px;">
              <strong>Vstupné parametre:</strong>
            </p>
            <ul style="margin:0 0 12px 20px;padding:0;">
              <li>Objem transakcií</li>
              <li>Tržby</li>
              <li>Typ lekárne (segment)</li>
              <li>Podiel Rx receptov</li>
              <li>Produktivita vs. segment</li>
            </ul>
            <p style="margin-bottom:0;">
              <strong>Férový princíp:</strong><br>
              Efektívne lekárne sú odmenené.<br>
              Menej efektívne nie sú penalizované.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- END NETWORK TAB -->

  <!-- ANALYZA TAB -->
  <div id="tab-analyza" class="tab-content">
    <div id="analyza-empty" class="card" style="text-align:center;padding:40px;">
      <div style="font-size:2rem;margin-bottom:12px;opacity:0.5;">📊</div>
      <div style="color:var(--text-muted);">Najprv vypočítajte FTE v záložke Kalkulačka</div>
    </div>

    <div id="analyza-content" style="display:none;">
      <!-- Segment Position Charts -->
      <div class="card">
        <div class="card-title">Pozícia v segmente</div>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:20px;">
          Kde sa nachádza vaša lekáreň v rámci segmentu <strong id="segment-name">-</strong>
        </p>

        <div class="position-charts">
          <!-- Bloky position -->
          <div class="position-row" id="row-bloky">
            <div class="position-label">Bloky</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-bloky"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-bloky-avg"></div>
                <div class="position-marker you" id="pos-bloky-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-bloky-min">0</span>
                <span id="pos-bloky-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-bloky-result">
              <div class="position-value" id="pos-bloky-value">-</div>
              <div class="position-indicator neutral" id="pos-bloky-indicator">≈</div>
              <div class="position-tooltip" id="pos-bloky-tooltip"></div>
            </div>
          </div>

          <!-- Tržby position -->
          <div class="position-row" id="row-trzby">
            <div class="position-label">Tržby</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-trzby"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-trzby-avg"></div>
                <div class="position-marker you" id="pos-trzby-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-trzby-min">0</span>
                <span id="pos-trzby-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-trzby-result">
              <div class="position-value" id="pos-trzby-value">-</div>
              <div class="position-indicator neutral" id="pos-trzby-indicator">≈</div>
              <div class="position-tooltip" id="pos-trzby-tooltip"></div>
            </div>
          </div>

          <!-- Rx position -->
          <div class="position-row" id="row-rx">
            <div class="position-label">Rx %</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-rx"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-rx-avg"></div>
                <div class="position-marker you" id="pos-rx-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-rx-min">0</span>
                <span id="pos-rx-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-rx-result">
              <div class="position-value" id="pos-rx-value">-</div>
              <div class="position-indicator neutral" id="pos-rx-indicator">≈</div>
              <div class="position-tooltip" id="pos-rx-tooltip"></div>
            </div>
          </div>

          <!-- FTE position -->
          <div class="position-row" id="row-fte">
            <div class="position-label">FTE</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-fte"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-fte-avg"></div>
                <div class="position-marker you" id="pos-fte-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-fte-min">0</span>
                <span id="pos-fte-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-fte-result">
              <div class="position-value" id="pos-fte-value">-</div>
              <div class="position-indicator neutral" id="pos-fte-indicator">≈</div>
              <div class="position-tooltip" id="pos-fte-tooltip"></div>
            </div>
          </div>

          <!-- Separator -->
          <div class="position-separator"></div>

          <!-- Produktivita zone indicator -->
          <div class="position-row" id="row-efficiency">
            <div class="position-label">Produktivita</div>
            <div class="position-track-wrapper">
              <div class="position-track zone-track">
                <div class="zone zone-low"></div>
                <div class="zone zone-avg"></div>
                <div class="zone zone-high"></div>
                <div class="position-marker you" id="pos-efficiency-you"></div>
              </div>
              <div class="track-labels">
                <span>Nízka</span>
                <span>Priemerná</span>
                <span>Vysoká</span>
              </div>
            </div>
            <div class="position-result" id="pos-efficiency-result">
              <div class="position-value zone-label" id="pos-efficiency-value">-</div>
              <div class="position-indicator neutral" id="pos-efficiency-indicator">≈</div>
              <div class="position-tooltip" id="pos-efficiency-tooltip"></div>
            </div>
          </div>

          <!-- Trend zone indicator -->
          <div class="position-row" id="row-trend">
            <div class="position-label">Trend</div>
            <div class="position-track-wrapper">
              <div class="position-track zone-track">
                <div class="zone zone-declining"></div>
                <div class="zone zone-stable"></div>
                <div class="zone zone-growing"></div>
                <div class="position-marker you" id="pos-trend-you"></div>
              </div>
              <div class="track-labels">
                <span>Klesajúci</span>
                <span>Stabilný</span>
                <span>Rastúci</span>
              </div>
            </div>
            <div class="position-result" id="pos-trend-result">
              <div class="position-value zone-label" id="pos-trend-value">-</div>
              <div class="position-indicator neutral" id="pos-trend-indicator">≈</div>
              <div class="position-tooltip" id="pos-trend-tooltip"></div>
            </div>
          </div>

          <!-- Separator -->
          <div class="position-separator"></div>

          <!-- Bloky/hod position -->
          <div class="position-row" id="row-blokyhod">
            <div class="position-label">Bloky/h</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-blokyhod"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-blokyhod-avg"></div>
                <div class="position-marker you" id="pos-blokyhod-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-blokyhod-min">0</span>
                <span id="pos-blokyhod-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-blokyhod-result">
              <div class="position-value" id="pos-blokyhod-value">-</div>
              <div class="position-indicator neutral" id="pos-blokyhod-indicator">≈</div>
              <div class="position-tooltip" id="pos-blokyhod-tooltip"></div>
            </div>
          </div>

          <!-- Tržby/hod position -->
          <div class="position-row" id="row-trzbyhod">
            <div class="position-label">Tržby/h</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-trzbyhod"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-trzbyhod-avg"></div>
                <div class="position-marker you" id="pos-trzbyhod-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-trzbyhod-min">0</span>
                <span id="pos-trzbyhod-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-trzbyhod-result">
              <div class="position-value" id="pos-trzbyhod-value">-</div>
              <div class="position-indicator neutral" id="pos-trzbyhod-indicator">≈</div>
              <div class="position-tooltip" id="pos-trzbyhod-tooltip"></div>
            </div>
          </div>

          <!-- Košík position -->
          <div class="position-row" id="row-basket">
            <div class="position-label">Košík</div>
            <div class="position-track-wrapper">
              <div class="position-track">
                <div class="position-histogram" id="hist-basket"></div>
                <div class="position-range"></div>
                <div class="position-marker avg" id="pos-basket-avg"></div>
                <div class="position-marker you" id="pos-basket-you"></div>
              </div>
              <div class="track-labels">
                <span id="pos-basket-min">0</span>
                <span id="pos-basket-max">0</span>
              </div>
            </div>
            <div class="position-result" id="pos-basket-result">
              <div class="position-value" id="pos-basket-value">-</div>
              <div class="position-indicator neutral" id="pos-basket-indicator">≈</div>
              <div class="position-tooltip" id="pos-basket-tooltip"></div>
            </div>
          </div>
        </div>

        <div class="position-legend">
          <span class="legend-item"><span class="legend-dot avg"></span> Priemer segmentu</span>
          <span class="legend-item"><span class="legend-dot you"></span> Vaša lekáreň</span>
        </div>
      </div>

      <!-- Simulation - Unified with position charts -->
      <div class="card">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
          Simulácia zmien
          <button class="sim-reset-btn" id="sim-reset-btn">Reset</button>
        </div>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:20px;">
          Ako by sa zmenilo odporúčané FTE pri zmene parametrov
        </p>

        <div class="sim-charts">
          <!-- Tržby row -->
          <div class="sim-section">
            <div class="sim-row">
              <div class="sim-label">Tržby <span class="sim-input-value" id="sens-trzby-val"></span></div>
              <div class="sim-slider-wrap">
                <input type="range" class="sim-slider" id="sens-trzby" min="-20" max="30" value="0">
                <div class="sim-range-labels">
                  <span>-20%</span>
                  <span>0%</span>
                  <span>+30%</span>
                </div>
              </div>
              <div class="sim-result" id="sens-trzby-result">
                <div class="sim-result-value" id="sens-trzby-fte">0.0</div>
                <div class="sim-result-indicator"></div>
              </div>
            </div>
          </div>

          <!-- Produktivita row -->
          <div class="sim-section">
            <div class="sim-row">
              <div class="sim-label">Produktivita <span class="sim-input-value" id="sens-prod-val"></span></div>
              <div class="sim-slider-wrap">
                <input type="range" class="sim-slider" id="sens-prod" min="0" max="20" value="0">
                <div class="sim-range-labels">
                  <span>Priemer</span>
                  <span>+1σ</span>
                  <span>+2σ</span>
                </div>
              </div>
              <div class="sim-result zero" id="sens-prod-result">
                <div class="sim-result-value" id="sens-prod-fte">0.0</div>
                <div class="sim-result-indicator"></div>
              </div>
            </div>
          </div>

          <!-- Summary row -->
          <div class="sim-summary">
            <div class="sim-summary-label">Celkom</div>
            <div class="sim-summary-breakdown">
              <span id="sens-base-fte">0.0</span>
              <span class="sim-summary-arrow">→</span>
              <span class="sim-summary-new" id="sens-new-fte">0.0</span>
            </div>
            <div class="sim-summary-value" id="sens-total-fte">0.0 FTE</div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- END ANALYZA TAB -->

  <!-- AI AGENT TAB -->
  <div id="tab-agent" class="tab-content">
    <div class="agent-container">

      <!-- Agent Header -->
      <div class="agent-header">
        <div class="agent-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <!-- Sparkle/AI icon -->
            <path d="M12 2L13.09 8.26L19 7L14.74 10.91L19 17L13.09 15.74L12 22L10.91 15.74L5 17L9.26 10.91L5 7L10.91 8.26L12 2Z"/>
          </svg>
        </div>
        <div class="agent-title">
          <h2>AI Asistent</h2>
          <p>Komplexná analýza personálneho obsadenia</p>
        </div>
        <div class="agent-status" id="agent-status-indicator">
          <span class="status-dot"></span>
          <span class="status-text">Online</span>
        </div>
      </div>

      <!-- Quick Actions - compact chips -->
      <div class="agent-quick-actions">
        <button class="quick-action" data-query="Report za všetky regióny so sumárom ohrozených tržieb, skutočným a optimálnym FTE">Report všetky regióny</button>
        <button class="quick-action" data-query="Top 10 ohrozených tržieb s vysokou produktivitou">Top 10 riziko</button>
        <button class="quick-action" data-query="Porovnaj ID 33 s podobnými lekárňami">Porovnaj ID 33</button>
        <button class="quick-action" data-query="Poddimenzované lekárne v RR15">Poddimenz. RR15</button>
      </div>

      <!-- Input Area -->
      <div class="agent-input-area">
        <textarea id="agent-input" placeholder="Opýtajte sa na analýzu personálneho obsadenia..." rows="2"></textarea>
        <button id="agent-submit" class="agent-submit-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
          Analyzovať
        </button>
      </div>

      <!-- Results Area -->
      <div class="agent-results" id="agent-results">
        <div class="agent-welcome" id="agent-welcome">
          <div class="agent-welcome-header">
            <h3>Dostupné nástroje AI Asistenta</h3>
            <p>Kliknite na príklad otázky pre okamžitú analýzu</p>
          </div>

          <!-- Primary Tools Grid -->
          <div class="tools-grid">
            <!-- Network Overview -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon overview">🌐</div>
                <div class="tool-card-title">
                  <h4>Prehľad siete</h4>
                  <p>Celkový stav všetkých lekární</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Aký je celkový prehľad siete lekární?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Aký je celkový prehľad siete?</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Koľko máme poddimenzovaných a naddimenzovaných lekární?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Koľko lekární je pod/naddimenzovaných?</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Priority Actions -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon priority">🎯</div>
                <div class="tool-card-title">
                  <h4>Prioritné akcie</h4>
                  <p>Čo riešiť ako prvé</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Ktoré lekárne by sme mali riešiť ako prvé?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Čo riešiť najskôr?</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Top 10 lekární podľa priority s najvyšším rizikom">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Top 10 priorít podľa rizika</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Compare to Peers -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon compare">⚖️</div>
                <div class="tool-card-title">
                  <h4>Porovnanie s peers</h4>
                  <p>Benchmarking s podobnými lekárňami</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Porovnaj lekáreň ID 33 s podobnými lekárňami v segmente">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Porovnaj ID 33 s podobnými</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Nájdi lekárne podobné ID 33, ktoré majú vyššie FTE">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Podobné s vyšším FTE</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Understaffed -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon understaffed">⚠️</div>
                <div class="tool-card-title">
                  <h4>Poddimenzované lekárne</h4>
                  <p>Lekárne s nedostatkom personálu</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Ktoré lekárne s vysokou produktivitou sú poddimenzované?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Poddimenz. s vysokou produktivitou</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Zoznam poddimenzovaných lekární zoradených podľa ohrozených tržieb">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Poddimenz. podľa ohrozených tržieb</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Regions -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon region">📍</div>
                <div class="tool-card-title">
                  <h4>Regionálna analýza</h4>
                  <p>Porovnanie regiónov</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Porovnaj všetky regióny podľa ohrozených tržieb">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Porovnaj regióny podľa rizika</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Aká je situácia v regióne RR15?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Situácia v regióne RR15</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Segments -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon segment">📊</div>
                <div class="tool-card-title">
                  <h4>Segmenty A-E</h4>
                  <p>Porovnanie typov lekární</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Porovnaj segmenty A až E podľa ohrozených tržieb a produktivity">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Porovnaj segmenty A-E</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Ktorý segment má najvyššie ohrozené tržby?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Segment s najvyšším rizikom</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Toggle for more tools -->
          <button class="tools-toggle" id="tools-toggle">
            <span>Zobraziť ďalšie nástroje (6)</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 10l5 5 5-5H7z"/>
            </svg>
          </button>

          <!-- Extra Tools (hidden by default) -->
          <div class="tools-extra" id="tools-extra">
            <!-- Search Pharmacies -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon search">🔍</div>
                <div class="tool-card-title">
                  <h4>Vyhľadávanie</h4>
                  <p>Filtrovanie lekární</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Nájdi B lekárne s viac ako 120k blokmi, ktoré sú poddimenzované">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">B lekárne nad 120k blokov</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Lekárne v Košiciach">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Lekárne v Košiciach</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Pharmacy Details -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon details">📋</div>
                <div class="tool-card-title">
                  <h4>Detail lekárne</h4>
                  <p>Kompletné informácie o prevádzke</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Aké sú detaily lekárne ID 33?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Detail lekárne ID 33</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Analyzuj lekáreň ID 74 vrátane FTE a produktivity">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Analýza ID 74</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- City Summary -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon city">🏙️</div>
                <div class="tool-card-title">
                  <h4>Mestá</h4>
                  <p>Súhrn za mesto</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Ako sú na tom lekárne v Bratislave?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Lekárne v Bratislave</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Je možný presun personálu medzi lekárňami v Košiciach?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Presun v rámci Košíc</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Trends -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon trend">📈</div>
                <div class="tool-card-title">
                  <h4>Trendy</h4>
                  <p>Rastúce a klesajúce lekárne</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Ktoré lekárne rastú najrýchlejšie?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Najrýchlejšie rastúce</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Lekárne s klesajúcim trendom transakcií">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Klesajúce lekárne</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Report -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon report">📄</div>
                <div class="tool-card-title">
                  <h4>Generovanie reportov</h4>
                  <p>Markdown reporty</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Vygeneruj report za región RR11 s odporúčaniami">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Report za región RR11</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Vytvor report pre lekárne ID 33, 36, 54">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Report pre vybrané lekárne</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>

            <!-- Overstaffed -->
            <div class="tool-card">
              <div class="tool-card-header">
                <div class="tool-icon network">👥</div>
                <div class="tool-card-title">
                  <h4>Naddimenzované</h4>
                  <p>Lekárne s prebytkom FTE</p>
                </div>
              </div>
              <div class="tool-samples">
                <button class="sample-question" data-query="Ktoré lekárne majú prebytok personálu?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Lekárne s prebytkom FTE</span>
                  <span class="sample-arrow">→</span>
                </button>
                <button class="sample-question" data-query="Odkiaľ by sme mohli presunúť personál?">
                  <span class="sample-icon">💡</span>
                  <span class="sample-text">Zdroje na presun</span>
                  <span class="sample-arrow">→</span>
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
  <!-- END AGENT TAB -->

</div>

<!-- AI Chat Assistant -->
<button class="chat-trigger" id="chat-trigger" title="Opýtať sa AI">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
  </svg>
</button>

<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>FTE AI Asistent</h3>
    <button class="chat-close" id="chat-close">&times;</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-message assistant">
      <div class="bubble">Dobrý deň, som váš FTE AI asistent. Môžem vysvetliť výpočet alebo odpovedať na otázky o personálnom odporúčaní.</div>
    </div>
  </div>
  <div class="chat-suggestions" id="chat-suggestions">
    <button class="chat-suggestion" data-q="Ako je na tom personálne ID 33?">Stav ID 33</button>
    <button class="chat-suggestion" data-q="Uveď 5 B lekární výkonom podobné ID 33, ktoré majú viac FTE">Podobné s vyšším FTE</button>
    <button class="chat-suggestion" data-q="Porovnaj ID 33 a 36">Porovnaj ID 33 vs 36</button>
  </div>
  <!-- Agent mode suggestions (hidden by default) -->
  <div class="chat-suggestions agent-suggestions" id="agent-suggestions" style="display:none;">
    <button class="chat-suggestion agent" data-q="Analyzuj všetky poddimenzované lekárne v regióne RR11 a vygeneruj report">Regionálna analýza</button>
    <button class="chat-suggestion agent" data-q="Nájdi 10 lekární s najvyššími ohrozenými tržbami a porovnaj ich s podobnými">Top 10 ohrozených</button>
    <button class="chat-suggestion agent" data-q="Vytvor report porovnania lekární ID 33, 36, 54 vrátane odporúčaní">Porovnávací report</button>
  </div>
  <div class="chat-input-area">
    <button class="agent-toggle" id="agent-toggle" title="Prepnúť na pokročilú analýzu (Claude)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
    </button>
    <input type="text" class="chat-input" id="chat-input" placeholder="Napíšte otázku...">
    <button class="chat-send" id="chat-send">&#10148;</button>
  </div>
</div>

<script>
// Toast notification helper
function showToast(message, type = 'error', duration = 4000) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

const bloky = document.getElementById("bloky");
const trzby = document.getElementById("trzby");
const rxInput = document.getElementById("rx");
const calcBtn = document.getElementById("calc");
const typSelect = document.getElementById("typ");
const pharmacyIdInput = document.getElementById("pharmacy-id-input");
const pharmacyLoadBtn = document.getElementById("pharmacy-load-btn");

// Productivity toggle (segmented control)
let selectedProductivityZ = 0;  // Default: average
const prodToggleHigh = document.getElementById('prod-high');
const prodToggleAvg = document.getElementById('prod-avg');

// Helper to check if high productivity is selected
function isProdHigh() {
  return prodToggleHigh.checked;
}

// Listen to both radio buttons
[prodToggleHigh, prodToggleAvg].forEach(radio => {
  radio.addEventListener('change', () => {
    selectedProductivityZ = isProdHigh() ? 1 : 0;
  // Clear pre-calculated FTE so fresh prediction with new productivity is used
  window.selectedPharmacyData = null;
  // Update efficiency zone indicator in Analýza tab
  updateEfficiencyIndicator();
    // Auto-recalculate if result is already visible
    if (document.getElementById("result").style.display !== "none") {
      calcBtn.click();
    }
  });
});

function updateEfficiencyIndicator() {
  const marker = document.getElementById('pos-efficiency-you');
  const valueEl = document.getElementById('pos-efficiency-value');
  const indicatorEl = document.getElementById('pos-efficiency-indicator');
  const tooltipEl = document.getElementById('pos-efficiency-tooltip');

  if (marker && valueEl) {
    const pct = window.pharmacyProdPct || 0;

    let zoneLabel, zoneClass, indicatorClass, indicatorSymbol, tooltipText;

    if (isProdHigh()) {
      // Above average: centered in right zone (66.7-100%)
      marker.style.left = '83.3%';
      zoneLabel = 'Vysoká';
      zoneClass = 'high';
      indicatorClass = 'positive';
      indicatorSymbol = '↑';
      tooltipText = 'Nadpriemerná produktivita v segmente';
    } else if (pct < 0) {
      // Below average: left zone (0-33.3%)
      marker.style.left = '16.7%';
      zoneLabel = 'Nízka';
      zoneClass = 'low';
      indicatorClass = 'negative';
      indicatorSymbol = '↓';
      tooltipText = 'Podpriemerná produktivita v segmente';
    } else {
      // Average: middle zone (33.3-66.7%)
      marker.style.left = '50%';
      zoneLabel = 'Priemerná';
      zoneClass = 'avg';
      indicatorClass = 'neutral';
      indicatorSymbol = '≈';
      tooltipText = 'Priemerná produktivita v segmente';
    }

    valueEl.textContent = zoneLabel;
    valueEl.className = `position-value zone-label ${zoneClass}`;

    if (indicatorEl) {
      indicatorEl.className = `position-indicator ${indicatorClass}`;
      indicatorEl.textContent = indicatorSymbol;
    }

    if (tooltipEl) {
      tooltipEl.textContent = tooltipText;
    }
  }
}

function updateTrendIndicator() {
  const marker = document.getElementById('pos-trend-you');
  const valueEl = document.getElementById('pos-trend-value');
  const indicatorEl = document.getElementById('pos-trend-indicator');
  const tooltipEl = document.getElementById('pos-trend-tooltip');

  if (marker && valueEl) {
    const trendPct = window.pharmacyTrendPct || 0;
    const pctStr = trendPct > 0 ? `+${Math.round(trendPct)}%` : `${Math.round(trendPct)}%`;

    let zoneLabel, zoneClass, indicatorClass, indicatorSymbol, tooltipText;

    // Position marker in 3 zones based on trend threshold (±5%)
    if (trendPct < -5) {
      // Declining: left zone (0-33.3%)
      marker.style.left = '16.7%';
      zoneLabel = 'Klesajúci';
      zoneClass = 'declining';
      indicatorClass = 'negative';
      indicatorSymbol = '↓';
      tooltipText = `${pctStr} YoY · Klesajúci trend blokov`;
    } else if (trendPct > 5) {
      // Growing: right zone (66.7-100%)
      marker.style.left = '83.3%';
      zoneLabel = 'Rastúci';
      zoneClass = 'growing';
      indicatorClass = 'positive';
      indicatorSymbol = '↑';
      tooltipText = `${pctStr} YoY · Rastúci trend blokov`;
    } else {
      // Stable: middle zone (33.3-66.7%)
      marker.style.left = '50%';
      zoneLabel = 'Stabilný';
      zoneClass = 'stable';
      indicatorClass = 'neutral';
      indicatorSymbol = '≈';
      tooltipText = `${pctStr} YoY · Stabilný trend blokov`;
    }

    valueEl.textContent = zoneLabel;
    valueEl.className = `position-value zone-label ${zoneClass}`;

    if (indicatorEl) {
      indicatorEl.className = `position-indicator ${indicatorClass}`;
      indicatorEl.textContent = indicatorSymbol;
    }

    if (tooltipEl) {
      tooltipEl.textContent = tooltipText;
    }
  }
}

let allIds = [];
let selectedPharmacyId = null;

// Type-specific defaults (optimized for densest peer cluster)
const TYPE_DEFAULTS = {
  'A - shopping premium': {bloky: 93, trzby: 1.3, rx: 26},
  'B - shopping':         {bloky: 101, trzby: 1.7, rx: 49},
  'C - street +':         {bloky: 30, trzby: 0.6, rx: 67},
  'D - street':           {bloky: 28, trzby: 0.6, rx: 62},
  'E - poliklinika':      {bloky: 38, trzby: 1.0, rx: 78},
};

// ============================================
// PHARMACY SELECTOR
// ============================================
async function loadPharmacyById(pharmacyId) {
  const hint = document.getElementById('pharmacy-hint');
  hint.classList.remove('loaded', 'error');
  hint.textContent = 'Načítavam...';

  try {
    const response = await fetch(`/api/pharmacy/${pharmacyId}`);
    if (!response.ok) {
      throw new Error('Pharmacy not found');
    }
    const data = await response.json();

    // Auto-fill form fields (display rounded values)
    typSelect.value = data.typ;
    bloky.value = Math.round(data.bloky / 1000); // Convert to thousands
    trzby.value = (data.trzby / 1000000).toFixed(1); // Convert to millions
    rxInput.value = Math.round(data.podiel_rx * 100);

    // Store pharmacy data including pre-calculated prediction (same as network)
    selectedPharmacyId = pharmacyId;
    window.selectedPharmacyActualFte = data.actual_fte;
    window.selectedPharmacyPredictedFte = data.predicted_fte;  // Store DB prediction for consistent loss calc (matches Sieť tab)
    window.selectedPharmacyIsAboveAvgProd = data.is_above_avg_productivity;  // Store separately (not nulled on calc)
    window.selectedPharmacyData = {
      mesto: data.mesto,
      bloky: data.bloky,
      trzby: data.trzby,
      podiel_rx: data.podiel_rx,
      predicted_fte: data.predicted_fte,
      predicted_fte_F: data.predicted_fte_F,
      predicted_fte_L: data.predicted_fte_L,
      predicted_fte_ZF: data.predicted_fte_ZF,
      actual_fte: data.actual_fte,
      fte_diff: data.fte_diff,
      is_above_avg_productivity: data.is_above_avg_productivity,
      revenue_at_risk: data.revenue_at_risk,
      bloky_trend: data.bloky_trend
    };
    window.selectedPharmacyExact = {
      bloky: data.bloky,
      trzby: data.trzby,
      podiel_rx: data.podiel_rx
    };

    // Auto-set productivity toggle based on pharmacy's actual productivity
    // Store the productivity percentage for display
    window.pharmacyProdPct = data.prod_pct || 0;
    window.pharmacyTrendPct = data.bloky_trend || 0;  // Store trend for display
    // Set the segmented control based on productivity
    if (data.is_above_avg_productivity) {
      prodToggleHigh.checked = true;
    } else {
      prodToggleAvg.checked = true;
    }
    selectedProductivityZ = data.is_above_avg_productivity ? 1 : 0;
    updateEfficiencyIndicator();
    updateTrendIndicator();

    // Update hint with success
    hint.textContent = `${data.mesto}`;
    hint.classList.add('loaded');

    // Auto-calculate
    calcBtn.click();

  } catch (error) {
    console.error('Error loading pharmacy:', error);
    hint.textContent = `ID ${pharmacyId} nenájdené`;
    hint.classList.add('error');
    showToast(`Lekáreň ID ${pharmacyId} nebola nájdená`);
    selectedPharmacyId = null;
    window.selectedPharmacyActualFte = null;
    window.selectedPharmacyPredictedFte = null;
    window.selectedPharmacyIsAboveAvgProd = null;
    window.selectedPharmacyData = null;
  }
}

pharmacyLoadBtn.onclick = () => {
  const id = parseInt(pharmacyIdInput.value);
  if (id && id > 0) {
    loadPharmacyById(id);
  }
};

// Allow Enter key to trigger load
pharmacyIdInput.onkeypress = (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    pharmacyLoadBtn.click();
  }
};

// "Nová lekáreň" button - reset form for new/pipeline pharmacy
document.getElementById('btn-new-pharmacy').addEventListener('click', function() {
  // Clear pharmacy ID
  document.getElementById('pharmacy-id-input').value = '';
  document.getElementById('pharmacy-hint').textContent = '';
  document.getElementById('pharmacy-hint').classList.remove('loaded', 'error');

  // Reset form fields
  document.getElementById('bloky').value = '';
  document.getElementById('trzby').value = '';
  document.getElementById('rx').value = 50;
  document.getElementById('typ').selectedIndex = 0;
  document.getElementById('prod-avg').checked = true;
  selectedProductivityZ = 0;

  // Hide results
  document.getElementById('result').style.display = 'none';

  // Reset Analýza tab
  document.getElementById('analyza-empty').style.display = 'flex';
  document.getElementById('analyza-content').style.display = 'none';

  // Clear stored data
  selectedPharmacyId = null;
  window.selectedPharmacyActualFte = null;
  window.selectedPharmacyPredictedFte = null;
  window.selectedPharmacyIsAboveAvgProd = null;
  window.selectedPharmacyData = null;
  window.pharmacyProdPct = null;

  // Focus on typ select for quick type selection
  document.getElementById('typ').focus();

  // Brief visual feedback
  showToast('Pripravené pre novú lekáreň', 'success', 2000);
});

// Type averages for new pharmacy auto-fill
const typeAverages = {
  'A - shopping premium': { bloky: 85000, trzby: 2100000, rx: 45 },
  'B - shopping': { bloky: 65000, trzby: 1400000, rx: 48 },
  'C - street +': { bloky: 35000, trzby: 750000, rx: 52 },
  'D - street': { bloky: 25000, trzby: 550000, rx: 55 },
  'E - poliklinika': { bloky: 40000, trzby: 900000, rx: 60 }
};

// Auto-fill when typ changes (only in new pharmacy mode)
document.getElementById('typ').addEventListener('change', function() {
  if (selectedPharmacyId === null) {
    const avg = typeAverages[this.value];
    if (avg) {
      document.getElementById('bloky').value = avg.bloky;
      document.getElementById('trzby').value = avg.trzby;
      document.getElementById('rx').value = avg.rx;
    }
  }
});

// Update actual FTE comparison in calculator tab
function updateActualFteCompare(recommendedFte) {
  const vsEl = document.getElementById('val-vs');
  const labelEl = document.getElementById('fte-label');
  const actualFte = window.selectedPharmacyActualFte;

  if (!actualFte) {
    vsEl.style.display = 'none';
    labelEl.textContent = 'Odporúčané FTE';
    return;
  }

  // Show actual FTE inline with recommended
  vsEl.style.display = 'flex';
  const actualParts = actualFte.toFixed(1).split('.');
  document.getElementById('fte-actual').innerHTML = actualParts[0] + '<span class="decimal">.' + actualParts[1] + '</span>';
  labelEl.innerHTML = 'Odporúčané vs <span style="color:rgba(0,0,0,0.5)">skutočné</span> FTE';
}

// Show revenue loss with Kahneman loss framing
// Now uses centralized calculation from API
function showRevenueLoss(revenueAtRisk, trzby) {
  const lossEl = document.getElementById('revenue-loss');
  const contentEl = document.getElementById('revenue-loss-content');

  if (!revenueAtRisk || revenueAtRisk <= 0 || !trzby) {
    lossEl.style.display = 'none';
    return;
  }

  const lossPercent = ((revenueAtRisk / trzby) * 100).toFixed(1);
  const lossK = Math.round(revenueAtRisk / 1000);
  contentEl.innerHTML = `
    <div class="revenue-loss-header">REVENUE AT RISK</div>
    <div class="revenue-loss-value">€${lossK}K | ${lossPercent}% per year</div>
    <div class="revenue-loss-note">Staff capacity exceeded</div>
  `;

  // Restart heartbeat animation by forcing reflow
  lossEl.style.animation = 'none';
  lossEl.offsetHeight; // Trigger reflow
  lossEl.style.animation = '';
  lossEl.style.display = 'block';
}

// Mark result as stale when inputs change (but keep visible)
function markResultStale() {
  const resultDiv = document.getElementById("result");
  if (resultDiv.style.display !== "none") {
    resultDiv.style.opacity = "0.6";
  }
}

// Reset result opacity when recalculated
function markResultFresh() {
  document.getElementById("result").style.opacity = "1";
}

// Update defaults when store type changes
function updateDefaults() {
  const defaults = TYPE_DEFAULTS[typSelect.value];
  if (defaults) {
    bloky.value = defaults.bloky;
    trzby.value = defaults.trzby;
    rxInput.value = defaults.rx;
  }
  markResultStale();
}

// Listen for store type changes (also clear pharmacy data)
typSelect.onchange = () => { window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; updateDefaults(); };

// Mark result stale when inputs change
// Also clear pharmacy data so manual input uses type-based factors
bloky.oninput = () => { markResultStale(); window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; };
trzby.oninput = () => { markResultStale(); window.selectedPharmacyExact = null; window.selectedPharmacyData = null; selectedPharmacyId = null; };
rxInput.oninput = () => {
  // Clamp value between 20-90
  const val = Math.max(20, Math.min(90, rxInput.value));
  rxInput.value = val;
  markResultStale();
  window.selectedPharmacyExact = null;
  window.selectedPharmacyData = null;
  selectedPharmacyId = null;
};

// Initialize with type-specific defaults
updateDefaults();

function expandIds() {
  document.getElementById("trust-ids").textContent = allIds.join(', ');
  document.getElementById("trust-expand").style.display = "none";
}

calcBtn.onclick = async () => {
  // Add loading state
  calcBtn.classList.add('loading');
  calcBtn.disabled = true;

  // Use exact values if pharmacy loaded, otherwise use form values
  const exact = window.selectedPharmacyExact;
  const pharmacyData = window.selectedPharmacyData;  // Pre-calculated FTE from pharmacy API
  const data = {
    typ: document.getElementById("typ").value,
    bloky: exact ? exact.bloky : +bloky.value * 1000,
    trzby: exact ? exact.trzby : +trzby.value * 1000000,
    podiel_rx: exact ? exact.podiel_rx : +rxInput.value / 100,
    productivity_z: selectedProductivityZ,  // From productivity buttons
    variability_z: 0,
    pharmacy_id: selectedPharmacyId
  };

  try {
    const r = await fetch('/api/predict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(r => r.json());

    // Show result and mark as fresh
    document.getElementById("result").style.display = "block";
    markResultFresh();

    // Use pre-calculated FTE if pharmacy loaded (consistent with network), otherwise use prediction
    const fteTotal = pharmacyData ? pharmacyData.predicted_fte : r.fte.total;
    const fteF = pharmacyData ? pharmacyData.predicted_fte_F : r.breakdown.F;
    const fteL = pharmacyData ? pharmacyData.predicted_fte_L : r.breakdown.L;
    const fteZF = pharmacyData ? pharmacyData.predicted_fte_ZF : r.breakdown.ZF;

    // Animate FTE count-up
    animateValue("fte-total", 0, fteTotal, 800);

    // Show range for all predictions
    document.getElementById("fte-range").textContent = `Rozsah: ${r.fte.min.toFixed(1)} – ${r.fte.max.toFixed(1)} FTE`;

    // Breakdown
    document.getElementById("fte-f").textContent = fteF.toFixed(1);
    document.getElementById("fte-l").textContent = fteL.toFixed(1);
    document.getElementById("fte-zf").textContent = fteZF.toFixed(1);

    // Breakdown percentages (shown on hover)
    const pctZF = ((fteZF / fteTotal) * 100).toFixed(0);
    const pctF = ((fteF / fteTotal) * 100).toFixed(0);
    const pctL = ((fteL / fteTotal) * 100).toFixed(0);
    document.getElementById("pct-zf").textContent = `${pctZF}% z celku`;
    document.getElementById("pct-f").textContent = `${pctF}% z celku`;
    document.getElementById("pct-l").textContent = `${pctL}% z celku`;

    // Comparable count removed - field replaced with productivity toggle
    if (r.segment && r.benchmark) {
      document.getElementById("bloky-tooltip").textContent =
        `Segment (${r.benchmark.count}): ${r.segment.bloky_min} – ${r.segment.bloky_max} tis.`;
      document.getElementById("trzby-tooltip").textContent =
        `Segment (${r.benchmark.count}): ${r.segment.trzby_min} – ${r.segment.trzby_max} mil. €`;
    }

    // Trust box
    if (r.comparable.count > 0) {
      document.getElementById("trust-count").textContent = r.comparable.count;
      allIds = r.comparable.ids;
      if (allIds.length > 5) {
        document.getElementById("trust-ids").textContent = allIds.slice(0, 5).join(', ') + ', ...';
        document.getElementById("trust-expand").style.display = "inline";
      } else {
        document.getElementById("trust-ids").textContent = allIds.join(', ');
        document.getElementById("trust-expand").style.display = "none";
      }
      document.getElementById("trust-box").style.display = "block";
    } else {
      document.getElementById("trust-box").style.display = "none";
    }

    // Distribution visualization
    if (r.comparable.count > 0 && r.comparable.min_fte && r.comparable.max_fte) {
      const distBox = document.getElementById("distribution-box");
      const minFte = r.comparable.min_fte;
      const maxFte = r.comparable.max_fte;
      const recFte = r.fte.total;

      // Update labels
      document.getElementById("dist-count").textContent = r.comparable.count;
      document.getElementById("dist-min").textContent = minFte.toFixed(1) + " FTE";
      document.getElementById("dist-max").textContent = maxFte.toFixed(1) + " FTE";


      // Calculate marker position (0-100%)
      const range = maxFte - minFte;
      let markerPos;
      if (range > 0) {
        markerPos = ((recFte - minFte) / range) * 100;
        markerPos = Math.max(0, Math.min(100, markerPos)); // Clamp to 0-100%
      } else {
        markerPos = 50; // If all same, center it
      }

      // Set range bar to full width (min to max)
      document.getElementById("dist-range").style.left = "0%";
      document.getElementById("dist-range").style.width = "100%";

      // Render actual pharmacy markers (empty circles)
      const actualsContainer = document.getElementById("dist-actuals");
      actualsContainer.innerHTML = ''; // Clear previous
      if (r.comparable.fte_values && r.comparable.fte_values.length > 0) {
        r.comparable.fte_values.forEach(fte => {
          let pos = range > 0 ? ((fte - minFte) / range) * 100 : 50;
          pos = Math.max(0, Math.min(100, pos));
          const marker = document.createElement('div');
          marker.className = 'dist-marker-actual';
          marker.style.left = pos + '%';
          actualsContainer.appendChild(marker);
        });
      }

      // Set recommendation marker position (filled circle) with tooltip
      const recMarker = document.getElementById("dist-marker");
      recMarker.style.left = markerPos + "%";

      // Calculate rank among comparable pharmacies
      let rank = 1;
      if (r.comparable.fte_values && r.comparable.fte_values.length > 0) {
        rank = r.comparable.fte_values.filter(fte => fte < recFte).length + 1;
      }
      const total = r.comparable.count;
      recMarker.setAttribute("data-fte", `${recFte.toFixed(1)} FTE · ${rank}. z ${total}`);

      distBox.style.display = "block";
    } else {
      document.getElementById("distribution-box").style.display = "none";
    }

    // Store result for AI chat (pass displayed fteTotal for consistency)
    storeCalculationResult(r, data, fteTotal);

    // Update actual FTE comparison (if pharmacy loaded)
    updateActualFteCompare(fteTotal);

    // Show revenue loss (Kahneman loss framing)
    // Use pre-calculated revenue_at_risk from pharmacy API when available
    const revenueAtRisk = window.selectedPharmacyData
      ? window.selectedPharmacyData.revenue_at_risk
      : r.revenue_at_risk;
    showRevenueLoss(revenueAtRisk, data.trzby);

    // Render sensitivity analysis
    if (r.sensitivity) {
      renderSensitivity(r.sensitivity);
    }

    // Render segment position charts
    if (r.segment) {
      renderPositionCharts(r.segment, r.hourly, data, data.typ);
    }

    // Render FTE position in segment (show actual FTE when pharmacy loaded, recommended otherwise)
    if (r.fte && r.benchmark) {
      const actualFte = pharmacyData ? pharmacyData.actual_fte : null;
      renderFteComparison(actualFte || fteTotal, r.benchmark, r.comparable, !!actualFte);
    }

    // Scroll to result smoothly
    document.getElementById("result").scrollIntoView({ behavior: 'smooth', block: 'start' });

  } catch (error) {
    console.error('Error:', error);
    showToast('Chyba pri výpočte FTE');
  } finally {
    // Remove loading state
    calcBtn.classList.remove('loading');
    calcBtn.disabled = false;
  }
};

// ============================================
// TAB NAVIGATION
// ============================================
let networkDataLoaded = false;

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    // Update active tab button
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Show corresponding content
    const tabId = btn.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');

    // Load network data on first view
    if (tabId === 'network' && !networkDataLoaded) {
      loadNetworkData();
    }
  };
});

// ============================================
// NETWORK DASHBOARD
// ============================================
async function loadNetworkData() {
  const loadingEl = document.getElementById('network-loading');
  const contentEl = document.getElementById('network-content');
  
  loadingEl.style.display = 'flex';
  loadingEl.innerHTML = 'Načítavam dáta...';
  contentEl.style.display = 'none';

  try {
    const response = await fetch('/api/network');
    if (!response.ok) throw new Error('Network response was not ok');
    const data = await response.json();

    // Store data globally for CSV export
    window.networkData = data;

    // Priority Summary stats
    const priorities = data.priorities || {};
    const totalRevenueAtRisk = priorities.total_revenue_at_risk || 0;
    const urgentCount = priorities.urgent_count || 0;
    const monitorCount = priorities.monitor_count || 0;
    const optimizeCount = priorities.optimize_count || 0;

    // Format revenue at risk for hero stat
    const revenueText = totalRevenueAtRisk > 0
      ? (totalRevenueAtRisk >= 1000000
          ? `${(totalRevenueAtRisk / 1000000).toFixed(1)}M €`
          : `${Math.round(totalRevenueAtRisk / 1000)}K €`)
      : '0 €';

    // Hero stat
    const heroValueEl = document.getElementById('net-revenue-at-risk');
    heroValueEl.textContent = revenueText;
    heroValueEl.classList.add('pulse');
    setTimeout(() => heroValueEl.classList.remove('pulse'), 600);

    // Hero detail
    document.getElementById('hero-revenue-detail').textContent =
      `${urgentCount} pharmacies with high productivity and understaffing`;

    // Quick stats row
    document.getElementById('net-urgent-count').textContent = urgentCount;
    document.getElementById('net-monitor-count').textContent = monitorCount;
    document.getElementById('net-optimize-count').textContent = optimizeCount;

    // Priority section counts
    document.getElementById('priority-urgent-count').textContent = urgentCount;
    document.getElementById('priority-monitor-count').textContent = monitorCount;
    document.getElementById('priority-optimize-count').textContent = optimizeCount;

    // Priority section totals
    const urgentTotal = (priorities.urgent || []).reduce((sum, p) => sum + (p.revenue_at_risk || 0), 0);
    const monitorTotal = (priorities.monitor || []).reduce((sum, p) => sum + Math.abs(p.bloky_trend || 0), 0);
    const optimizeTotal = (priorities.optimize || []).reduce((sum, p) => sum + Math.abs(p.diff || 0), 0);

    document.getElementById('priority-urgent-total').textContent = urgentTotal >= 1000
      ? `-${Math.round(urgentTotal / 1000)}K` : `-${Math.round(urgentTotal)}`;
    document.getElementById('priority-monitor-total').textContent = `+${Math.round(monitorTotal / monitorCount || 0)}%`;
    document.getElementById('priority-optimize-total').textContent = `+${optimizeTotal.toFixed(1)} FTE`;

    // Render priority lists
    renderPriorityList('urgent', priorities.urgent || []);
    renderPriorityList('optimize', priorities.optimize || []);
    renderPriorityList('monitor', priorities.monitor || []);

    // Segment table
    const tbody = document.getElementById('segment-tbody');
    tbody.innerHTML = '';

    data.segments.forEach(seg => {
      const shortType = seg.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
      const diffClass = Math.abs(seg.diff) < 3 ? 'ok' : 'warning';
      const diffSign = seg.diff >= 0 ? '+' : '';

      tbody.innerHTML += `
        <tr>
          <td class="segment-name">${shortType}</td>
          <td>${seg.count}</td>
          <td>${seg.actual_fte.toFixed(1)}</td>
          <td>${seg.predicted_fte.toFixed(1)}</td>
          <td><span class="status-badge ${diffClass}">${diffSign}${seg.diff.toFixed(1)}</span></td>
        </tr>
      `;
    });

    // Total row
    tbody.innerHTML += `
      <tr class="total-row">
        <td class="segment-name">Celkom</td>
        <td>${data.summary.total_pharmacies}</td>
        <td>${data.summary.total_actual_fte.toFixed(1)}</td>
        <td>${data.summary.total_predicted_fte.toFixed(1)}</td>
        <td><span class="status-badge ok">${data.summary.diff >= 0 ? '+' : ''}${data.summary.diff.toFixed(1)}</span></td>
      </tr>
    `;

    // Show content, hide loading
    document.getElementById('network-loading').style.display = 'none';
    document.getElementById('network-content').style.display = 'block';

    networkDataLoaded = true;

  } catch (error) {
    console.error('Error loading network data:', error);
    document.getElementById('network-loading').innerHTML = `
      <div style="text-align:center;">
        <p style="margin-bottom:10px;">Chyba pri načítaní dát siete</p>
        <button onclick="loadNetworkData()" class="btn-load">⟳ Skúsiť znova</button>
      </div>
    `;
    showToast('Chyba pri načítaní dát siete');
  }
}

// Priority dashboard helper functions
const DISPLAY_LIMIT = 10; // Show top 10 in UI, CSV exports all

function renderPriorityList(type, items) {
  const list = document.getElementById(`priority-${type}-list`);
  if (!list) return;

  list.innerHTML = '';

  if (items.length === 0) {
    list.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem;">No pharmacies in this category</div>';
    return;
  }

  // Display only top 10, but full list is available for CSV
  const displayItems = items.slice(0, DISPLAY_LIMIT);
  const totalCount = items.length;

  displayItems.forEach((p, index) => {
    const shortType = p.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
    const pData = encodeURIComponent(JSON.stringify(p));
    const rank = index + 1;

    let valueHtml = '';
    let subtitleHtml = '';

    if (type === 'urgent') {
      // Revenue at risk - Kahneman loss framing
      const revenueAtRisk = p.revenue_at_risk || 0;
      const revenueText = revenueAtRisk >= 1000
        ? `${Math.round(revenueAtRisk / 1000)}K`
        : Math.round(revenueAtRisk).toString();
      valueHtml = `<span class="priority-item-value urgent">-${revenueText}</span>`;
      subtitleHtml = `<span class="priority-item-subtitle">Chýba ${Math.abs(p.diff).toFixed(1)} FTE | Prod. +${p.prod_pct || 0}%</span>`;
    } else if (type === 'optimize') {
      // Overstaffed - show excess FTE
      const excess = Math.abs(p.diff || 0);
      valueHtml = `<span class="priority-item-value optimize">+${excess.toFixed(1)} FTE</span>`;
      subtitleHtml = `<span class="priority-item-subtitle">Možné prerozdelenie</span>`;
    } else if (type === 'monitor') {
      // Growing - show trend
      valueHtml = `<span class="priority-item-value monitor">+${p.bloky_trend || 0}%</span>`;
      subtitleHtml = `<span class="priority-item-subtitle">Rast transakcií YoY</span>`;
    }

    list.innerHTML += `
      <div class="priority-item ${type}" onclick="analyzePriorityItem(decodeURIComponent('${pData}'))">
        <span class="priority-item-rank">${rank}</span>
        <div class="priority-item-info">
          <div class="priority-item-name">
            ${p.id} - ${p.mesto}
            <span class="priority-item-id">${shortType}</span>
          </div>
          ${subtitleHtml}
        </div>
        ${valueHtml}
        <span class="priority-item-action">→</span>
      </div>
    `;
  });

  // Add note if there are more items than displayed
  if (totalCount > DISPLAY_LIMIT) {
    list.innerHTML += `
      <div style="padding:10px 14px;color:var(--text-muted);font-size:0.75rem;text-align:center;font-style:italic;">
        Showing ${DISPLAY_LIMIT} of ${totalCount} · Complete list in CSV export
      </div>
    `;
  }
}

function togglePriority(type) {
  const section = document.querySelector(`.priority-${type}-section`);
  const arrow = document.getElementById(`${type}-arrow`);
  if (!section || !arrow) return;

  const isExpanded = section.classList.contains('expanded');
  section.classList.toggle('expanded');
  arrow.textContent = isExpanded ? '▼' : '▲';

  // Re-trigger animations when expanding
  if (!isExpanded) {
    const items = section.querySelectorAll('.priority-item');
    items.forEach((item, i) => {
      item.style.animation = 'none';
      item.offsetHeight; // Trigger reflow
      item.style.animation = '';
    });
  }
}

function exportCSV(type) {
  // Get priority data from cached network data
  if (!window.networkData || !window.networkData.priorities) {
    alert('Data nie su dostupne. Skuste obnovit stranku.');
    return;
  }

  const priorities = window.networkData.priorities;
  const data = priorities[type] || [];

  if (data.length === 0) {
    alert('Ziadne data na export.');
    return;
  }

  // Helper to escape CSV values (wrap in quotes if contains comma, quote, or newline)
  const csvEscape = (val) => {
    if (val === null || val === undefined) return '';
    const str = String(val);
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  };

  // Define headers and filename based on type (with complete pharmacy info)
  const configs = {
    urgent: {
      filename: 'revenue_at_risk.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Gap FTE', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Ohrozené tržby (EUR)', 'Trend %'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, p.diff?.toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, Math.round(p.revenue_at_risk || 0), p.bloky_trend]
    },
    monitor: {
      filename: 'growth_alert.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Gap FTE', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Trend %', 'Ohrozené tržby (EUR)'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, p.diff?.toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, p.bloky_trend, Math.round(p.revenue_at_risk || 0)]
    },
    optimize: {
      filename: 'fte_surplus.csv',
      headers: ['ID', 'Mesto', 'Typ', 'Skutočné FTE', 'Odporúčané FTE', 'Prebytok FTE', 'Bloky', 'Tržby (EUR)', 'Rx %', 'Trend %'],
      row: (p) => [p.id, p.mesto, p.typ, p.actual_fte, p.predicted_fte, Math.abs(p.diff || 0).toFixed(1), p.bloky, Math.round(p.trzby || 0), p.podiel_rx, p.bloky_trend]
    }
  };

  const config = configs[type];

  // Build CSV content with UTF-8 BOM for Excel compatibility
  const BOM = '\uFEFF';
  let csv = BOM + config.headers.map(csvEscape).join(',') + '\n';
  data.forEach(p => {
    csv += config.row(p).map(csvEscape).join(',') + '\n';
  });

  // Download file
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = config.filename;
  link.click();
  URL.revokeObjectURL(url);
}

function toggleSegmentTable() {
  const container = document.getElementById('segment-table-container');
  const arrow = document.getElementById('segment-toggle-arrow');
  if (!container || !arrow) return;

  const isHidden = container.style.display === 'none';
  container.style.display = isHidden ? 'block' : 'none';
  arrow.textContent = isHidden ? '▼' : '▶';
}

function toggleModelInfo() {
  const container = document.getElementById('model-info-container');
  const arrow = document.getElementById('model-info-arrow');
  if (!container || !arrow) return;

  const isHidden = container.style.display === 'none';
  container.style.display = isHidden ? 'block' : 'none';
  arrow.textContent = isHidden ? '▼' : '▶';
}

function analyzePriorityItem(dataStr) {
  const p = JSON.parse(dataStr);

  // Switch to calculator tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('[data-tab="calculator"]').classList.add('active');
  document.getElementById('tab-calculator').classList.add('active');

  // Load pharmacy into calculator
  document.getElementById('pharmacy-id-input').value = p.id;
  document.getElementById('pharmacy-load-btn').click();
}

function renderOutlierList(type, outliers) {
  const list = document.getElementById(type + '-list');
  list.innerHTML = '';

  if (outliers.length === 0) {
    list.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem;">No pharmacies</div>';
    return;
  }

  outliers.forEach(p => {
    const diffClass = p.diff > 0 ? 'positive' : 'negative';
    const diffSign = p.diff > 0 ? '+' : '';
    const shortType = p.typ.replace(' - ', '-').replace('shopping premium', 'prem.');
    const pData = encodeURIComponent(JSON.stringify(p));

    list.innerHTML += `
      <div class="outlier-item" onclick="analyzeOutlier(decodeURIComponent('${pData}'))">
        <div class="outlier-chat-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg></div>
        <div class="outlier-info">
          <div class="outlier-name">${p.mesto} <span style="color:var(--text-muted);font-weight:400;">#${p.id}</span></div>
          <div class="outlier-type">${shortType} | ${(p.bloky/1000).toFixed(0)}k bloky | ${(p.trzby/1000000).toFixed(1)}M € | ${p.podiel_rx}% Rx</div>
        </div>
        <div class="outlier-diff ${diffClass}">${diffSign}${p.diff.toFixed(1)}</div>
      </div>
    `;
  });
}

function toggleOutliers(type) {
  const header = document.querySelector(`#${type}-list`).previousElementSibling;
  const list = document.getElementById(type + '-list');
  const arrow = document.getElementById(type + '-arrow');

  header.classList.toggle('expanded');
  list.classList.toggle('expanded');
  arrow.textContent = list.classList.contains('expanded') ? '▲' : '▼';
}

// ============================================
// AI CHAT ASSISTANT
// ============================================
let lastCalculationResult = null;
let chatOpen = false;

const chatTrigger = document.getElementById('chat-trigger');
const chatPanel = document.getElementById('chat-panel');
const chatClose = document.getElementById('chat-close');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const chatSuggestions = document.getElementById('chat-suggestions');

// Question history for arrow up/down navigation
const questionHistory = [];
let historyIndex = -1;
let tempInput = '';  // Store current input when navigating history

// Store segment histograms for FTE chart
let segmentHistograms = null;

// FTE Comparison
function renderFteComparison(fteValue, benchmark, comparable, isActual) {
  // Render FTE position in segment (as 4th row in position charts)
  // Shows actual FTE when pharmacy loaded, recommended otherwise
  const fteHist = segmentHistograms ? segmentHistograms.fte : null;
  renderPositionChart('fte', benchmark.min, benchmark.max, benchmark.avg, fteValue, '', 1, fteHist);
}

// Segment position chart
function renderPositionCharts(segment, hourly, inputs, typ) {
  // Update segment name
  document.getElementById('segment-name').textContent = typ;

  // Convert inputs to display units
  const yourBloky = inputs.bloky / 1000;  // to thousands
  const yourTrzby = inputs.trzby / 1000000;  // to millions
  const yourRx = inputs.podiel_rx * 100;  // to percentage

  // Get histograms (if available) and store for FTE chart
  const hist = segment.histograms || {};
  segmentHistograms = hist;

  // Render each chart with histogram
  renderPositionChart('bloky', segment.bloky_min, segment.bloky_max, segment.bloky_avg, yourBloky, 'k', 0, hist.bloky);
  renderPositionChart('trzby', segment.trzby_min, segment.trzby_max, segment.trzby_avg, yourTrzby, 'M', 1, hist.trzby);
  renderPositionChart('rx', segment.rx_min, segment.rx_max, segment.rx_avg, yourRx, '%', 0, hist.rx);

  // Render additional metrics if hourly data available
  if (hourly) {
    renderPositionChart('basket', hourly.segment_basket_min, hourly.segment_basket_max, hourly.segment_basket_avg, hourly.basket_value, '€', 1, hist.basket);
    renderPositionChart('blokyhod', hourly.segment_bloky_hour_min, hourly.segment_bloky_hour_max, hourly.segment_bloky_hour_avg, hourly.bloky_per_hour, '', 1, hist.blokyhod);
    renderPositionChart('trzbyhod', hourly.segment_trzby_hour_min, hourly.segment_trzby_hour_max, hourly.segment_trzby_hour_avg, hourly.trzby_per_hour, '€', 0, hist.trzbyhod);
  }

  // Update efficiency and trend zone indicators based on current pharmacy data
  updateEfficiencyIndicator();
  updateTrendIndicator();
}

function renderPositionChart(name, min, max, avg, you, unit, decimals, histogram) {
  const range = max - min;

  // Calculate positions (0-100%)
  const avgPos = range > 0 ? ((avg - min) / range) * 100 : 50;
  const youPos = range > 0 ? Math.max(0, Math.min(100, ((you - min) / range) * 100)) : 50;

  // Position markers
  const avgMarker = document.getElementById(`pos-${name}-avg`);
  const youMarker = document.getElementById(`pos-${name}-you`);
  if (avgMarker) avgMarker.style.left = avgPos + '%';
  if (youMarker) youMarker.style.left = youPos + '%';

  // Update min/max labels
  document.getElementById(`pos-${name}-min`).textContent = min + unit;
  document.getElementById(`pos-${name}-max`).textContent = max + unit;

  // Update your value display
  const valueEl = document.getElementById(`pos-${name}-value`);
  valueEl.textContent = you.toFixed(decimals) + unit;

  // Calculate difference from average
  const diff = you - avg;
  const diffPct = avg > 0 ? (diff / avg) * 100 : 0;
  const isAbove = diff >= 0;

  // Calculate percentile (rough estimate based on position)
  const percentile = Math.round(youPos);

  // Determine indicator type and text
  const indicatorEl = document.getElementById(`pos-${name}-indicator`);
  const tooltipEl = document.getElementById(`pos-${name}-tooltip`);

  let indicatorClass, indicatorSymbol, tooltipText;

  if (Math.abs(diffPct) < 5) {
    // Close to average (within 5%)
    indicatorClass = 'neutral';
    indicatorSymbol = '≈';
    tooltipText = `≈ priemer segmentu`;
  } else if (isAbove) {
    // Above average
    indicatorClass = 'positive';
    indicatorSymbol = '↑';
    const topPct = 100 - percentile;
    tooltipText = `+${diffPct.toFixed(0)}% vs priemer · Top ${topPct < 50 ? topPct : percentile}%`;
  } else {
    // Below average
    indicatorClass = 'negative';
    indicatorSymbol = '↓';
    tooltipText = `${diffPct.toFixed(0)}% vs priemer · ${percentile}. percentil`;
  }

  if (indicatorEl) {
    indicatorEl.className = `position-indicator ${indicatorClass}`;
    indicatorEl.textContent = indicatorSymbol;
  }

  if (tooltipEl) {
    tooltipEl.textContent = tooltipText;
  }

  // Render histogram if available
  if (histogram && histogram.length > 0) {
    const histEl = document.getElementById(`hist-${name}`);
    if (histEl) {
      const maxVal = Math.max(...histogram);
      histEl.innerHTML = histogram.map(h =>
        `<div class="histogram-bar" style="height:${maxVal > 0 ? (h / maxVal) * 100 : 0}%"></div>`
      ).join('');
    }
  }
}

// Simulation - Simplified (2 sliders: Tržby + Produktivita)
let sensitivityCoeffs = null;
let baseFteTotal = null;

function initSensitivitySliders(sensitivity, baseFte) {
  // Store coefficients
  sensitivityCoeffs = {
    trzby: sensitivity.trzby_10pct / 10,  // FTE per 1% revenue change
    prod: 0.5                              // FTE saved per 1σ productivity improvement
  };
  baseFteTotal = baseFte;

  // Get slider elements
  const trzbySlider = document.getElementById('sens-trzby');
  const prodSlider = document.getElementById('sens-prod');

  // Reset sliders to 0
  trzbySlider.value = 0;
  prodSlider.value = 0;

  // Add event listeners
  trzbySlider.oninput = updateSimulationDisplay;
  prodSlider.oninput = updateSimulationDisplay;

  // Reset button
  document.getElementById('sim-reset-btn').addEventListener('click', function() {
    trzbySlider.value = 0;
    prodSlider.value = 0;
    updateSimulationDisplay();
  });

  // Initial display
  updateSimulationDisplay();

  // Show content, hide empty state
  document.getElementById('analyza-empty').style.display = 'none';
  document.getElementById('analyza-content').style.display = 'block';
}

function updateSimulationDisplay() {
  const trzbyVal = parseInt(document.getElementById('sens-trzby').value);
  const prodVal = parseInt(document.getElementById('sens-prod').value) / 10;  // Scale: 0-20 -> 0-2.0σ

  // Calculate FTE impacts
  const trzbyFte = trzbyVal * sensitivityCoeffs.trzby;
  const prodFte = -prodVal * sensitivityCoeffs.prod;  // Negative = saves FTE

  const totalFte = trzbyFte + prodFte;

  // Update Tržby display
  const trzbyResultEl = document.getElementById('sens-trzby-result');
  const trzbyFteEl = document.getElementById('sens-trzby-fte');
  const trzbyValEl = document.getElementById('sens-trzby-val');

  trzbyFteEl.textContent = (trzbyFte >= 0 ? '+' : '') + trzbyFte.toFixed(1);
  trzbyResultEl.classList.remove('negative', 'zero');

  // Show input value next to label
  if (trzbyVal !== 0) {
    trzbyValEl.textContent = (trzbyVal >= 0 ? '+' : '') + trzbyVal + '%';
    trzbyValEl.classList.add('visible');
    trzbyValEl.classList.toggle('negative', trzbyVal < 0);
  } else {
    trzbyValEl.classList.remove('visible');
  }

  if (Math.abs(trzbyFte) < 0.05) {
    trzbyResultEl.classList.add('zero');
  } else if (trzbyFte < 0) {
    trzbyResultEl.classList.add('negative');
  }

  // Update Productivity display
  const prodResultEl = document.getElementById('sens-prod-result');
  const prodFteEl = document.getElementById('sens-prod-fte');
  const prodValEl = document.getElementById('sens-prod-val');

  prodFteEl.textContent = prodFte.toFixed(1);
  prodResultEl.classList.remove('negative', 'zero');

  // Show input value next to label
  if (prodVal > 0) {
    prodValEl.textContent = '+' + prodVal.toFixed(1) + 'σ';
    prodValEl.classList.add('visible');
  } else {
    prodValEl.classList.remove('visible');
  }

  if (Math.abs(prodFte) < 0.05) {
    prodResultEl.classList.add('zero');
  } else {
    prodResultEl.classList.add('negative');
  }

  // Update total with pulse animation
  const totalEl = document.getElementById('sens-total-fte');
  totalEl.textContent = (totalFte >= 0 ? '+' : '') + totalFte.toFixed(1) + ' FTE';

  totalEl.classList.remove('pulse');
  void totalEl.offsetWidth; // Trigger reflow
  totalEl.classList.add('pulse');

  document.getElementById('sens-base-fte').textContent = baseFteTotal.toFixed(1);
  document.getElementById('sens-new-fte').textContent = (baseFteTotal + totalFte).toFixed(1) + ' FTE';
}

// Backwards compatibility wrapper
function renderSensitivity(sensitivity) {
  // Called from calcBtn.onclick - use actual FTE as base (if available), otherwise predicted
  if (lastCalculationResult) {
    const baseFte = lastCalculationResult.fte_actual || lastCalculationResult.fte_total;
    if (baseFte) {
      initSensitivitySliders(sensitivity, baseFte);
    }
  }
}

// Store calculation result for chat context
function storeCalculationResult(result, inputs, displayedFteTotal = null) {
  lastCalculationResult = {
    pharmacy_id: inputs.pharmacy_id,
    pharmacy_name: window.selectedPharmacyData ? window.selectedPharmacyData.mesto : null,
    fte_actual: window.selectedPharmacyData ? window.selectedPharmacyData.actual_fte : null,
    fte_diff: window.selectedPharmacyData ? window.selectedPharmacyData.fte_diff : null,
    revenue_at_risk: window.selectedPharmacyData ? window.selectedPharmacyData.revenue_at_risk : null,
    bloky_trend: window.selectedPharmacyData ? window.selectedPharmacyData.bloky_trend : null,
    is_above_avg_productivity: window.selectedPharmacyIsAboveAvgProd || false,
    typ: inputs.typ,
    bloky: inputs.bloky,
    trzby: inputs.trzby,
    podiel_rx: inputs.podiel_rx,
    effective_bloky: result.inputs?.effective_bloky || 0,
    fte_total: displayedFteTotal || result.fte.total,
    fte_min: result.fte.min,
    fte_max: result.fte.max,
    fte_F: result.breakdown.F,
    fte_L: result.breakdown.L,
    fte_ZF: result.breakdown.ZF,
    comparable_count: result.comparable?.count || 0,
    comparable_avg: result.comparable?.avg_fte || null,
    comparable_min: result.comparable?.min_fte || null,
    comparable_max: result.comparable?.max_fte || null,
    benchmark_avg: result.benchmark?.avg || null,
    benchmark_count: result.benchmark?.count || 0,
    bloky_per_hour: result.hourly?.bloky_per_hour || null,
    trzby_per_hour: result.hourly?.trzby_per_hour || null,
    segment_bloky_hour_avg: result.hourly?.segment_bloky_hour_avg || null,
    segment_bloky_hour_min: result.hourly?.segment_bloky_hour_min || null,
    segment_bloky_hour_max: result.hourly?.segment_bloky_hour_max || null,
    segment_rx_avg: result.segment?.rx_avg || null,
    segment_bloky_avg: result.segment?.bloky_avg || null,
    segment_trzby_avg: result.segment?.trzby_avg || null
  };
  // Show chat trigger when we have calculation result
  chatTrigger.classList.add('visible');
}

// Toggle chat panel
chatTrigger.onclick = () => {
  chatOpen = !chatOpen;
  chatPanel.classList.toggle('open', chatOpen);
  if (chatOpen) {
    chatInput.focus();
  }
};

chatClose.onclick = () => {
  chatOpen = false;
  chatPanel.classList.remove('open');
};

// Send message
async function sendChatMessage(question) {
  if (!question.trim()) return;

  // Add to question history (avoid duplicates)
  const trimmedQ = question.trim();
  if (questionHistory.length === 0 || questionHistory[questionHistory.length - 1] !== trimmedQ) {
    questionHistory.push(trimmedQ);
  }
  historyIndex = -1;  // Reset history navigation
  tempInput = '';

  // If no context, provide a generic helpful message instead of failing silently
  if (!lastCalculationResult) {
    addChatMessage(question, 'user');
    chatInput.value = '';
    setTimeout(() => {
      addChatMessage("Najprv prosím vypočítajte FTE pre lekáreň v záložke Kalkulačka alebo vyberte lekáreň v záložke Prehľad, aby som vám mohol poradiť s konkrétnymi dátami. Zatiaľ vám môžem vysvetliť princípy modelu.", 'assistant');
    }, 500);
    return;
  }

  // Add user message
  addChatMessage(question, 'user');
  chatInput.value = '';
  chatSend.disabled = true;

  // Hide suggestions after first question
  chatSuggestions.style.display = 'none';

  // Show typing indicator
  const typingId = showTypingIndicator();

  // Set up 90-second timeout
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 90000);

  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: question,
        context: lastCalculationResult
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);
    const data = await response.json();
    removeTypingIndicator(typingId);

    if (data.error) {
      addChatMessage('Prepáčte, nastala chyba: ' + data.error, 'assistant');
    } else {
      addChatMessage(formatAnswer(data.answer), 'assistant');
    }
  } catch (error) {
    clearTimeout(timeoutId);
    removeTypingIndicator(typingId);
    if (error.name === 'AbortError') {
      addChatMessage('Prepáčte, odpoveď trvala príliš dlho. Skúste znova alebo položte jednoduchšiu otázku.', 'assistant');
    } else {
      addChatMessage('Prepáčte, nepodarilo sa spojiť so serverom.', 'assistant');
    }
  }

  chatSend.disabled = false;
}

function addChatMessage(text, role) {
  const msg = document.createElement('div');
  msg.className = 'chat-message ' + role;
  msg.innerHTML = '<div class="bubble">' + text + '</div>';
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function formatAnswer(text) {
  // Convert markdown-like formatting to HTML
  return text
    // Remove markdown code block markers
    .replace(/```\n?/g, '')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Style revenue at risk lines in red
    .replace(/(⚠[^<\n]*(?:ohrozené|Ohrozené)[^<\n]*)/gi, '<span class="risk-text">$1</span>')
    // Style bar characters (filled and empty)
    .replace(/([█]+)/g, '<span class="bar-filled">$1</span>')
    .replace(/([░]+)/g, '<span class="bar-empty">$1</span>')
    .replace(/\n/g, '<br>');
}

// === AGENT MODE ===
let agentModeEnabled = false;
const agentToggle = document.getElementById('agent-toggle');
const agentSuggestions = document.getElementById('agent-suggestions');

agentToggle.addEventListener('click', () => {
  agentModeEnabled = !agentModeEnabled;
  agentToggle.classList.toggle('active', agentModeEnabled);

  // Toggle suggestion visibility
  chatSuggestions.style.display = agentModeEnabled ? 'none' : 'flex';
  agentSuggestions.style.display = agentModeEnabled ? 'flex' : 'none';

  // Update placeholder
  chatInput.placeholder = agentModeEnabled
    ? 'Pokročilá analýza (Claude)...'
    : 'Napíšte otázku...';
});

// Handle agent suggestion clicks
document.querySelectorAll('.chat-suggestion.agent').forEach(btn => {
  btn.addEventListener('click', () => {
    const q = btn.dataset.q;
    if (q) sendAgentMessage(q);
  });
});

async function sendAgentMessage(prompt) {
  if (!prompt.trim()) return;

  // Add to question history (avoid duplicates)
  const trimmedQ = prompt.trim();
  if (questionHistory.length === 0 || questionHistory[questionHistory.length - 1] !== trimmedQ) {
    questionHistory.push(trimmedQ);
  }
  historyIndex = -1;  // Reset history navigation
  tempInput = '';

  // Add user message with agent indicator
  addChatMessage(prompt + ' <span class="agent-mode-indicator">Claude</span>', 'user');
  chatInput.value = '';
  chatSend.disabled = true;
  agentSuggestions.style.display = 'none';

  // Show typing indicator
  const typingId = showTypingIndicator();

  try {
    const response = await fetch('/api/agent/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    });

    const data = await response.json();
    removeTypingIndicator(typingId);

    if (data.error) {
      addChatMessage('Prepáčte, nastala chyba: ' + data.error, 'assistant');
    } else {
      // Format response with agent indicator
      const formattedResponse = formatAnswer(data.response);
      const toolsInfo = data.tools_used && data.tools_used.length > 0
        ? `<br><small style="color:var(--text-muted);">Použité nástroje: ${data.tools_used.join(', ')}</small>`
        : '';
      addChatMessage(formattedResponse + toolsInfo, 'assistant');
    }
  } catch (error) {
    removeTypingIndicator(typingId);
    addChatMessage('Prepáčte, nepodarilo sa spojiť s Claude agentom.', 'assistant');
  }

  chatSend.disabled = false;
}

function showTypingIndicator() {
  const id = 'typing-' + Date.now();
  const typing = document.createElement('div');
  typing.id = id;
  typing.className = 'chat-message assistant';
  typing.innerHTML = '<div class="bubble"><div class="chat-typing"><span></span><span></span><span></span></div></div>';
  chatMessages.appendChild(typing);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return id;
}

function removeTypingIndicator(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

// Event listeners
chatSend.onclick = () => sendChatMessage(chatInput.value);
chatInput.onkeypress = (e) => {
  if (e.key === 'Enter') sendChatMessage(chatInput.value);
};

// Arrow up/down for question history
chatInput.onkeydown = (e) => {
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (questionHistory.length === 0) return;

    // Save current input when starting to navigate
    if (historyIndex === -1) {
      tempInput = chatInput.value;
    }

    // Move up in history
    if (historyIndex < questionHistory.length - 1) {
      historyIndex++;
      chatInput.value = questionHistory[questionHistory.length - 1 - historyIndex];
    }
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (historyIndex === -1) return;

    // Move down in history
    historyIndex--;
    if (historyIndex === -1) {
      // Back to current input
      chatInput.value = tempInput;
    } else {
      chatInput.value = questionHistory[questionHistory.length - 1 - historyIndex];
    }
  }
};

// Suggestion buttons
document.querySelectorAll('.chat-suggestion').forEach(btn => {
  btn.onclick = () => sendChatMessage(btn.dataset.q);
});

// Analyze outlier from Network tab
function analyzeOutlier(jsonStr) {
  const p = JSON.parse(jsonStr);
  const rxFactor = 0.41;
  const effectiveBloky = p.bloky * (1 + rxFactor * (p.podiel_rx / 100));

  // Set chat context with outlier data
  lastCalculationResult = {
    pharmacy_id: p.id,
    typ: p.typ,
    bloky: p.bloky,
    trzby: p.trzby,
    podiel_rx: p.podiel_rx / 100,
    effective_bloky: effectiveBloky,
    fte_total: p.predicted_fte,
    fte_actual: p.actual_fte,
    fte_diff: p.diff,
    revenue_at_risk: p.revenue_at_risk || 0,
    bloky_trend: p.bloky_trend || 0,
    is_above_avg_productivity: p.is_above_avg_productivity || false,
    fte_min: null,
    fte_max: null,
    fte_F: null,
    fte_L: null,
    fte_ZF: null,
    comparable_count: 0,
    comparable_avg: null,
    benchmark_avg: null,
    benchmark_count: null,
    bloky_per_hour: null,
    trzby_per_hour: null,
    pharmacy_name: p.mesto
  };

  // Show chat trigger and open panel
  chatTrigger.classList.add('visible');
  chatPanel.classList.add('open');
  chatOpen = true;

  // Reset chat messages
  chatMessages.innerHTML = `
    <div class="chat-message assistant">
      <div class="bubble"><strong>${p.mesto}</strong> (${p.typ})<br><br>Model odporúča ${p.predicted_fte.toFixed(1)} FTE, aktuálne má ${p.actual_fte.toFixed(1)} FTE (${p.diff > 0 ? '+' : ''}${p.diff.toFixed(1)}). Opýtajte sa prečo.</div>
    </div>
  `;

  // Show suggestions
  chatSuggestions.style.display = 'flex';
  chatSuggestions.innerHTML = `
    <button class="chat-suggestion" onclick="sendChatMessage('Prečo ${p.diff > 0 ? '+' : ''}${p.diff.toFixed(1)} FTE?')">Prečo ${p.diff > 0 ? '+' : ''}${p.diff.toFixed(1)} FTE?</button>
    <button class="chat-suggestion" onclick="sendChatMessage('Vysvetli odporúčanie')">Vysvetli</button>
  `;

  chatInput.focus();
}

// Count-up animation for FTE result
function animateValue(elementId, start, end, duration) {
  const el = document.getElementById(elementId);
  if (!el) return;

  const startTime = performance.now();
  const easeOutQuart = t => 1 - Math.pow(1 - t, 4);

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easeOutQuart(progress);
    const current = start + (end - start) * easedProgress;

    const parts = current.toFixed(1).split('.');
    el.innerHTML = parts[0] + '<span class="decimal">.' + parts[1] + '</span>';

    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);
}

// === AGENT TAB FUNCTIONALITY ===
const agentInput = document.getElementById('agent-input');
const agentSubmit = document.getElementById('agent-submit');
const agentResults = document.getElementById('agent-results');
const quickActions = document.querySelectorAll('.quick-action');

// Query history for arrow-up
let agentHistory = [];
let agentHistoryIndex = -1;

// Quick action buttons - populate input for review, don't auto-submit
quickActions.forEach(btn => {
  btn.addEventListener('click', () => {
    const query = btn.dataset.query;
    agentInput.value = query;
    agentInput.focus();
    // Select all text so user can easily modify or press Enter to submit
    agentInput.select();
  });
});

// Tools toggle button - show/hide extra tools
const toolsToggle = document.getElementById('tools-toggle');
const toolsExtra = document.getElementById('tools-extra');
if (toolsToggle && toolsExtra) {
  toolsToggle.addEventListener('click', () => {
    toolsToggle.classList.toggle('expanded');
    toolsExtra.classList.toggle('visible');
    const span = toolsToggle.querySelector('span');
    if (toolsExtra.classList.contains('visible')) {
      span.textContent = 'Skryť ďalšie nástroje';
    } else {
      span.textContent = 'Zobraziť ďalšie nástroje (6)';
    }
  });
}

// Sample question buttons - auto-submit on click
document.querySelectorAll('.sample-question').forEach(btn => {
  btn.addEventListener('click', () => {
    const query = btn.dataset.query;
    if (query) {
      agentInput.value = query;
      submitAgentQuery();
    }
  });
});

// Submit button
agentSubmit.addEventListener('click', submitAgentQuery);

// Enter to submit, Shift+Enter for new line
agentInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    submitAgentQuery();
  }
  // Arrow up for history
  if (e.key === 'ArrowUp' && agentInput.value === '') {
    e.preventDefault();
    if (agentHistory.length > 0) {
      if (agentHistoryIndex < agentHistory.length - 1) {
        agentHistoryIndex++;
      }
      agentInput.value = agentHistory[agentHistory.length - 1 - agentHistoryIndex];
    }
  }
  // Arrow down for history
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (agentHistoryIndex > 0) {
      agentHistoryIndex--;
      agentInput.value = agentHistory[agentHistory.length - 1 - agentHistoryIndex];
    } else {
      agentHistoryIndex = -1;
      agentInput.value = '';
    }
  }
});

async function submitAgentQuery() {
  const query = agentInput.value.trim();
  if (!query) return;

  // Add to history
  agentHistory.push(query);
  agentHistoryIndex = -1;
  agentInput.value = '';

  // Show loading
  agentResults.innerHTML = `
    <div class="agent-loading">
      <div class="spinner"></div>
      <div>Analyzujem...</div>
    </div>
  `;
  agentSubmit.disabled = true;

  try {
    const response = await fetch('/api/agent/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: query })
    });

    const data = await response.json();

    const backButton = `
      <button class="back-to-tools" onclick="showAgentWelcome()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        Späť na nástroje
      </button>
    `;

    if (data.error) {
      agentResults.innerHTML = `
        ${backButton}
        <div class="agent-response">
          <p style="color: #dc2626;">Chyba: ${data.error}</p>
          ${data.fallback ? `<p style="font-size: 0.9rem; color: var(--text-secondary);">${data.fallback}</p>` : ''}
        </div>
      `;
    } else {
      // Format response with markdown
      const formattedResponse = formatAgentResponse(data.response || '');

      agentResults.innerHTML = `
        ${backButton}
        <div class="agent-response">${formattedResponse}</div>
        ${data.tools_used && data.tools_used.length > 0 ? `
          <div class="agent-tools-used">
            Použité nástroje: ${data.tools_used.map(t => `<span>${t}</span>`).join('')}
          </div>
        ` : ''}
      `;
    }
  } catch (error) {
    agentResults.innerHTML = `
      <button class="back-to-tools" onclick="showAgentWelcome()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        Späť na nástroje
      </button>
      <div class="agent-response">
        <p style="color: #dc2626;">Chyba pri komunikácii so serverom: ${error.message}</p>
      </div>
    `;
  }

  agentSubmit.disabled = false;
}

function formatAgentResponse(text) {
  // Configure marked for clean rendering
  marked.setOptions({
    breaks: false,       // Don't convert single \n to <br>
    gfm: true,           // GitHub flavored markdown (tables, etc.)
    headerIds: false,    // No ID attributes on headers
    mangle: false        // Don't escape autolinks
  });

  // Parse markdown to HTML
  let html = marked.parse(text);

  // Post-process: style bar characters and risk text
  html = html
    .replace(/([█]+)/g, '<span class="bar-filled">$1</span>')
    .replace(/([░]+)/g, '<span class="bar-empty">$1</span>')
    .replace(/(⚠[^<\n]*)/gi, '<span class="risk-text">$1</span>');

  return html;
}

// Show agent welcome/tools showcase
function showAgentWelcome() {
  const agentWelcome = document.getElementById('agent-welcome');
  if (agentWelcome) {
    agentResults.innerHTML = '';
    agentResults.appendChild(agentWelcome.cloneNode(true));

    // Re-attach event listeners for the cloned elements
    document.querySelectorAll('.sample-question').forEach(btn => {
      btn.addEventListener('click', () => {
        const query = btn.dataset.query;
        if (query) {
          agentInput.value = query;
          submitAgentQuery();
        }
      });
    });

    // Re-attach tools toggle
    const newToolsToggle = document.getElementById('tools-toggle');
    const newToolsExtra = document.getElementById('tools-extra');
    if (newToolsToggle && newToolsExtra) {
      newToolsToggle.addEventListener('click', () => {
        newToolsToggle.classList.toggle('expanded');
        newToolsExtra.classList.toggle('visible');
        const span = newToolsToggle.querySelector('span');
        if (newToolsExtra.classList.contains('visible')) {
          span.textContent = 'Skryť ďalšie nástroje';
        } else {
          span.textContent = 'Zobraziť ďalšie nástroje (6)';
        }
      });
    }
  }
}
</script>

<footer style="
  text-align: center;
  padding: 24px 16px;
  margin-top: 40px;
  color: var(--text-muted);
  font-size: 0.75rem;
">
  FTE Kalkulačka v5.1
</footer>
</body>
</html>
